<!-- Modal Surtir Orden de Compra -->
<div class="modal fade" id="surtirOrdenCompraModal" tabindex="-1" aria-labelledby="surtirOrdenCompraLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header text-white" style="background-color: #004e59;">
                <h5 class="modal-title" id="surtirOrdenCompraLabel">
                    <i class="bi bi-box-arrow-in-down"></i> Registrar Entrada de Orden de Compra <span
                        id="idOrdenCompraEntrada" class="text-primary fw-bold"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formSurtirOrdenCompra">
                    <input type="hidden" id="surtirIdOrdenCompra">
                    <div class="row">
                        <!-- Información General de la Orden -->
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-info-circle me-2"
                                            style="color:#004e59"></i>Información de la Orden</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="fw-bold"><i class="bi bi-person me-1"
                                                style="color:#004e59"></i>Proveedor:</span>
                                        <span id="proveedorOrdenCompraSurtir" class="ms-1"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-bold"><i class="bi bi-shop me-1"
                                                style="color:#004e59"></i>Almacén:</span>
                                        <span id="almacenOrdenCompraSurtir" class="ms-1"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-bold"><i class="bi bi-calendar-event me-1"
                                                style="color:#004e59"></i>Fecha de Orden:</span>
                                        <span id="fechaOrdenCompraSurtir" class="ms-1"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-bold"><i class="bi bi-flag me-1"
                                                style="color:#004e59"></i>Estado:</span>
                                        <span id="estadoOrdenCompraSurtir" class="ms-1"></span>
                                    </div>
                                    <div class="mb-2">
                                        <span class="fw-bold"><i class="bi bi-person-check me-1"
                                                style="color:#004e59"></i>Creada por:</span>
                                        <span id="creadaPorOrdenCompraSurtir" class="ms-1"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-2" id="alertaSurtirOrdenCompra">
                                <i class="bi bi-info-circle me-2"></i>Puede dar entrada a los artículos uno por uno. Al
                                ingresar todos, la orden se finaliza.
                            </div>
                        </div>
                        <!-- Artículos para Surtir -->
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="card-title mb-0"><i class="bi bi-list-ul me-2"
                                            style="color:#004e59"></i>Artículos de la Orden</h6>
                                    <span class="badge bg-secondary" id="contadorArticulosSurtirOrdenCompra">0
                                        artículos</span>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                        <table class="table table-sm align-middle" id="tablaSurtirArticulosOrdenCompra">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>Artículo</th>
                                                    <th class="text-center">Ordenado</th>
                                                    <th class="text-center">Recibido</th>
                                                    <th class="text-center">Por Surtir</th>
                                                    <th class="text-center">Precio</th>
                                                    <th class="text-center">Estado</th>
                                                    <th class="text-center">Acción</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Se llenará dinámicamente -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <!-- Resumen de Surtimiento -->
                                    <div class="mt-3">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fw-bold text-primary" id="totalArticulosOrdenCompra">0
                                                    </div>
                                                    <small class="text-muted">Total Artículos</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fw-bold text-success"
                                                        id="articulosCompletosOrdenCompra">0</div>
                                                    <small class="text-muted">Completos</small>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="border rounded p-2">
                                                    <div class="fw-bold text-warning"
                                                        id="articulosPendientesOrdenCompra">0</div>
                                                    <small class="text-muted">Pendientes</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0"
                style="background-color: #f8f9fa; border-top: 3px solid #004e59 !important;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnFinalizarSurtimientoOrdenCompra" disabled>
                    <i class="bi bi-check-circle"></i> Finalizar Surtimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Evidencia Surtimiento Artículo -->
<div class="modal fade" id="evidenciaSurtirArticuloModal" tabindex="-1" aria-labelledby="evidenciaSurtirArticuloLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header text-white" style="background-color: #004e59;">
                <h5 class="modal-title" id="evidenciaSurtirArticuloLabel">
                    <i class="bi bi-camera"></i> Evidencia de Surtimiento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formEvidenciaSurtirArticulo">
                    <input type="hidden" id="idArticuloSurtirEvidencia">
                    <div class="mb-3">
                        <label for="evidenciaSurtirArticulo" class="form-label">Adjuntar Evidencia (PDF, JPG, PNG) <span
                                class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="evidenciaSurtirArticulo"
                            name="evidencia_surtir_articulo[]" accept=".pdf,.jpg,.jpeg,.png" required>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> Adjunte el documento o imagen que respalde el surtimiento
                            de este artículo.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="observacionesEvidenciaSurtir" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observacionesEvidenciaSurtir" rows="2"
                            placeholder="Observaciones sobre el surtimiento..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0"
                style="background-color: #f8f9fa; border-top: 3px solid #004e59 !important;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="btnGuardarEvidenciaSurtirArticulo">
                    <i class="bi bi-check-circle"></i> Guardar Evidencia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Surtir Artículo Individual de Orden de Compra -->
<div class="modal fade" id="surtirOrdenCompraIndividualModal" tabindex="-1"
    aria-labelledby="surtirOrdenCompraIndividualLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header text-white" style="background-color: #004e59;">
                <div class="d-flex align-items-center">
                    <i class="bi bi-box-arrow-in-down me-2 fs-4"></i>
                    <h5 class="modal-title mb-0" id="surtirOrdenCompraIndividualLabel">
                        Ingresar Artículo de Orden de Compra - <strong><span
                                id="nombreArticuloSurtirOC"></span></strong>
                    </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body container-fluid">
                <form id="formSurtirOrdenCompraIndividual">
                    <div class="row">
                        <!-- Información del Artículo -->
                        <div class="col-md-6">
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-box-seam me-2"
                                            style="color: #004e59;"></i>Datos del Artículo</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <label class="form-label fw-bold">Artículo</label>
                                            <input type="text" class="form-control-plaintext fw-bold"
                                                id="nombreArticuloSurtirOCInput" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-bold">Clave</label>
                                            <input type="text" class="form-control-plaintext" id="claveArticuloSurtirOC"
                                                readonly>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-md-6">
                                            <label class="form-label">Cantidad Solicitada</label>
                                            <input type="text" class="form-control-plaintext text-primary fw-bold"
                                                id="cantidadOrdenadaSurtirOC" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Cantidad Recibida</label>
                                            <input type="text" class="form-control-plaintext text-success fw-bold"
                                                id="cantidadRecibidaSurtirOC" readonly>
                                        </div>
                                    </div>
                                    <!-- <div class="row mt-2">
                                        <!-- <div class="col-md-6">
                                            <label class="form-label">Por Surtir</label>
                                            <input type="text" class="form-control-plaintext text-warning fw-bold"
                                                id="cantidadPorSurtirOC" readonly>
                                        </div> -->
                                         <!--<div class="col-md-6">
                                            <label class="form-label">Precio Unitario</label>
                                            <input type="text" class="form-control-plaintext"
                                                id="precioUnitarioSurtirOC" readonly>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                            <!-- Card: Cantidad a Ingresar -->
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-calculator me-2"
                                            style="color: #007b8a;"></i>Ingreso</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="cantidadIngresarSurtirOC" class="form-label fw-bold">Cantidad a
                                            Ingresar <span class="text-danger">*</span></label>
                                        <input type="number" step="0.01" min="0.01" class="form-control form-control-lg"
                                            id="cantidadIngresarSurtirOC" name="cantidad" required placeholder="Ej: 10">
                                    </div>
                                    <div class="mb-3">
                                        <label for="precioCompraSurtirOC" class="form-label fw-bold">Precio de Compra
                                            Unitario
                                            <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" min="0"
                                                class="form-control form-control-lg" id="precioCompraSurtirOC"
                                                name="costo_unitario" required placeholder="0.00">
                                        </div>
                                    </div>
                                    <div class="alert alert-info d-none" id="costoTotalSurtirOCAlert">
                                        <strong><i class="bi bi-calculator me-2"></i>Costo Total: $<span
                                                id="costo_total_surtir_oc"></span></strong>
                                    </div>
                                </div>
                            </div>
                            <!-- Evidencia Fotográfica -->
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-camera me-2"
                                            style="color: #004e59;"></i>Evidencia Fotográfica de Ingreso</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="evidenciaFotoSurtirOC" class="form-label fw-bold">Subir Foto de
                                            Evidencia <span class="text-danger">*</span></label>
                                        <input type="file" class="form-control" id="evidenciaFotoSurtirOC"
                                            name="evidencia_foto[]" accept="image/*">
                                        <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Solo imágenes.
                                            Máx. 5MB</small>
                                    </div>
                                    <div id="previewEvidenciaFotoSurtirOC"
                                        class="d-flex justify-content-center align-items-center"
                                        style="min-height:220px;">
                                        <!-- Previsualización de la imagen -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Documentación y Observaciones -->
                        <div class="col-md-6">
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-file-earmark-text me-2"
                                            style="color: #006b7a;"></i>Documentación</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="documentoFacturaSurtirOC" class="form-label fw-bold">Documento de
                                            Compra <span class="text-danger">*</span></label>
                                        <input type="file" class="form-control" id="documentoFacturaSurtirOC"
                                            name="img_factura[]" accept=".pdf,.jpg,.jpeg,.png">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle me-1"></i> Formatos permitidos: PDF, JPG, PNG
                                            (Máx. 5MB)
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3 border-0 shadow-sm" id="lotesCaducidadCardSurtirOC">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-calendar-check me-2"
                                            style="color: #005866;"></i>Control de Lote y Caducidad</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="numeroLoteSurtirOC" class="form-label">Número de Lote</label>
                                            <input type="text" class="form-control" id="numeroLoteSurtirOC"
                                                name="numero_lote" placeholder="Ej: LOTE2024001">
                                            <small class="text-muted">Opcional - Solo si aplica</small>
                                        </div>
                                        <div class="col-md-6 mb-3" id="fechaCaducidadDivSurtirOC">
                                            <label for="fechaCaducidadSurtirOC" class="form-label">Fecha de
                                                Caducidad</label>
                                            <input type="date" class="form-control" id="fechaCaducidadSurtirOC"
                                                name="fecha_caducidad">
                                            <small class="text-muted">Solo si el artículo maneja caducidad</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3 border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-chat-square-text me-2"
                                            style="color: #004e59;"></i>Observaciones</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="observacionesSurtirOC" class="form-label">Observaciones</label>
                                        <textarea class="form-control" id="observacionesSurtirOC" name="observaciones"
                                            rows="3" placeholder="Información adicional sobre la entrada..."></textarea>
                                        <small class="text-muted">Opcional - Detalles adicionales del movimiento</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="idArticuloSurtirOC" name="id_articulo">
                    <input type="hidden" id="idOrdenCompraSurtirOC" name="id_orden_compra">
                    <input type="hidden" id="fecha_entrada_orden" name="fecha_entrada_orden">
                </form>
            </div>
            <div class="modal-footer border-0"
                style="background-color: #f8f9fa; border-top: 3px solid #004e59 !important;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button id="btnRegistrarSurtirOC" type="submit" class="btn"
                    style="background-color: #004e59; color: white; border-color: #004e59;"
                    form="formSurtirOrdenCompraIndividual">
                    <i class="bi bi-pencil-square"></i> Ingresar Artículo
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Calcular costo total en tiempo real
        function calcularCostoTotalSurtirOC() {
            const cantidad = parseFloat($("#cantidadIngresarSurtirOC").val()) || 0;
            const precio = parseFloat($("#precioCompraSurtirOC").val()) || 0;
            if (cantidad > 0 && precio > 0) {
                const total = cantidad * precio;
                $("#costo_total_surtir_oc").text(total.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));
                $("#costoTotalSurtirOCAlert").removeClass("d-none");
            } else {
                $("#costoTotalSurtirOCAlert").addClass("d-none");
            }
        }
        $("#cantidadIngresarSurtirOC, #precioCompraSurtirOC").on("input keyup change", function () {
            calcularCostoTotalSurtirOC();
        });

        // Previsualización de la evidencia fotográfica
        $("#evidenciaFotoSurtirOC").on("change", function (e) {
            const input = this;
            const preview = $("#previewEvidenciaFotoSurtirOC");
            preview.empty();
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        preview.html(`<img src="${ev.target.result}" class="img-fluid rounded shadow" style="max-height:200px;max-width:100%;object-fit:contain;">`);
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.html('<div class="text-danger">El archivo seleccionado no es una imagen.</div>');
                }
            }
        });

        // Limpiar formulario y previsualización al cerrar modal
        $("#surtirOrdenCompraIndividualModal").on("hidden.bs.modal", function () {
            $("#formSurtirOrdenCompraIndividual")[0].reset();
            $("#costoTotalSurtirOCAlert").addClass("d-none");
            $("#previewEvidenciaFotoSurtirOC").empty();
        });


        $("#formSurtirOrdenCompraIndividual").submit(function (event) {
            const now = new Date();
            $("#fecha_entrada_orden").val(
                now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, '0') + "-" +
                String(now.getDate()).padStart(2, '0') + " " +
                String(now.getHours()).padStart(2, '0') + ":" +
                String(now.getMinutes()).padStart(2, '0') + ":" +
                String(now.getSeconds()).padStart(2, '0')
            );
        });
    });
</script>

<style>
    #tablaSurtirArticulosOrdenCompra {
        font-size: 0.95em;
    }

    .input-cantidad-surtir {
        width: 70px;
        text-align: center;
    }

    .badge-completo {
        background-color: #28a745 !important;
    }

    .badge-pendiente {
        background-color: #ffc107 !important;
        color: #000;
    }

    .badge-sin-evidencia {
        background-color: #6c757d !important;
    }

    .preview-imagen {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
    }

    .preview-imagen:hover {
        opacity: 0.8;
    }

    .btn-eliminar-imagen {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: none;
        background: #dc3545;
        color: white;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .imagen-container {
        position: relative;
        display: inline-block;
    }

    #previewEvidenciaFotoSurtirOC img {
        border: 2px solid #004e59;
        background: #f8f9fa;
        padding: 4px;
        margin-top: 8px;
        max-height: 200px;
        max-width: 100%;
        object-fit: contain;
    }
</style>