<!-- CSS para tags de proveedores -->
<link href="../../../css/proveedores-tags.css" rel="stylesheet">

<div class="modal fade" id="registrarArticuloModal" tabindex="-1" data-bs-backdrop="static" data-bs-focus="false"
    data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">

        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="liberarDiaTitle">Registrar <strong>Nuevo artículo</strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body container-fluid">
                <div class="container-fluid">
                    <div class="row">
                        <form id="registrarArticuloForm" name="registrarArticuloForm">
                            <!-- Formulario para crear una nueva caja -->
                            <div class="col-12">
                                <div class="text-start">
                                    <div class="shadow-sm rounded p-3 card-body">
                                        <h5 class="text-dark">Ingresa los siguientes datos</h5>

                                        <!-- Sección 1: Información General -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Información General</h6>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <!-- <div class="mb-3">
                                                        <label for="no_art" class="form-label">No.</label>
                                                        <input type="text" class="form-control input-form" id="no_art" name="no_art" required>
                                                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                                                        <small class="form-text text-muted">Ingrese el número del artículo.</small>
                                                    </div> -->
                                                        <div class="mb-3">
                                                            <label for="clave_art" class="form-label">Código</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="clave_art" name="clave_art" required>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Ingrese el código único
                                                                del artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="nombre_comercial" class="form-label">Nombre
                                                                Comercial</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="nombre_comercial" name="nombre_comercial" required>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Ingrese el nombre
                                                                comercial del artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="id_marcas" class="form-label">Marca</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="id_marcas"
                                                                    name="id_marcas" required>
                                                                    <option value="">Seleccione una marca</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoMarcas" title="Gestionar Marcas">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione la marca del
                                                                artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="id_sustancia" class="form-label">Sustancia
                                                                Activa</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="id_sustancia"
                                                                    name="id_sustancia">
                                                                    <option value="">Seleccione una sustancia activa
                                                                    </option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoSustancias"
                                                                    title="Gestionar Sustancias Activas">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <small class="form-text text-muted">Para medicamentos:
                                                                seleccione la sustancia activa. Para genéricos, agregue
                                                                solo el gramaje en "Nombre Comercial" (ej: 500mg). Para
                                                                patentes, use el nombre comercial completo.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sección 2: Configuración del Artículo -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Configuración del Artículo</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="estatus" class="form-label">Estatus</label>
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox"
                                                                    name="estatus" id="estatus" checked>
                                                            </div>
                                                            <small class="form-text text-muted">Indica si el artículo
                                                                está activo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="red_frio" class="form-label">Red Frío</label>
                                                            <select class="form-select input-form" id="red_frio"
                                                                name="red_frio">
                                                                <option value="1">Sí</option>
                                                                <option value="0">No</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo requiere red frío.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="tipo_articulo" class="form-label">Tipo
                                                                Descripción</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form"
                                                                    id="tipo_articulo" name="tipo_articulo" required>
                                                                    <option value="">Seleccione un tipo</option>
                                                                    <option value="1">Reactivo</option>
                                                                    <option value="2">Insumo</option>
                                                                    <option value="3">Medicamento</option>
                                                                    <option value="60">Otros</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoTipos"
                                                                    title="Gestionar Tipos de Artículos">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione el tipo de
                                                                descripción del artículo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="area_id" class="form-label">Área</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="area_id"
                                                                    name="area_id" required>
                                                                    <option value="">Seleccione un área</option>
                                                                    <option value="1">Checkup</option>
                                                                    <option value="2">Laboratorio clínico</option>
                                                                    <option value="3">Laboratorio biomolecular</option>
                                                                    <option value="4">Administración</option>
                                                                    <option value="5">Recepción</option>
                                                                    <option value="6">Toma de muestras</option>
                                                                </select>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione a qué área
                                                                pertenece el artículo.</small>
                                                        </div>
                                                    </div>
                                                    <!-- <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_caducidad" class="form-label">Maneja
                                                                Caducidad</label>
                                                            <select class="form-select input-form" id="maneja_caducidad"
                                                                name="maneja_caducidad">
                                                                <option value="1">Sí</option>
                                                                <option value="0">No</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja caducidad.</small>
                                                        </div>
                                                    </div> -->

                                                    <!-- Nota: Los campos de fecha de caducidad, número de lote y fecha de lote 
                                                         ahora se manejan en el modal de entrada para mejor control de inventario -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sección 3: Detalles del Artículo -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Detalles del Artículo</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="unidad_venta" class="form-label">Unidad de
                                                                Venta</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="unidad_venta"
                                                                    name="unidad_venta" required>
                                                                    <option value="">Seleccione una unidad</option>
                                                                    <option value="Por pieza (unidad)">Por pieza
                                                                        (unidad)</option>
                                                                    <option value="Por caja">Por caja</option>
                                                                    <option value="Por blíster (tira)">Por blíster
                                                                        (tira)</option>
                                                                    <option value="Por frasco / botella">Por frasco /
                                                                        botella</option>
                                                                    <option value="Por ampolla o vial">Por ampolla o
                                                                        vial</option>
                                                                    <option value="Por gramo / mililitro">Por gramo /
                                                                        mililitro</option>
                                                                    <option value="Por kit o presentación combinada">Por
                                                                        kit o presentación combinada</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoUnidades"
                                                                    title="Gestionar Unidades de Venta">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione la unidad de
                                                                venta del artículo.</small>
                                                        </div>
                                                    </div>

                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="unidad_minima" class="form-label">Stock
                                                                Mínimo</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="unidad_minima" name="unidad_minima">
                                                            <div class="invalid-feedback">Este campo es opcional.</div>
                                                            <small class="form-text text-muted">Cantidad mínima que debe
                                                                mantenerse en inventario antes de reabastecer.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="mb-3">
                                                            <label for="contenido" class="form-label">Especificaciones
                                                                del Producto</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="contenido" name="contenido">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Detalles específicos del
                                                                contenido (ej: "100ml por frasco", "50 tiras por caja",
                                                                etc.).</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="mb-3">
                                                            <label for="id_proveedores"
                                                                class="form-label">Proveedores</label>

                                                            <!-- Área de Tags de Proveedores Seleccionados -->
                                                            <div id="proveedoresSelectedContainer" class="mb-2"
                                                                style="min-height: 40px; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 8px; background-color: #f8f9fa;">
                                                                <div id="proveedoresTagsArea"
                                                                    class="d-flex flex-wrap gap-2">
                                                                    <small class="text-muted align-self-center"
                                                                        id="proveedoresPlaceholder">
                                                                        No hay proveedores seleccionados. Seleccione uno
                                                                        o más proveedores del menú desplegable.
                                                                    </small>
                                                                </div>
                                                            </div>

                                                            <div class="input-group">
                                                                <select class="form-select input-form"
                                                                    id="id_proveedores" name="id_proveedores">
                                                                    <option value="">Seleccione un proveedor</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnNuevoProveedor"
                                                                    title="Gestionar Proveedores">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>

                                                            <!-- Campo hidden para enviar JSON de proveedores -->
                                                            <input type="hidden" id="proveedores_json"
                                                                name="proveedores_json" value="">

                                                            <small class="form-text text-muted">Seleccione uno o más
                                                                proveedores. El primer proveedor será considerado como
                                                                principal.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_rendimiento" class="form-label">Maneja
                                                                Rendimiento</label>
                                                            <select class="form-select input-form"
                                                                id="maneja_rendimiento" name="maneja_rendimiento">
                                                                <option value="1">No</option>
                                                                <option value="0">Sí</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja rendimiento.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_inserto" class="form-label">Maneja
                                                                Inserto y Protocolo</label>
                                                            <select class="form-select input-form" id="maneja_inserto"
                                                                name="maneja_inserto">
                                                                <option value="1">No</option>
                                                                <option value="0">Sí</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja inserto y protocolo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="rendimientoEstimadoDiv"
                                                        style="display:none;">
                                                        <div class="mb-3">
                                                            <label for="rendimiento_estimado"
                                                                class="form-label">Rendimiento
                                                                Estimado
                                                                (pruebas)</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="rendimiento_estimado" name="rendimiento_estimado">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Pruebas efectivas
                                                                según
                                                                proveedor</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="rendimientoPacienteDiv"
                                                        style="display:none;">
                                                        <div class="mb-3">
                                                            <label for="rendimiento_paciente"
                                                                class="form-label">Rendimiento
                                                                Paciente
                                                                (pruebas)</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="rendimiento_paciente" name="rendimiento_paciente">
                                                            <small class="form-text text-muted">Pruebas efectivas
                                                                reales</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sección 4: Documentos -->
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h6 class="card-title">Documentos</h6>
                                        <div class="row">
                                            <div class="col-12" id="insertoDiv" style="display: none;">
                                                <div class="mb-3">
                                                    <label for="inserto" class="form-label">Inserto</label>
                                                    <input type="file" class="form-control input-form" id="inserto"
                                                        name="inserto">
                                                    <div class="invalid-feedback">Este campo es obligatorio.
                                                    </div>
                                                    <small class="form-text text-muted">Adjunte el inserto del
                                                        artículo.</small>
                                                </div>
                                            </div>
                                            <div class="col-12" id="protocoloDiv" style="display: none;">
                                                <div class="mb-3">
                                                    <label for="procedimiento" class="form-label">Procedimiento
                                                        Prueba</label>
                                                    <input type="file" class="form-control input-form"
                                                        id="procedimiento" name="procedimiento">
                                                    <div class="invalid-feedback">Este campo es obligatorio.
                                                    </div>
                                                    <small class="form-text text-muted">Adjunte el procedimiento
                                                        de prueba del artículo.</small>
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="mb-3">
                                                    <label for="protocolo" class="form-label">Imagen</label>
                                                    <input type="file" class="form-control input-form" id="img_producto"
                                                        name="img_producto[]">
                                                    <div class="invalid-feedback">Este campo es obligatorio.
                                                    </div>
                                                    <small class="form-text text-muted">Adjunte la imagen del
                                                        artículo.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                
                                <!-- Sección 5: Vista Previa del Inserto -->
                                <div class="card mb-4" id="vistaPreviaInsertoCard" style="display: none;">
                                    <div class="card-body">
                                        <h6 class="card-title">Vista Previa del Inserto</h6>
                                        <div class="row">
                                            <!-- Botones de control -->
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <div class="d-flex gap-3 mt-2 flex-wrap">
                                                        <button
                                                            class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                                            type="button" id="verPreviaInserto" style="width:97px;"
                                                            disabled>
                                                            <i class="bi bi-eye fs-5"></i>
                                                            <span class="mt-1">Ver Previa</span>
                                                        </button>
                                                        <button
                                                            class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                                            type="button" id="descargarInserto" style="width:97px;">
                                                            <i class="bi bi-download fs-5"></i>
                                                            <span class="mt-1">Descargar</span>
                                                        </button>
                                                        <button
                                                            class="btn btn-outline-success btn-sm d-flex flex-column align-items-center d-none"
                                                            type="button" id="abrirNuevaVentana" style="width:97px;">
                                                            <i class="bi bi-box-arrow-up-right fs-5"></i>
                                                            <span class="mt-1">Vista completa</span>
                                                        </button>
                                                    </div>
                                                    <small class="form-text text-muted">Previsualice el PDF antes de
                                                        guardar el artículo. <br>Nota: complete código y nombre
                                                        comercial para visualizar.</small>
                                                </div>
                                            </div>
                                            <!-- Vista previa del PDF -->
                                            <div class="col-6">
                                                <div class="h-100 d-flex flex-column">
                                                    <div id="pdfPreviewContainer"
                                                        class="border p-3 rounded flex-grow-1 d-flex align-items-center justify-content-center flex-column"
                                                        style="min-height: 200px;">
                                                        <small class="text-muted text-center">La vista previa del PDF
                                                            aparecerá aquí</small>
                                                        <!-- Este iframe contendrá el PDF -->
                                                        <iframe id="pdfPreviewFrame"
                                                            style="width: 100%; height: 100%; display: none;"
                                                            frameborder="0">
                                                        </iframe>
                                                        <!-- Información del archivo -->
                                                        <div id="pdfInfoDisplay" class="fw-bold text-center mt-2"
                                                            style="font-size: 0.9rem;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Sección 6: Código de Barras -->
                                <div class="card mb-4">
                                    <div class="card-body">
                                        <h6 class="card-title">Código de Barras</h6>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="mb-3">
                                                    <label for="codigo_barras" class="form-label">Código de
                                                        Barras</label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control input-form"
                                                            id="codigo_barras" name="codigo_barras"
                                                            placeholder="Ingrese el código de barras manualmente"
                                                            style="height: 38px;">
                                                        <button
                                                            class="btn btn-outline-secondary d-flex align-items-center"
                                                            type="button" id="limpiarCodigoBarras"
                                                            title="Limpiar código"
                                                            style="height: 38px; padding-top: 0; padding-bottom: 0;">
                                                            <i class="bi bi-x-lg"></i>
                                                        </button>
                                                    </div>
                                                    <small class="form-text text-muted">Ingrese el código de barras del
                                                        artículo.</small>
                                                </div>
                                            </div>
                                            <div class="col-6 d-flex justify-content-center align-items-center">
                                                <div class="mb-3 text-center w-100">
                                                    <button
                                                        class="btn btn-outline-secondary btn-lg d-flex flex-column align-items-center justify-content-center mx-auto"
                                                        type="button" id="leerCodigoBarras"
                                                        style="width: 106px; height: 77px;">
                                                        <i class="bi bi-upc-scan fs-2"></i>
                                                        <span>Escanear</span>
                                                    </button>
                                                    <small class="form-text text-muted d-block mt-2">Puede escanear el
                                                        código de barras.</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botones de Acción -->
                                <!-- <div class="d-flex justify-content-end mt-3">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-sec ms-2">Guardar</button>
                                    </div> -->

                            </div>
                    </div>
                </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left-short"></i>
                    Cancelar
                </button>

                <button type="submit" class="btn btn-confirmar" form="registrarArticuloForm">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>
</div>
</div>



<script>
    // Validación en Tiempo Real
    $('#registrarArticuloForm input').on('input', function () {
        if ($(this).val() === '') {
            $(this).addClass('');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    // Actualización del Progreso
    $('#registrarArticuloForm input, #registrarArticuloForm select').on('input change', function () {
        let completedSections = 0;
        if ($('#no_art').val() !== '' && $('#clave_art').val() !== '' && $('#nombre_comercial').val() !== '') {
            completedSections++;
        }
        if ($('#estatus').is(':checked') || $('#red_frio').val() !== '') {
            completedSections++;
        }
        if ($('#inserto').val() !== '' || $('#procedimiento').val() !== '' || $('#img_producto').val() !== '') {
            completedSections++;
        }
        $('#formProgress').text(completedSections + ' de 3 secciones completadas');
    });

    // Manejo del estado del checkbox de estatus
    let estatusVariable = 1; // Ejemplo de valor recibido
    if (estatusVariable === 1) {
        $('#estatus').prop('checked', true);
    } else {
        $('#estatus').prop('checked', false);
    }

    // Nota: La gestión de caducidad y lotes ahora se maneja en el modal de entrada

    // Mostrar u ocultar los campos de rendimiento según el valor seleccionado
    $('#maneja_rendimiento').on('change', function () {
        if ($(this).val() == '0') {
            $('#rendimientoEstimadoDiv').show();
            $('#rendimientoPacienteDiv').show();
            $("#rendimiento_estimado").attr("required", true);
            $("#rendimiento_paciente").attr("required", true);
        } else {
            $('#rendimientoEstimadoDiv').hide();
            $('#rendimientoPacienteDiv').hide();
            $("#rendimiento_estimado").val("");
            $("#rendimiento_paciente").val("");
            $("#rendimiento_estimado").removeAttr("required");
            $("#rendimiento_paciente").removeAttr("required");
            $("#rendimiento_estimado").removeClass("is-invalid");
            $("#rendimiento_paciente").removeClass("is-invalid");
        }
    });

    // Mostrar u ocultar los campos de inserto y procedimiento prueba según el valor seleccionado
    $('#maneja_inserto').on('change', function () {
        if ($(this).val() == '0') {
            $("#insertoDiv").show();
            $("#protocoloDiv").show();
            $('#vistaPreviaInsertoCard').show();
            //$("#inserto").attr("required", true);
            // $("#procedimiento").attr("required", true);
        } else {
            $('#insertoDiv').hide();
            $('#protocoloDiv').hide();
            $("#insertoDiv").hide();
            $("#protocoloDiv").hide();
            $("#inserto").val("");
            $("#vistaPreviaInsertoCard").hide();
            // $("#inserto").removeAttr("required");
            // $("#procedimiento").removeAttr("required");
            // $("#inserto").removeClass("is-invalid");
            // $("#procedimiento").removeClass("is-invalid");
        }
    });

    /*$("#tipo_articulo").on("change", function () {
      if ($(this).val() == "1") {
        $("#rendimientoEstimadoDiv").show();
        $("#rendimientoPacienteDiv").show();
        $("#insertoDiv").show();
        $("#protocoloDiv").show();
        $("#rendimientoEstimadoDiv").attr("required", true);
        $("#rendimientoPacienteDiv").attr("required", true);
        $("#insertoDiv").attr("required", true);
        $("#protocoloDiv").attr("required", true);
      } else {
        $("#rendimientoEstimadoDiv").hide();
        $("#rendimientoPacienteDiv").hide();
        $("#insertoDiv").hide();
        $("#protocoloDiv").hide();
        $("#rendimientoEstimadoDiv").val("");
        $("#rendimientoPacienteDiv").val("");
        $("#insertoDiv").val("");
        $("#rendimientoEstimadoDiv").removeAttr("required");
        $("#rendimientoPacienteDiv").removeAttr("required");
        $("#insertoDiv").removeAttr("required");
        $("#protocoloDiv").removeAttr("required");
        $("#rendimientoEstimadoDiv").removeClass("is-invalid");
        $("#insertoDiv").removeClass("is-invalid");
        $("#protocoloDiv").removeClass("is-invalid");
      }
    });*/
    // Ejecutar al cargar para el valor inicial
    $(document).ready(function () {
        // Nota: Los triggers de caducidad y lotes se removieron porque ahora se manejan en el modal de entrada
    });

    // // Generar código de barras automático
    // $('#generarCodigoBarras').click(function () {
    //     // Generar un código EAN-13 válido (13 dígitos)
    //     let prefix = '750'; // Prefijo para México
    //     let random = Math.floor(1000000000 + Math.random() * 9000000000).toString().substring(0, 9);
    //     let code = prefix + random;

    //     // Calcular dígito de control para EAN-13
    //     let sum = 0;
    //     for (let i = 0; i < 12; i++) {
    //         sum += parseInt(code.charAt(i)) * (i % 2 === 0 ? 1 : 3);
    //     }
    //     let checksum = (10 - (sum % 10)) % 10;
    //     let fullCode = code + checksum;

    //     $('#codigo_barras').val(fullCode);
    //     alertToast("Código de barras generado correctamente", "success", 2000);
    // });

    // Función para validar código de barras
    function validarCodigoBarras(codigo) {
        if (!codigo || codigo.length < 8) {
            return { valido: false, mensaje: 'Código muy corto' };
        }

        // Validar EAN-13 (13 dígitos)
        if (codigo.length === 13 && /^\d+$/.test(codigo)) {
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 1 : 3);
            }
            let checksum = (10 - (sum % 10)) % 10;
            if (checksum === parseInt(codigo.charAt(12))) {
                return { valido: true, tipo: 'EAN-13' };
            }
        }

        // Validar EAN-8 (8 dígitos)
        if (codigo.length === 8 && /^\d+$/.test(codigo)) {
            let sum = 0;
            for (let i = 0; i < 7; i++) {
                sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 3 : 1);
            }
            let checksum = (10 - (sum % 10)) % 10;
            if (checksum === parseInt(codigo.charAt(7))) {
                return { valido: true, tipo: 'EAN-8' };
            }
        }

        // Validar UPC-A (12 dígitos)
        if (codigo.length === 12 && /^\d+$/.test(codigo)) {
            let sum = 0;
            for (let i = 0; i < 11; i++) {
                sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 3 : 1);
            }
            let checksum = (10 - (sum % 10)) % 10;
            if (checksum === parseInt(codigo.charAt(11))) {
                return { valido: true, tipo: 'UPC-A' };
            }
        }

        return { valido: false, mensaje: 'Formato de código de barras no válido' };
    }

    // Función para mostrar error en código de barras
    function mostrarErrorCodigoBarras(mensaje) {
        $('#codigo_barras').addClass('is-invalid');
        // Remover feedback anterior
        $('#codigo_barras').siblings('.formato-feedback').remove();
        // Agregar nuevo feedback
        $('<div class="formato-feedback text-danger small mt-1"></div>')
            .text(mensaje)
            .insertAfter('#codigo_barras');
    }

    // Función para limpiar errores del código de barras
    function limpiarErrorCodigoBarras() {
        $('#codigo_barras').removeClass('is-invalid');
        $('#codigo_barras').siblings('.formato-feedback').remove();
    }

    // Función para limpiar el código de barras
    function limpiarCodigoBarras() {
        $('#registrarArticuloForm #codigo_barras').val('');
        limpiarErrorCodigoBarras();
        $('#registrarArticuloForm #codigo_barras').siblings('.formato-feedback').remove();
        $('#codigoBarrasContainer').hide(); // Ocultar el canvas si existe
    }

    // Event listener para limpiar código de barras
    $(document).on('click', '#limpiarCodigoBarras', function (e) {
        e.preventDefault();
        limpiarCodigoBarras();
    });

    // Event listener para validar al perder el foco
    $('#registrarArticuloForm #codigo_barras').on('blur', function () {
        const codigo = $(this).val().trim();

        if (codigo !== '') {
            const validacion = validarCodigoBarras(codigo);

            if (!validacion.valido) {
                mostrarErrorCodigoBarras('Debe completar un código de barras válido.');
            } else {
                limpiarErrorCodigoBarras();
                // Mostrar tipo de código válido
                $('<div class="formato-feedback text-success small mt-1"></div>')
                    .text(`✓ Código ${validacion.tipo} válido`)
                    .insertAfter('#codigo_barras');
            }
        } else {
            limpiarErrorCodigoBarras();
        }
    });

    // Event listener para validar mientras escribe
    $('#registrarArticuloForm #codigo_barras').on('input', function () {
        const codigo = $(this).val().trim();

        if (codigo === '') {
            limpiarErrorCodigoBarras();
            return;
        }

        // Validación en tiempo real
        const validacion = validarCodigoBarras(codigo);

        if (validacion.valido) {
            limpiarErrorCodigoBarras();
            $(this).removeClass('is-invalid').addClass('is-valid');
        } else if (codigo.length >= 8) {
            // Solo mostrar error si ya tiene suficientes caracteres
            $(this).removeClass('is-valid').addClass('is-invalid');
        } else {
            // Limpiar estados mientras escribe
            $(this).removeClass('is-valid is-invalid');
            limpiarErrorCodigoBarras();
        }
    });

    // NUEVO CÓDIGO PARA VISTA PREVIA DEL PDF
    // Variables para vista previa del PDF
    let archivoPDFInserto = null;
    let urlPDFInserto = null;

    // Event listener para el campo de inserto - Vista previa
    $('#inserto').on('change', function (e) {
        const archivo = e.target.files[0];

        // Limpiar URL anterior si existe
        if (urlPDFInserto) {
            URL.revokeObjectURL(urlPDFInserto);
            urlPDFInserto = null;
        }

        // Limpiar vista previa
        limpiarVistaPrevia();

        if (archivo) {
            // Validar que sea un PDF
            if (archivo.type !== 'application/pdf') {
                alertToast("Solo se permiten archivos PDF", "error", 3000);
                $(this).val('');
                archivoPDFInserto = null;
                urlPDFInserto = null;
                deshabilitarBotonesPrevia();
                return;
            }

            // Validar tamaño del archivo (máximo 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB en bytes
            if (archivo.size > maxSize) {
                alertToast("El archivo PDF es demasiado grande (máximo 50MB)", "error", 3000);
                $(this).val('');
                archivoPDFInserto = null;
                urlPDFInserto = null;
                deshabilitarBotonesPrevia();
                return;
            }

            // Almacenar archivo y crear URL temporal
            archivoPDFInserto = archivo;
            urlPDFInserto = URL.createObjectURL(archivo);

            // Verificar campos requeridos para habilitar vista previa
            verificarCamposParaPrevia();

            alertToast(`PDF cargado: ${archivo.name} (${(archivo.size / 1024 / 1024).toFixed(2)}MB)`, "success", 3000);

            console.log("PDF del inserto cargado:", {
                nombre: archivo.name,
                tamaño: archivo.size,
                tipo: archivo.type,
                urlTemporal: urlPDFInserto
            });
        } else {
            // Si no hay archivo, deshabilitar botones
            archivoPDFInserto = null;
            urlPDFInserto = null;
            deshabilitarBotonesPrevia();
        }
    });

    // Función: Verificar campos requeridos para habilitar vista previa
    function verificarCamposParaPrevia() {
        const clave = $('#clave_art').val();
        const nombre_comercial = $('#nombre_comercial').val();

        if (archivoPDFInserto && clave && nombre_comercial) {
            habilitarBotonesPrevia();
        } else {
            deshabilitarBotonesPrevia();
        }
    }

    // Función: Habilitar botones de vista previa
    function habilitarBotonesPrevia() {
        $('#verPreviaInserto')
            .prop('disabled', false)
            .removeClass('btn-outline-secondary')
            .addClass('btn-outline-primary');
    }

    // Función: Deshabilitar botones de vista previa
    function deshabilitarBotonesPrevia() {
        $('#verPreviaInserto')
            .prop('disabled', true)
            .removeClass('btn-outline-primary')
            .addClass('btn-outline-secondary');

        $('#descargarInserto').addClass('d-none');
        $('#abrirNuevaVentana').addClass('d-none');
    }

    // Función: Limpiar vista previa
    function limpiarVistaPrevia() {
        $('#pdfPreviewFrame').hide();
        $('#pdfInfoDisplay').empty();
        $('#pdfPreviewContainer small').show();
        $('#descargarInserto').addClass('d-none');
        $('#abrirNuevaVentana').addClass('d-none');
    }

    // Event: Verificar campos al cambiar clave o nombre
    $('#clave_art, #nombre_comercial').on('input', function () {
        verificarCamposParaPrevia();
    });

    // Event: Botón para ver vista previa del PDF
    $('#verPreviaInserto').click(function () {
        if (!archivoPDFInserto) {
            alertToast("Primero debe cargar un archivo PDF", "warning", 3000);
            return;
        }

        const clave = $('#clave_art').val();
        const nombre_comercial = $('#nombre_comercial').val();

        if (!clave || !nombre_comercial) {
            alertToast("La clave y nombre del artículo son requeridos", "warning", 3000);
            return;
        }

        try {
            // Mostrar el PDF en el iframe
            const iframe = document.getElementById('pdfPreviewFrame');
            iframe.src = urlPDFInserto;

            // Mostrar el iframe y ocultar placeholder
            $('#pdfPreviewFrame').show();
            $('#pdfPreviewContainer small').hide();

            // Mostrar información del archivo
            $('#pdfInfoDisplay').html(`
                <strong>${clave}</strong><br>
                ${nombre_comercial}<br>
                <small class="text-danger">📄 ${archivoPDFInserto.name}</small><br>
                <small class="text-success">${(archivoPDFInserto.size / 1024 / 1024).toFixed(2)} MB</small>
            `);

            // Mostrar botones adicionales
            $('#descargarInserto').removeClass('d-none');
            $('#abrirNuevaVentana').removeClass('d-none');

            alertToast("Vista previa del PDF cargada", "success", 2000);

        } catch (error) {
            console.error('Error al mostrar vista previa:', error);
            alertToast("Error al mostrar la vista previa del PDF", "error", 3000);
        }
    });

    // Event: Botón para descargar el PDF
    $('#descargarInserto').click(function () {
        if (!urlPDFInserto || !archivoPDFInserto) {
            alertToast("No hay archivo PDF para descargar", "warning", 3000);
            return;
        }

        try {
            const clave = $('#clave_art').val();
            const link = document.createElement('a');
            link.href = urlPDFInserto;
            link.download = `Inserto_${clave}_${archivoPDFInserto.name}`;
            link.click();

            alertToast("Descarga del PDF iniciada", "success", 2000);
        } catch (error) {
            console.error('Error al descargar:', error);
            alertToast("Error al descargar el PDF", "error", 3000);
        }
    });

    // Event: Botón para abrir en nueva ventana
    $('#abrirNuevaVentana').click(function () {
        if (!urlPDFInserto) {
            alertToast("No hay archivo PDF para abrir", "warning", 3000);
            return;
        }

        try {
            const clave = $('#clave_art').val();
            const nombre_comercial = $('#nombre_comercial').val();

            // Abrir en nueva ventana con título personalizado
            const nuevaVentana = window.open(urlPDFInserto, '_blank',
                'width=800,height=600,scrollbars=yes,resizable=yes');

            if (nuevaVentana) {
                // Intentar cambiar el título de la ventana (limitado por seguridad del navegador)
                setTimeout(() => {
                    try {
                        nuevaVentana.document.title = `Inserto - ${clave} - ${nombre_comercial}`;
                    } catch (e) {
                        // Ignorar error de seguridad
                    }
                }, 1000);

                alertToast("PDF abierto en nueva ventana", "success", 2000);
            } else {
                alertToast("No se pudo abrir la nueva ventana. Verifique que no esté bloqueada por el navegador.", "warning", 4000);
            }
        } catch (error) {
            console.error('Error al abrir nueva ventana:', error);
            alertToast("Error al abrir el PDF en nueva ventana", "error", 3000);
        }
    });



    // Modificar: Limpiar todo al cerrar modal
    $('#registrarArticuloModal').on('hidden.bs.modal', function () {
        // Limpiar vista previa
        limpiarVistaPrevia();

        // Limpiar variables de PDF y liberar memoria
        if (urlPDFInserto) {
            URL.revokeObjectURL(urlPDFInserto);
            console.log("URL temporal del PDF liberada");
        }
        archivoPDFInserto = null;
        urlPDFInserto = null;

        // Deshabilitar botones
        deshabilitarBotonesPrevia();

        // Limpiar validaciones de código de barras
        limpiarErrorCodigoBarras();
    });

    // Evento: Advertencia antes de cerrar la página
    window.addEventListener('beforeunload', function (e) {
        if (urlPDFInserto) {
            const mensaje = 'Tiene un PDF cargado. Los cambios no guardados se perderán.';
            e.preventDefault();
            e.returnValue = mensaje;
            return mensaje;
        }
    });

    // Inicializar: Deshabilitar botones al cargar
    $(document).ready(function () {
        deshabilitarBotonesPrevia();
        $('#maneja_caducidad').trigger('change');
        $('#maneja_lotes').trigger('change');
    });

    // AGREGAR: Variable para controlar si se debe reabrir el modal de artículo
    let debeReabrirModalArticulo = false;

    // FUNCIÓN para el botón de catálogo de marcas
    $("#btnCatalogoMarcas").click(function (e) {
        e.preventDefault();
        e.stopPropagation();

        debeReabrirModalArticulo = true;
        console.log("Botón catálogo marcas clickeado, bandera activada:", debeReabrirModalArticulo);

        $("#registrarArticuloModal").modal("hide");

        setTimeout(function () {
            $("#registrarCatalogoModal").modal("show");

            setTimeout(function () {
                $("#marcas-tab").tab("show");
                console.log("Cambiando a pestaña de marcas");

                setTimeout(function () {
                    $("#registrarMarcaModal").modal("show");
                    console.log("Modal de registro de marca abierto");
                }, 400);
            }, 300);
        }, 200);
    });

    // FUNCIÓN para el botón de catálogo de sustancias
    $("#btnCatalogoSustancias").click(function (e) {
        e.preventDefault();
        e.stopPropagation();

        debeReabrirModalArticulo = true;
        console.log("Botón catálogo sustancias clickeado, bandera activada:", debeReabrirModalArticulo);

        $("#registrarSustanciaModal").modal("hide");

        setTimeout(function () {
            $("#registrarCatalogoModal").modal("show");

            setTimeout(function () {
                $("#sustancias-tab").tab("show");
                console.log("Cambiando a pestaña de sustancias");

                setTimeout(function () {
                    $("#registrarSustanciaModal").modal("show");
                    console.log("Modal de registro de sustancias abierto");
                }, 400);
            }, 300);
        }, 200);
    });

    // FUNCIÓN para el botón de catálogo de tipos
    $("#btnCatalogoTipos").click(function (e) {
        e.preventDefault();
        e.stopPropagation();

        debeReabrirModalArticulo = true;
        console.log("Botón catálogo tipos clickeado, bandera activada:", debeReabrirModalArticulo);

        $("#registrarArticuloModal").modal("hide");

        setTimeout(function () {
            $("#registrarCatalogoModal").modal("show");

            setTimeout(function () {
                $("#tipos-tab").tab("show");
                console.log("Cambiando a pestaña de tipos de artículos");

                setTimeout(function () {
                    $("#registrarTipoModal").modal("show");
                    console.log("Modal de registro de tipo abierto");
                }, 400);
            }, 300);
        }, 200);
    });

    // FUNCIÓN para el botón de catálogo de unidades
    $("#btnCatalogoUnidades").click(function (e) {
        e.preventDefault();
        e.stopPropagation();

        debeReabrirModalArticulo = true;
        console.log("Botón catálogo unidades clickeado, bandera activada:", debeReabrirModalArticulo);

        $("#registrarArticuloModal").modal("hide");

        setTimeout(function () {
            $("#registrarCatalogoModal").modal("show");

            setTimeout(function () {
                $("#unidades-tab").tab("show");
                console.log("Cambiando a pestaña de unidades de venta");

                setTimeout(function () {
                    $("#registrarUnidadModal").modal("show");
                    console.log("Modal de registro de unidad abierto");
                }, 400);
            }, 300);
        }, 200);
    });

    // Event listener para cuando se cierra el modal de catálogo (para artículos)
    $("#registrarCatalogoModal").on("hidden.bs.modal", function () {
        console.log("Modal de catálogo cerrado, bandera artículo:", debeReabrirModalArticulo);

        // Solo reabrir si se marcó la bandera para artículos
        if (debeReabrirModalArticulo) {
            console.log("Reabriendo modal de artículo...");

            setTimeout(function () {
                $("#registrarArticuloModal").modal("show");

                // Recargar las listas de catálogos para incluir los nuevos registros
                setTimeout(function () {
                    // Aquí debes agregar las funciones para recargar cada catálogo
                    // Por ejemplo:
                    cargarMarcas();
                    cargarTipos();
                    cargarUnidades();

                    console.log("Modal de artículo reabierto, catálogos recargados");
                }, 300);
            }, 200);

            // Resetear la bandera
            debeReabrirModalArticulo = false;
            console.log("Bandera de artículo reseteada");
        }
    });

    // Solo resetear si el usuario cancela manualmente (para artículos)
    $("#registrarArticuloModal .btn-cancelar, #registrarArticuloModal .btn-close").click(function () {
        debeReabrirModalArticulo = false;
        console.log("Usuario canceló artículo manualmente, bandera reseteada");
    });

    cargarProveedoresArticulo();

    // FUNCIÓN para el botón de nuevo proveedor
    $("#btnNuevoProveedor").click(function (e) {
        e.preventDefault();
        e.stopPropagation();
        debeReabrirModalArticulo = true;

        $("#registrarArticuloModal").modal("hide");
        setTimeout(function () {
            $("#registrarCatalogoModal").modal("show");
            setTimeout(function () {
                $("#proveedores-tab").tab("show");
                setTimeout(function () {
                    $("#registrarProveedorModal").modal("show");
                }, 400);
            }, 300);
        }, 200);
    });

    // Evento cuando se cierra el modal de catálogo
    $("#registrarCatalogoModal").on("hidden.bs.modal", function () {
        if (debeReabrirModalArticulo) {
            setTimeout(function () {
                $("#registrarArticuloModal").modal("show");
                setTimeout(function () {
                    // Recargar datos si es necesario
                    cargarProveedoresArticulo();
                }, 300);
            }, 200);
            debeReabrirModalArticulo = false;
        }
    });

    // Resetear bandera si el usuario cancela manualmente
    $(".btn-cancelar, .btn-close").click(function () {
        debeReabrirModalArticulo = false;
    });

    // FUNCIÓN PARA CARGAR PROVEEDORES
    function cargarProveedoresArticulo() {
        cargarCatalogoEnModal("#id_proveedores", {
            api: 16,
            campoId: "id_proveedores",
            campoTexto: "nombre",
            placeholder: "Seleccione un proveedor"
        });
    }

    // FUNCIÓN GENÉRICA PARA CARGAR CATÁLOGOS
    function cargarCatalogoEnModal(selectorSelect, opciones) {
        $.ajax({
            url: "../../../api/inventarios_api.php",
            type: "POST",
            dataType: "json",
            data: { api: opciones.api },
            success: function (response) {
                if (response.response?.code == 1) {
                    let selectElement = $(selectorSelect);
                    let valorActual = selectElement.val();

                    selectElement.empty().append(`<option value="">${opciones.placeholder}</option>`);

                    response.response.data.forEach(item => {
                        selectElement.append(`<option value="${item[opciones.campoId]}">${item[opciones.campoTexto]}</option>`);
                    });

                    if (valorActual) selectElement.val(valorActual);

                    // Si es el select de proveedores, actualizar opciones disponibles
                    if (selectorSelect === "#id_proveedores") {
                        actualizarOpcionesProveedores();
                    }
                } else {
                    console.error(`Error al cargar ${opciones.placeholder}:`, response);
                    alertToast(`Error al cargar ${opciones.placeholder}`, "error", 3000);
                }
            },
            error: function (xhr, status, error) {
                console.error("Error AJAX:", error);
                alertToast(`Error de conexión al cargar ${opciones.placeholder}`, "error", 3000);
            }
        });
    }

    // ===== SISTEMA DE TAGS PARA MÚLTIPLES PROVEEDORES =====

    // Array para almacenar proveedores seleccionados
    let proveedoresSeleccionados = [];

    // Función para agregar proveedor como tag
    function agregarProveedorTag(id, nombre) {
        // Verificar si ya está seleccionado
        if (proveedoresSeleccionados.find(p => p.id === id)) {
            alertToast("Este proveedor ya está seleccionado", "warning", 2000);
            return;
        }

        // Agregar a la lista
        const esPrimero = proveedoresSeleccionados.length === 0;
        proveedoresSeleccionados.push({
            id: id,
            nombre: nombre,
            principal: esPrimero
        });

        // Actualizar UI
        actualizarTagsProveedores();
        actualizarOpcionesProveedores();
        actualizarJSONProveedores();

        // Limpiar select
        $("#id_proveedores").val("");

        alertToast(`Proveedor "${nombre}" agregado${esPrimero ? ' como principal' : ''}`, "success", 2000);
    }

    // Función para quitar proveedor tag
    function quitarProveedorTag(id) {
        const index = proveedoresSeleccionados.findIndex(p => p.id === id);
        if (index === -1) return;

        const proveedor = proveedoresSeleccionados[index];
        const eraPrincipal = proveedor.principal;

        // Quitar de la lista
        proveedoresSeleccionados.splice(index, 1);

        // Si era principal y hay más proveedores, hacer principal al primero
        if (eraPrincipal && proveedoresSeleccionados.length > 0) {
            proveedoresSeleccionados[0].principal = true;
        }

        // Actualizar UI
        actualizarTagsProveedores();
        actualizarOpcionesProveedores();
        actualizarJSONProveedores();

        alertToast(`Proveedor "${proveedor.nombre}" eliminado`, "info", 2000);
    }

    // Función para hacer proveedor principal
    function hacerProveedorPrincipal(id) {
        // Quitar principal de todos
        proveedoresSeleccionados.forEach(p => p.principal = false);

        // Hacer principal al seleccionado
        const proveedor = proveedoresSeleccionados.find(p => p.id === id);
        if (proveedor) {
            proveedor.principal = true;

            // Mover al principio del array
            const index = proveedoresSeleccionados.indexOf(proveedor);
            proveedoresSeleccionados.splice(index, 1);
            proveedoresSeleccionados.unshift(proveedor);

            // Actualizar UI
            actualizarTagsProveedores();
            actualizarJSONProveedores();

            alertToast(`"${proveedor.nombre}" es ahora el proveedor principal`, "success", 2000);
        }
    }

    // Función para actualizar la vista de tags
    function actualizarTagsProveedores() {
        const container = $("#proveedoresTagsArea");
        const placeholder = $("#proveedoresPlaceholder");

        if (proveedoresSeleccionados.length === 0) {
            placeholder.show();
            container.empty().append(placeholder);
            return;
        }

        placeholder.hide();
        container.empty();

        proveedoresSeleccionados.forEach(proveedor => {
            const isPrincipal = proveedor.principal;
            const tagClass = isPrincipal ? 'proveedor-tag principal' : 'proveedor-tag';
            const iconClass = isPrincipal ? 'bi-star-fill' : 'bi-star';
            const titleText = isPrincipal ? 'Proveedor principal - Click para cambiar' : 'Click para hacer principal';

            const tag = $(`
                <div class="${tagClass}">
                    <i class="${iconClass}" title="${titleText}"></i>
                    <span class="proveedor-nombre">${proveedor.nombre}</span>
                    <button type="button" class="btn-close-tag" 
                            onclick="quitarProveedorTag('${proveedor.id}')" 
                            title="Eliminar proveedor">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `);

            // Click en el icono de estrella para hacer principal
            tag.find('.bi-star, .bi-star-fill').click(function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (!isPrincipal) {
                    hacerProveedorPrincipal(proveedor.id);
                }
            });

            container.append(tag);
        });
    }

    // Función para actualizar opciones disponibles en el select
    function actualizarOpcionesProveedores() {
        const select = $("#id_proveedores");
        const options = select.find('option');

        options.each(function () {
            const optionValue = $(this).val();
            const isSelected = proveedoresSeleccionados.find(p => p.id === optionValue);

            if (optionValue && isSelected) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });
    }

    // Función para actualizar el JSON hidden
    function actualizarJSONProveedores() {
        const json = JSON.stringify(proveedoresSeleccionados.map(p => ({
            id: p.id,
            principal: p.principal ? "1" : "0"
        })));

        $("#proveedores_json").val(json);
        console.log("JSON Proveedores actualizado:", json);
    }

    // Event listener para selección de proveedor
    $("#id_proveedores").on("change", function () {
        const selectedId = $(this).val();
        const selectedName = $(this).find("option:selected").text();

        if (selectedId && selectedName !== "Seleccione un proveedor") {
            agregarProveedorTag(selectedId, selectedName);
        }
    });

    // Función para limpiar proveedores
    function limpiarProveedores() {
        proveedoresSeleccionados = [];
        actualizarTagsProveedores();
        actualizarOpcionesProveedores();
        actualizarJSONProveedores();
    }

    // Función para cargar proveedores existentes de un artículo (para edición)
    function cargarProveedoresExistentes(idArticulo) {
        if (!idArticulo) {
            limpiarProveedores();
            return;
        }

        $.ajax({
            url: "../../../api/inventarios_api.php",
            type: "POST",
            dataType: "json",
            data: {
                api: 42,
                id_articulo: idArticulo
            },
            success: function (response) {
                if (response.response?.code == 1 && response.response.data) {
                    // Limpiar proveedores actuales
                    limpiarProveedores();

                    // Cargar proveedores existentes
                    response.response.data.forEach(proveedor => {
                        const esPrincipal = proveedor.principal === "1" || proveedor.principal === 1;

                        proveedoresSeleccionados.push({
                            id: proveedor.id.toString(),
                            nombre: proveedor.nombre,
                            principal: esPrincipal
                        });
                    });

                    // Asegurar que hay al menos un proveedor principal
                    if (proveedoresSeleccionados.length > 0) {
                        const hasPrincipal = proveedoresSeleccionados.some(p => p.principal);
                        if (!hasPrincipal) {
                            proveedoresSeleccionados[0].principal = true;
                        }
                    }

                    // Actualizar UI
                    actualizarTagsProveedores();
                    actualizarOpcionesProveedores();
                    actualizarJSONProveedores();

                    console.log("Proveedores cargados:", proveedoresSeleccionados);
                } else {
                    console.log("No se encontraron proveedores para el artículo:", idArticulo);
                    limpiarProveedores();
                }
            },
            error: function (xhr, status, error) {
                console.error("Error al cargar proveedores del artículo:", error);
                alertToast("Error al cargar proveedores del artículo", "error", 3000);
                limpiarProveedores();
            }
        });
    }

    // Función para configurar modal en modo edición
    function configurarModalEdicion(idArticulo) {
        if (idArticulo) {
            // Cargar proveedores después de un pequeño delay para asegurar que el select está poblado
            setTimeout(() => {
                cargarProveedoresExistentes(idArticulo);
            }, 100);
        } else {
            limpiarProveedores();
        }
    }

    // Limpiar al cerrar modal
    $('#registrarArticuloModal').on('hidden.bs.modal', function () {
        limpiarProveedores();
        // ... resto del código de limpieza existente
    });

    // Exposer funciones globalmente para que otros scripts las puedan usar
    window.configurarModalEdicion = configurarModalEdicion;
    window.limpiarProveedores = limpiarProveedores;
</script>