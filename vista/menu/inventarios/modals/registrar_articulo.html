<div class="modal fade" id="registrarArticuloModal" tabindex="-1" data-bs-backdrop="static" data-bs-focus="false"
    data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">

        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="liberarDiaTitle">Registrar <strong>Nuevo artículo</strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body container-fluid">
                <div class="container-fluid">
                    <div class="row">
                        <form id="registrarArticuloForm" name="registrarArticuloForm">
                            <!-- Formulario para crear una nueva caja -->
                            <div class="col-12">
                                <div class="text-start">
                                    <div class="shadow-sm rounded p-3 card-body">
                                        <h5 class="text-dark">Ingresa los siguientes datos</h5>

                                        <!-- Sección 1: Información General -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Información General</h6>
                                                <div class="row">
                                                    <div class="col-12">
                                                        <!-- <div class="mb-3">
                                                        <label for="no_art" class="form-label">No.</label>
                                                        <input type="text" class="form-control input-form" id="no_art" name="no_art" required>
                                                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                                                        <small class="form-text text-muted">Ingrese el número del artículo.</small>
                                                    </div> -->
                                                        <div class="mb-3">
                                                            <label for="clave_art" class="form-label">Código</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="clave_art" name="clave_art" required>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Ingrese el código único
                                                                del artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="nombre_comercial" class="form-label">Nombre
                                                                Comercial</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="nombre_comercial" name="nombre_comercial" required>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Ingrese el nombre
                                                                comercial del artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="id_marcas" class="form-label">Marca</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="id_marcas"
                                                                    name="id_marcas" required>
                                                                    <option value="">Seleccione una marca</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoMarcas" title="Gestionar Marcas">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione la marca del
                                                                artículo.</small>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="id_sustancia" class="form-label">Sustancia Activa</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="id_sustancia"
                                                                    name="id_sustancia">
                                                                    <option value="">Seleccione una sustancia activa</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoSustancias" title="Gestionar Sustancias Activas">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <small class="form-text text-muted">Para medicamentos: seleccione la sustancia activa. Para genéricos, agregue solo el gramaje en "Nombre Comercial" (ej: 500mg). Para patentes, use el nombre comercial completo.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sección 2: Configuración del Artículo -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Configuración del Artículo</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="estatus" class="form-label">Estatus</label>
                                                            <div class="form-check form-switch">
                                                                <input class="form-check-input" type="checkbox"
                                                                    name="estatus" id="estatus" checked>
                                                            </div>
                                                            <small class="form-text text-muted">Indica si el artículo
                                                                está activo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="red_frio" class="form-label">Red Frío</label>
                                                            <select class="form-select input-form" id="red_frio"
                                                                name="red_frio">
                                                                <option value="1">Sí</option>
                                                                <option value="0">No</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo requiere red frío.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="tipo_articulo" class="form-label">Tipo
                                                                Descripción</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form"
                                                                    id="tipo_articulo" name="tipo_articulo" required>
                                                                    <option value="">Seleccione un tipo</option>
                                                                    <option value="1">Reactivo</option>
                                                                    <option value="2">Insumo</option>
                                                                    <option value="3">Medicamento</option>
                                                                    <option value="60">Otros</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoTipos"
                                                                    title="Gestionar Tipos de Artículos">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione el tipo de
                                                                descripción del artículo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="area_id" class="form-label">Área</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="area_id"
                                                                    name="area_id" required>
                                                                    <option value="">Seleccione un área</option>
                                                                    <option value="1">Checkup</option>
                                                                    <option value="2">Laboratorio clínico</option>
                                                                    <option value="3">Laboratorio biomolecular</option>
                                                                    <option value="4">Administración</option>
                                                                    <option value="5">Recepción</option>
                                                                    <option value="6">Toma de muestras</option>
                                                                </select>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione a qué área
                                                                pertenece el artículo.</small>
                                                        </div>
                                                    </div>
                                                    <!-- <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_caducidad" class="form-label">Maneja
                                                                Caducidad</label>
                                                            <select class="form-select input-form" id="maneja_caducidad"
                                                                name="maneja_caducidad">
                                                                <option value="1">Sí</option>
                                                                <option value="0">No</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja caducidad.</small>
                                                        </div>
                                                    </div> -->

                                                    <!-- Nota: Los campos de fecha de caducidad, número de lote y fecha de lote 
                                                         ahora se manejan en el modal de entrada para mejor control de inventario -->
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sección 3: Detalles del Artículo -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Detalles del Artículo</h6>
                                                <div class="row">
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="unidad_venta" class="form-label">Unidad de
                                                                Venta</label>
                                                            <div class="input-group">
                                                                <select class="form-select input-form" id="unidad_venta"
                                                                    name="unidad_venta" required>
                                                                    <option value="">Seleccione una unidad</option>
                                                                    <option value="Por pieza (unidad)">Por pieza
                                                                        (unidad)</option>
                                                                    <option value="Por caja">Por caja</option>
                                                                    <option value="Por blíster (tira)">Por blíster
                                                                        (tira)</option>
                                                                    <option value="Por frasco / botella">Por frasco /
                                                                        botella</option>
                                                                    <option value="Por ampolla o vial">Por ampolla o
                                                                        vial</option>
                                                                    <option value="Por gramo / mililitro">Por gramo /
                                                                        mililitro</option>
                                                                    <option value="Por kit o presentación combinada">Por
                                                                        kit o presentación combinada</option>
                                                                </select>
                                                                <button
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                                                    class="btn btn-outline-primary" type="button"
                                                                    id="btnCatalogoUnidades"
                                                                    title="Gestionar Unidades de Venta">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione la unidad de
                                                                venta del artículo.</small>
                                                        </div>
                                                    </div>

                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="unidad_minima" class="form-label">Stock Mínimo</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="unidad_minima" name="unidad_minima">
                                                            <div class="invalid-feedback">Este campo es opcional.</div>
                                                            <small class="form-text text-muted">Cantidad mínima que debe
                                                                mantenerse en inventario antes de reabastecer.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="mb-3">
                                                            <label for="contenido" class="form-label">Especificaciones
                                                                del Producto</label>
                                                            <input type="text" class="form-control input-form"
                                                                id="contenido" name="contenido">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Detalles específicos del
                                                                contenido (ej: "100ml por frasco", "50 tiras por caja",
                                                                etc.).</small>
                                                        </div>
                                                    </div>
                                                    <!--
                                                <div class="col-6">
                                                    <div class="mb-3">
                                                        <label for="id_proveedores" class="form-label">Proveedor</label>
                                                        <select class="form-select input-form" id="id_proveedores" name="id_proveedores" required>
                                                            <option value="">Seleccione un área</option>
                                                            <option value="1">Farmacias Guadalajara</option>
                                                            <option value="2">Farmacias Similares</option>
                                                        </select>
                                                        <div class="invalid-feedback">Este campo es obligatorio.</div>
                                                        <small class="form-text text-muted">Seleccione que proveedor surte el artículo.</small>
                                                    </div>
                                                </div>-->
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_rendimiento" class="form-label">Maneja
                                                                Rendimiento</label>
                                                            <select class="form-select input-form"
                                                                id="maneja_rendimiento" name="maneja_rendimiento">
                                                                <option value="1">No</option>
                                                                <option value="0">Sí</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja rendimiento.</small>
                                                        </div>
                                                    </div>

                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <label for="maneja_inserto" class="form-label">Maneja
                                                                Inserto y Protocolo</label>
                                                            <select class="form-select input-form" id="maneja_inserto"
                                                                name="maneja_inserto">
                                                                <option value="1">No</option>
                                                                <option value="0">Sí</option>
                                                            </select>
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Seleccione si el
                                                                artículo maneja inserto y protocolo.</small>
                                                        </div>
                                                    </div>


                                                    <div class="col-12" id="rendimientoEstimadoDiv"
                                                        style="display:none;">
                                                        <div class="mb-3">
                                                            <label for="rendimiento_estimado"
                                                                class="form-label">Rendimiento Estimado
                                                                (pruebas)</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="rendimiento_estimado" name="rendimiento_estimado">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Pruebas efectivas según
                                                                proveedor</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="rendimientoPacienteDiv"
                                                        style="display:none;">
                                                        <div class="mb-3">
                                                            <label for="rendimiento_paciente"
                                                                class="form-label">Rendimiento Paciente
                                                                (pruebas)</label>
                                                            <input type="number" class="form-control input-form"
                                                                id="rendimiento_paciente" name="rendimiento_paciente">
                                                            <small class="form-text text-muted">Pruebas efectivas
                                                                reales</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sección 4: Documentos -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Documentos</h6>
                                                <div class="row">
                                                    <div class="col-12" id="insertoDiv" style="display: none;">
                                                        <div class="mb-3">
                                                            <label for="inserto" class="form-label">Inserto</label>
                                                            <input type="file" class="form-control input-form"
                                                                id="inserto" name="inserto">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Adjunte el inserto del
                                                                artículo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12" id="protocoloDiv" style="display: none;">
                                                        <div class="mb-3">
                                                            <label for="procedimiento" class="form-label">Procedimiento
                                                                Prueba</label>
                                                            <input type="file" class="form-control input-form"
                                                                id="procedimiento" name="procedimiento">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Adjunte el procedimiento
                                                                de prueba del artículo.</small>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="mb-3">
                                                            <label for="protocolo" class="form-label">Imagen</label>
                                                            <input type="file" class="form-control input-form"
                                                                id="img_producto" name="img_producto[]">
                                                            <div class="invalid-feedback">Este campo es obligatorio.
                                                            </div>
                                                            <small class="form-text text-muted">Adjunte la imagen del
                                                                artículo.</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Sección 5: Códigos de Identificación -->
                                        <div class="card mb-4">
                                            <div class="card-body">
                                                <h6 class="card-title">Identificación del Producto</h6>
                                                <div class="row">
                                                    <!-- Código de barras -->
                                                    <div class="col-6">
                                                        <div class="mb-3">
                                                            <div class="input-group">
                                                                <input type="text" class="form-control input-form"
                                                                    id="codigo_barras" name="codigo_barras"
                                                                    placeholder="Ingrese el código de barras manualmente"
                                                                    style="height: 38px;">
                                                                <button
                                                                    class="btn btn-outline-secondary d-flex align-items-center"
                                                                    type="button" id="limpiarCodigoBarras"
                                                                    title="Limpiar código"
                                                                    style="height: 38px; padding-top: 0; padding-bottom: 0;">
                                                                    <i class="bi bi-x-lg"></i>
                                                                </button>
                                                            </div>
                                                            <div class="d-flex gap-3 mt-2 flex-wrap">
                                                                <!--<button class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center" type="button" id="generarCodigoBarras" style="width: 97px;">
                                                        <i class="bi bi-upc-scan fs-5"></i>
                                                        <span class="mt-1">Generar</span>
                                                        </button> -->
                                                                <button
                                                                    class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                                                    type="button" id="leerCodigoBarras"
                                                                    style="width: 97px;">
                                                                    <i class="bi bi-upc-scan fs-5"></i>
                                                                    <span class="mt-1">Escanear</span>
                                                                </button>
                                                                <button
                                                                    class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                                                    type="button" id="generarQR" style="width:97px;">
                                                                    <i class="bi bi-qr-code fs-5"></i>
                                                                    <span class="mt-1">Generar QR</span>
                                                                </button>
                                                            </div>
                                                            <div class="d-flex gap-3 mt-2 flex-wrap">
                                                                <button
                                                                    class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                                                    type="button" id="descargarQRPNG"
                                                                    style="width:97px;">
                                                                    <i class="bi bi-filetype-png fs-5"></i>
                                                                    <span class="mt-1">Descargar Imagen</span>
                                                                </button>
                                                                <button id="descargarQRPDF"
                                                                    class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                                                    type="button" style="width: 97px;"><i
                                                                        class="bi bi-filetype-pdf fs-5"></i>Descargar
                                                                    PDF</button>
                                                                <button id="imprimirQR"
                                                                    class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                                                    type="button" style="width: 97px;"><i
                                                                        class="bi bi-file-earmark-pdf fs-5"></i>Imprimir
                                                                    PDF</button>
                                                            </div>
                                                            <small class="form-text text-muted">Ingrese o genere el
                                                                código de barras del artículo.</small>
                                                        </div>
                                                    </div>
                                                    <!-- Visualización del QR -->
                                                    <div class="col-6">
                                                        <div class="h-100 d-flex flex-column">
                                                            <div id="qrCodePreview"
                                                                class="border p-3 rounded flex-grow-1 d-flex align-items-center justify-content-center flex-column"
                                                                style="min-height: 150px;">
                                                                <small class="text-muted text-center">El código QR
                                                                    aparecerá aquí</small>
                                                                <!-- Este div contendrá el QR -->
                                                                <div id="qrCodeContainer" class="mb-2"></div>
                                                                <!-- Este div mostrará la clave y nombre -->
                                                                <div id="qrClaveDisplay" class="fw-bold text-center"
                                                                    style="font-size: 1.1rem;"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Botones de Acción -->
                                        <!-- <div class="d-flex justify-content-end mt-3">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="submit" class="btn btn-sec ms-2">Guardar</button>
                                    </div> -->

                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal"><i
                        class="bi bi-arrow-left-short"></i>
                    Cancelar</button>
                </button>

                <button type="submit" class="btn btn-confirmar" form="registrarArticuloForm">
                    <i class="bi bi-floppy-fill"></i> Guardar
                </button>
            </div>
        </div>

    </div>
</div>



<script>
    // Validación en Tiempo Real
    $('#registrarArticuloForm input').on('input', function () {
        if ($(this).val() === '') {
            $(this).addClass('');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    // Actualización del Progreso
    $('#registrarArticuloForm input, #registrarArticuloForm select').on('input change', function () {
        let completedSections = 0;
        if ($('#no_art').val() !== '' && $('#clave_art').val() !== '' && $('#nombre_comercial').val() !== '') {
            completedSections++;
        }
        if ($('#estatus').is(':checked') || $('#red_frio').val() !== '') {
            completedSections++;
        }
        if ($('#inserto').val() !== '' || $('#procedimiento').val() !== '' || $('#img_producto').val() !== '') {
            completedSections++;
        }
        $('#formProgress').text(completedSections + ' de 3 secciones completadas');
    });

    // Manejo del estado del checkbox de estatus
    let estatusVariable = 1; // Ejemplo de valor recibido
    if (estatusVariable === 1) {
        $('#estatus').prop('checked', true);
    } else {
        $('#estatus').prop('checked', false);
    }

    // Nota: La gestión de caducidad y lotes ahora se maneja en el modal de entrada

    // Mostrar u ocultar los campos de rendimiento según el valor seleccionado
    $('#maneja_rendimiento').on('change', function () {
        if ($(this).val() == '0') {
            $('#rendimientoEstimadoDiv').show();
            $('#rendimientoPacienteDiv').show();
            $("#rendimiento_estimado").attr("required", true);
            $("#rendimiento_paciente").attr("required", true);
        } else {
            $('#rendimientoEstimadoDiv').hide();
            $('#rendimientoPacienteDiv').hide();
            $("#rendimiento_estimado").val("");
            $("#rendimiento_paciente").val("");
            $("#rendimiento_estimado").removeAttr("required");
            $("#rendimiento_paciente").removeAttr("required");
            $("#rendimiento_estimado").removeClass("is-invalid");
            $("#rendimiento_paciente").removeClass("is-invalid");
        }
    });

    // Mostrar u ocultar los campos de inserto y procedimiento prueba según el valor seleccionado
    $('#maneja_inserto').on('change', function () {
        if ($(this).val() == '0') {
            $("#insertoDiv").show();
            $("#protocoloDiv").show();
            //$("#inserto").attr("required", true);
            // $("#procedimiento").attr("required", true);
        } else {
            $('#insertoDiv').hide();
            $('#protocoloDiv').hide();
            $("#insertoDiv").hide();
            $("#protocoloDiv").hide();
            $("#inserto").val("");
            // $("#inserto").removeAttr("required");
            // $("#procedimiento").removeAttr("required");
            // $("#inserto").removeClass("is-invalid");
            // $("#procedimiento").removeClass("is-invalid");
        }
    });

    /*$("#tipo_articulo").on("change", function () {
      if ($(this).val() == "1") {
        $("#rendimientoEstimadoDiv").show();
        $("#rendimientoPacienteDiv").show();
        $("#insertoDiv").show();
        $("#protocoloDiv").show();
        $("#rendimientoEstimadoDiv").attr("required", true);
        $("#rendimientoPacienteDiv").attr("required", true);
        $("#insertoDiv").attr("required", true);
        $("#protocoloDiv").attr("required", true);
      } else {
        $("#rendimientoEstimadoDiv").hide();
        $("#rendimientoPacienteDiv").hide();
        $("#insertoDiv").hide();
        $("#protocoloDiv").hide();
        $("#rendimientoEstimadoDiv").val("");
        $("#rendimientoPacienteDiv").val("");
        $("#insertoDiv").val("");
        $("#rendimientoEstimadoDiv").removeAttr("required");
        $("#rendimientoPacienteDiv").removeAttr("required");
        $("#insertoDiv").removeAttr("required");
        $("#protocoloDiv").removeAttr("required");
        $("#rendimientoEstimadoDiv").removeClass("is-invalid");
        $("#insertoDiv").removeClass("is-invalid");
        $("#protocoloDiv").removeClass("is-invalid");
      }
    });*/
    // Ejecutar al cargar para el valor inicial
    $(document).ready(function () {
        // Nota: Los triggers de caducidad y lotes se removieron porque ahora se manejan en el modal de entrada
    });

    // Generar código de barras automático (mantén el existente)
    $('#generarCodigoBarras').click(function () {
        // Tu código actual de generación de código de barras
        // Generar un código EAN-13 válido (13 dígitos)
        let prefix = '750'; // Prefijo para México
        let random = Math.floor(1000000000 + Math.random() * 9000000000).toString().substring(0, 9);
        let code = prefix + random;

        // Calcular dígito de control para EAN-13
        let sum = 0;
        for (let i = 0; i < 12; i++) {
            sum += parseInt(code.charAt(i)) * (i % 2 === 0 ? 1 : 3);
        }
        let checksum = (10 - (sum % 10)) % 10;
        let fullCode = code + checksum;

        $('#codigo_barras').val(fullCode);
    });


    // Función para limpiar el código de barras
    function limpiarCodigoBarras() {
        $('#registrarArticuloForm #codigo_barras').val('');
        limpiarErrorCodigoBarras();
        $('#registrarArticuloForm #codigo_barras').siblings('.formato-feedback').remove();
        $('#codigoBarrasContainer').hide(); // Ocultar el canvas
    }

    // Event listener para limpiar código de barras
    $(document).on('click', '#limpiarCodigoBarras', function (e) {
        e.preventDefault();
        limpiarCodigoBarras();
    });

    // Event listener para validar al perder el foco
    $('#registrarArticuloForm #codigo_barras').on('blur', function () {
        const codigo = $(this).val().trim();

        if (codigo !== '') {
            const validacion = validarCodigoBarras(codigo);

            if (!validacion.valido) {
                mostrarErrorCodigoBarras('Debe completar un código de barras válido.');
            }
        }
    });

    // Botón para generar QR
    $('#generarQR').click(function () {
        // Verificar que haya un código de barras

        // Obtener la clave del artículo
        const clave = $('#clave_art').val();
        if (!clave) {
            alertToast("La clave del artículo es requerida", "warning", 3000);
            return;
        }

        // Obtener el nombre comercial del artículo
        const nombre_comercial = $("#nombre_comercial").val();
        if (!nombre_comercial) {
            alertToast("El nombre del artículo es requerido", "warning", 3000);
            return;
        }

        if (!$('#codigo_barras').val()) {
            alertToast("Primero genere o ingrese un código de barras", "warning", 3000);
            return;
        }

        // Generar código QR con los datos del artículo
        const qrCampos = {
            clave,
            nombre_comercial: $('#nombre_comercial').val(),
            codigo_barras: $('#codigo_barras').val(),
            id_marcas: $('#id_marcas').val(),
            red_frio: $('#red_frio').val(),
            tipo_articulo: $('#tipo_articulo').val(),
            area_id: $('#area_id').val(),
            maneja_caducidad: $('#maneja_caducidad').val(),
            fecha_caducidad: $('#fecha_caducidad').val(),
            unidad_venta: $('#unidad_venta').val(),
            unidad_minima: $('#unidad_minima').val(),
            contenido: $('#contenido').val(),
            numero_lote: $('#numero_lote').val(),
            fecha_fabricacion: $('#fecha_fabricacion').val(),
            fecha_qr: new Date().toISOString().split('T')[0]
        };
        const qrDataObj = {};
        for (const key in qrCampos) {
            if (qrCampos[key] !== null && qrCampos[key] !== undefined && qrCampos[key] !== '') {
                qrDataObj[key] = qrCampos[key];
            }
        }
        const qrData = JSON.stringify(qrDataObj);
        // Limpiar los contenedores
        $('#qrCodeContainer').empty();
        $('#qrClaveDisplay').empty();

        // Generar el código QR
        if (typeof QRCode !== 'undefined') {
            new QRCode(document.getElementById("qrCodeContainer"), {
                text: qrData,
                width: 150,
                height: 150,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            // Mostrar la clave debajo del QR con mejor formato
            $('#qrClaveDisplay').html(`Clave: ${clave}<br>Nombre Comercial: ${nombre_comercial}`);



            // Ocultar el placeholder
            $('#qrCodePreview small').hide();

            // Mostrar el botón de descargar PDF
            $('#descargarQRPNG').removeClass('d-none').addClass('d-flex');
            $('#descargarQRPDF').removeClass('d-none').addClass('d-flex');
            $('#imprimirQR').removeClass('d-none').addClass('d-flex');

        } else {
            alertToast("Error: Librería QRCode no cargada", "error", 3000);
        }
    });
    /* Modificación del submit para incluir el QR en los datos
    $('#registrarArticuloForm').submit(function(e) {
        e.preventDefault();
        
        // Verificar si hay QR generado
        const qrImg = $('#qrCodePreview img');
        if (qrImg.length > 0) {
            // Convertir QR a base64 para enviarlo al servidor
            const qrDataURL = qrImg[0].src;
            $('<input>').attr({
                type: 'hidden',
                name: 'qr_image',
                value: qrDataURL
            }).appendTo('#registrarArticuloForm');
        }
        
        // Tu código existente de envío del formulario
    });
    */

    $('#descargarQRPNG').click(function () {
        if (!$('#qrCodeContainer').html()) {
            alertToast("Primero genere un código QR", "warning", 3000);
            return;
        }

        // Obtener datos
        const qrCanvas = $('#qrCodeContainer canvas')[0];
        const clave = $('#clave_art').val();
        const nombre_comercial = $('#nombre_comercial').val();

        // Crear canvas combinado
        const combinedCanvas = document.createElement('canvas');
        const ctx = combinedCanvas.getContext('2d');

        // Definir altura extra para 2 líneas de texto (ajustable)
        const extraHeight = 50;
        combinedCanvas.width = qrCanvas.width;
        combinedCanvas.height = qrCanvas.height + extraHeight;

        // Dibujar el QR
        ctx.drawImage(qrCanvas, 0, 0);

        // Estilo del texto
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillStyle = 'black';

        // Dibujar cada línea de texto debajo del QR
        const centerX = qrCanvas.width / 2;
        const startY = qrCanvas.height + 20;

        ctx.fillText(`Clave: ${clave}`, centerX, startY);
        ctx.fillText(`Nombre: ${nombre_comercial}`, centerX, startY + 20);

        // Descargar imagen
        const imgData = combinedCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `QR_${clave}.png`;
        link.href = imgData;
        link.click();
    });

    $('#descargarQRPDF').click(async function () {
        if (!$('#qrCodeContainer').html()) {
            alertToast("Primero genere un código QR", "warning", 3000);
            return;
        }

        const qrImage = $('#qrCodeContainer canvas')[0].toDataURL('image/png');
        const clave = $('#clave_art').val();
        const nombre_comercial = $('#nombre_comercial').val();
        const fecha = new Date().toLocaleDateString();

        // Crear PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm'
        });

        // Configuración de márgenes y tamaños
        const pageWidth = pdf.internal.pageSize.getWidth();
        const margin = 15;
        const qrWidth = 50; // ancho del QR en mm
        const qrX = (pageWidth - qrWidth) / 2; // centrar horizontalmente

        // Agregar título
        pdf.setFontSize(16);
        pdf.setTextColor(40);
        // Agregar título
        pdf.text(`Reporte QR - ${nombre_comercial}`, 105, 20, { align: 'center' });


        // Agregar imagen del QR
        pdf.addImage(qrImage, 'PNG', qrX, margin + 10, qrWidth, qrWidth);

        // Agregar información del artículo
        pdf.setFontSize(12);
        pdf.text(`Clave: ${clave}`, margin, margin + qrWidth + 25);
        pdf.text(`Nombre: ${nombre_comercial}`, margin, margin + qrWidth + 30);
        pdf.text(`Fecha: ${fecha}`, margin, margin + qrWidth + 35);

        // Línea decorativa
        pdf.setDrawColor(200);
        pdf.line(margin, margin + qrWidth + 40, pageWidth - margin, margin + qrWidth + 40);

        // Descargar PDF
        pdf.save(`QR_${clave}.pdf`);
    });


    $('#imprimirQR').click(function () {
        if (!$('#qrCodeContainer').html()) {
            alertToast("Primero genere un código QR", "warning", 3000);
            return;
        }

        const qrImage = $('#qrCodeContainer canvas')[0].toDataURL('image/png');
        const clave = $('#clave_art').val();
        const nombre_comercial = $('#nombre_comercial').val();
        const fecha = new Date().toLocaleDateString();

        const ventanaImpresion = window.open('', '_blank', 'width=400,height=600');

        const htmlContent = `
        <html>
            <head>
                <title>LABORATORIO BIOMOLECULAR S.A DE C.V</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .qr-container {
                        margin: 20px 0;
                        text-align: center;
                    }
                    .qr-container img {
                        width: 150px;
                        height: 150px;
                    }
                    .info {
                        margin-top: 20px;
                        text-align: left;
                        width: 100%;
                        max-width: 300px;
                        border-top: 1px solid #eee;
                        padding-top: 10px;
                    }
                    .info p {
                        margin: 5px 0;
                    }
                    @media print {
                        body { margin: 0; padding: 10px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h3>Reporte QR - ${nombre_comercial}</h3>
                </div>
                
                <div class="qr-container">
                    <img src="${qrImage}" alt="Código QR">
                </div>
                
                <div class="info">
                    <p><strong>Clave:</strong> ${clave}</p>
                    <p><strong>Nombre:</strong> ${nombre_comercial}</p>
                    <p><strong>Fecha:</strong> ${fecha}</p>
                </div>
                
                <button class="no-print" onclick="window.print()" style="margin-top: 20px; padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Imprimir
                </button>
                
               
            </body>
        </html>
    `;

        ventanaImpresion.document.open();
        ventanaImpresion.document.write(htmlContent);
        ventanaImpresion.document.close();
    });

    // Al resetear el formulario
    $('#registrarArticuloModal').on('hidden.bs.modal', function () {
        $('#qrClaveDisplay').empty();
        $('#qrCodeContainer').empty();
        $('#qrCodePreview small').show();
        $('#descargarQRPNG').addClass('d-none').removeClass('d-flex');
        $('#descargarQRPDF').addClass('d-none').removeClass('d-flex');
        $('#imprimirQR').addClass('d-none').removeClass('d-flex');
    });

    $('#btnCatalogoMarcas').click(function () {
        $('#registrarArticuloModal').modal('hide');

        $('#registrarCatalogoModal').modal('show');
        setTimeout(function () {
            $("#marcas-tab").tab("show");

            console.log("Cambiando a pestaña de marcas");
        }, 300);
    });

    $('#btnCatalogoTipos').click(function () {
        $('#registrarArticuloModal').modal('hide');

        $('#registrarCatalogoModal').modal('show');
        setTimeout(function () {
            $("#tipos-tab").tab("show");

            console.log("Cambiando a pestaña de tipos de artículos");
        }, 300);
    });

    $('#btnCatalogoUnidades').click(function () {
        $('#registrarArticuloModal').modal('hide');

        $('#registrarCatalogoModal').modal('show');
        setTimeout(function () {
            $("#unidades-tab").tab("show");

            console.log("Cambiando a pestaña de unidades de venta");
        }, 300);
    });

    $('#btnCatalogoSustancias').click(function () {
        $('#registrarArticuloModal').modal('hide');

        $('#registrarCatalogoModal').modal('show');
        setTimeout(function () {
            $("#sustancias-tab").tab("show");

            console.log("Cambiando a pestaña de sustancias activas");
        }, 300);
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>