<!-- Modal -->
<div
  class="modal fade"
  id="detalleProductoModal"
  tabindex="-1"
  aria-labelledby="detalleProductoLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detalleProductoLabel">
          Detalles del Producto
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div id="snowAnimation"></div>
        <div id="heatWaveAnimation"></div>
        <div id="warmGlowEffect"></div>
        <div class="row">
          <!-- Columna izquierda: Imagen -->
          <div class="col-md-4 text-center">
            <!-- Botones con íconos para mostrar Inserto y Procedimiento de Prueba -->
            <div class="d-grid gap-2">
              <!-- Ver imagen completa del articulo  -->
              <a target="_blank" id="verImagenArt"
                ><img
                  id="imagenProducto"
                  alt="Imagen del Producto"
                  class="img-fluid rounded"
                  style="max-height: 300px"
              /></a>
              <!-- Botón para ver el Inserto -->
              <a target="_blank" class="btn btn-danger" id="verInsertoBtn"
                ><i class="fas fa-file-pdf"></i> Ver Inserto</a
              >
              <!-- Botón para ver el Procedimiento de Prueba -->
              <a
                target="_blank"
                class="btn btn-secondary"
                id="verProcedimientoBtn"
                ><i class="fas fa-vial"></i> Ver Procedimiento</a
              >
              <!-- Botón editar desde detalles (Inactivo)
                  <button
                    type="button"
                    class="btn btn-secondary"
                    id="btnEditarArticulo"
                    data-bs-toggle="tooltip"
                    data-bs-placement="top"
                    title="Editar el artículo seleccionado">
                    <i class="bi bi-pencil-square"></i> Editar
                  </button> -->
                </div>
                <div class="d-grid gap-2 text-center containerSvg" id="animation">
                  
                </div>
                <!-- En el div donde quieres mostrar el código de barras -->
                <div id="codigoBarrasContainer" style="text-align: center; margin-top: 10px;">
                <canvas id="codigoBarras" style="max-width: 100%;"></canvas>
                <div id="codigoBarrasTexto" style="margin-top: 5px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
  
            <!-- Columna derecha: Información del producto -->
            <div class="col-md-8">
              <div class="card">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                  <h5 class="card-title mb-0 me-2" id="nombreComercial">Nombre Comercial </h5>
                  <span id="redFrio" class="me-2"></span>
          
                  <div class="d-inline p-2 bg-primary-subtle me-2"><span id="tipo"></span></div>
                  <div class="d-inline p-2" id="estatusArt"></div>
                  </div>
                  <!-- <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Clave del Artículo:</strong> <span id="claveArticulo"></span></li>
                    <li class="list-group-item"><strong>Costo Última Entrada:</strong> $<span id="costoUltimaEntrada"></span></li>
                    <li class="list-group-item"><strong>Costo Más Alto:</strong> $<span id="costoMasAlto"></span></li>
                    <li class="list-group-item"><strong>Fecha Última Entrada:</strong> <span id="fechaUltimaEntrada"></span></li>
                    <li class="list-group-item"><strong>Unidad de Venta:</strong> <span id="unidadVenta"></span></li>
                    <li class="list-group-item"><strong>Unidad Mínima:</strong> <span id="unidadMinima"></span></li>
                    <li class="list-group-item"><strong>Contenido:</strong> <span id="contenido"></span></li>
                    <li class="list-group-item"><strong>Maneja Caducidad:</strong> <span id="manejaCaducidad"></span></li>
                    <li class="list-group-item"><strong>Fecha Caducidad:</strong> <span id="fechaCaducidad"></span></li>
                    <li class="list-group-item"><strong>Área:</strong> <span id="area"></span></li>
                    <li class="list-group-item"><strong>Rendimiento Estimado:</strong> <span id="rendimientoEstimado"></span></li>
                    <li class="list-group-item"><strong>Rendimiento Paciente:</strong> <span id="rendimientoPaciente"></span></li>
                  </ul> -->
                  <div class="row">
                    <!-- Primera tarjeta: Información general -->
                    <div class="col-md-6">
                      <div class="card mb-3">
                        <div class="card-header">Información General</div>
                        <div class="card-body">
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Clave del Artículo:</strong> <span id="claveArticulo"></span></li>
                            <li class="list-group-item"><strong>Unidad de Venta:</strong> <span id="unidadVenta"></span></li>
                            <li class="list-group-item"><strong>Unidad Mínima:</strong> <span id="unidadMinima"></span></li>
                            <li class="list-group-item"><strong>Área:</strong> <span id="areaDetalle"></span></li>
                            <li class="list-group-item"><strong>Marca:</strong> <span id="marcaDetalle"></span></li>
                            <li class="list-group-item"><strong>No. Lote:</strong> <span id="numeroLote"></span></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                
                    <!-- Segunda tarjeta: Costos y fechas -->
                    <div class="col-md-6">
                      <div class="card mb-3">
                        <div class="card-header">Costos y Fechas</div>
                        <div class="card-body">
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Costo Última Entrada:</strong> <span id="costoUltimaEntrada"></span></li>
                            <li class="list-group-item"><strong>Fecha Última Entrada:</strong> <span id="fechaUltimaEntrada"></span></li>
                            <li class="list-group-item"><strong>Costo Más Alto:</strong> <span id="costoMasAlto"></span></li>
                            <li id="fechaCaducidad1" class="list-group-item"><strong>Fecha Caducidad:</strong> <span id="fechaCaducidad"></span></li>
                            <li class="list-group-item"><strong>Fecha de Lote:</strong> <span id="fechaLote"></span></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                
                    <!-- Tercera tarjeta: Rendimiento y Caducidad -->
                    <div class="col-md-6">
                      <div class="card mb-3">
                        <div class="card-header">Rendimiento y Caducidad</div>
                        <div class="card-body">
                          <ul class="list-group list-group-flush">
                            <li class="list-group-item"><strong>Maneja Caducidad:</strong> <span id="manejaCaducidad"></span></li>
                            <li class="list-group-item"><strong>Descripción:</strong> <span id="contenidoDetalle"></span></li>
                            <li id="rendimientoEstimado1" class="list-group-item"><strong>Rendimiento Estimado:</strong> <span id="rendimientoEstimado"></span></li>
                            <li id="rendimientoPaciente1" class="list-group-item"><strong>Rendimiento Paciente:</strong> <span id="rendimientoPaciente"></span></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <!-- Cuarta tarjeta: Proveedores -->
                  <div class="col-md-6">
                    <div class="card mb-3">
                      <div class="card-header">Proveedores</div>
                      <div class="card-body">
                        <ul class="list-group list-group-flush">
                          <li class="list-group-item">
                            <strong>Proveedores:</strong>
                            <span id="proveedoresArt"></span>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  <style>
    #snowAnimation {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none; /* No interfiere con los clics */
      z-index: 100;
  }

  .snowflake {
    position: absolute;
    top: -10px;
    font-size: 24px;
    color: white;
    opacity: 0.8;
    animation: fall linear infinite;
  }

  @keyframes fall {
    0% {
      top: -10px;
      opacity: 0.8;
    }
    100% {
      top: 100%;
      opacity: 0;
    }
  }

  @keyframes warmGlow {
    0% {
      box-shadow: 0 0 20px rgba(255, 140, 0, 0.8);
      opacity: 0.6;
    }
    50% {
      box-shadow: 0 0 30px rgba(255, 69, 0, 0.9);
      opacity: 0.8;
    }
    100% {
      box-shadow: 0 0 20px rgba(255, 140, 0, 0.8);
      opacity: 0.6;
    }
  }

  #warmGlowEffect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    background: transparent;
  }

  .warm-glow {
    position: absolute;
    width: 50px;
    height: 50px;
    background: rgba(255, 69, 0, 0.8);
    border-radius: 50%;
    animation: warmGlow 2s infinite;
  }

  #heatWaveAnimation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    overflow: hidden;
  }

  .heatwave {
    position: absolute;
    width: 50px;
    height: 50px;
    background: rgba(255, 69, 0, 0.8);
    /*background: rgba(255, 165, 0, 0.5);*/ /* Naranja semitransparente */
    border-radius: 50%;
    opacity: 0;
    animation: wave 4s linear infinite;
  }

  @keyframes wave {
    0% {
      transform: scale(1);
      opacity: 0.6;
    }
    50% {
      transform: scale(2);
      opacity: 0.2;
    }
    100% {
      transform: scale(3);
      opacity: 0;
    }
  }

  .containerSvg {
    display: flex;
    justify-content: center; /* Centra horizontalmente */
    align-items: center; /* Centra verticalmente */
    height: 200px; /* Ajusta la altura del contenedor según sea necesario */
    /* border: 1px solid #ddd; Opcional, solo para ver los límites del contenedor */
  }
</style>


<script>
  // Función para generar y mostrar el código de barras visual
function mostrarCodigoBarras(codigo) {
    if (!codigo || codigo.trim() === '') {
        // Si no hay código, ocultar el contenedor
        document.getElementById('codigoBarrasContainer').style.display = 'none';
        return;
    }
    
    try {
        // Mostrar el contenedor
        document.getElementById('codigoBarrasContainer').style.display = 'block';
        
        // Generar el código de barras en el canvas
        JsBarcode("#codigoBarras", codigo, {
            format: "CODE128", // Formato más flexible que acepta números y texto
            width: 2,
            height: 60,
            displayValue: true,
            fontSize: 12,
            textMargin: 5,
            background: "#ffffff",
            lineColor: "#000000"
        });
        
        // Mostrar el código como texto también
        document.getElementById('codigoBarrasTexto').textContent = 'Código: ' + codigo;
        
    } catch (error) {
        console.error('Error al generar código de barras:', error);
        // En caso de error, mostrar solo el texto
        document.getElementById('codigoBarrasTexto').textContent = 'Código: ' + codigo;
    }
}

// Función para detectar el tipo de código y usar el formato apropiado
function detectarFormatoCodigo(codigo) {
    // Si es solo números y tiene 13 dígitos, usar EAN13
    if (/^\d{13}$/.test(codigo)) {
        return "EAN13";
    }
    // Si es solo números y tiene 12 dígitos, usar UPC
    else if (/^\d{12}$/.test(codigo)) {
        return "UPC";
    }
    // Si es solo números y tiene 8 dígitos, usar EAN8
    else if (/^\d{8}$/.test(codigo)) {
        return "EAN8";
    }
    // Para cualquier otro caso (números + texto), usar CODE128
    else {
        return "CODE128";
    }
}

// Versión mejorada de la función que detecta automáticamente el formato
function mostrarCodigoBarrasInteligente(codigo) {
    if (!codigo || codigo.trim() === '') {
        document.getElementById('codigoBarrasContainer').style.display = 'none';
        return;
    }
    
    try {
        document.getElementById('codigoBarrasContainer').style.display = 'block';
        
        const formato = detectarFormatoCodigo(codigo);
        
        JsBarcode("#codigoBarras", codigo, {
            format: formato,
            width: formato === "CODE128" ? 1.5 : 2,
            height: 60,
            displayValue: true,
            fontSize: 12,
            textMargin: 5,
            background: "#ffffff",
            lineColor: "#000000"
        });
        
        document.getElementById('codigoBarrasTexto').textContent = 'Código: ' + codigo;
        
    } catch (error) {
        console.error('Error al generar código de barras:', error);
        document.getElementById('codigoBarrasTexto').textContent = 'Código: ' + codigo;
    }
}

// Función optimizada para mostrar el código de barras solo en el modal de detalles
function mostrarCodigoBarrasDetalle(codigo) {
    // Verificar que el contenedor exista
    const container = document.getElementById('codigoBarrasContainer');
    const canvas = document.getElementById('codigoBarras');
    const textoElement = document.getElementById('codigoBarrasTexto');
    
    if (!container || !canvas || !textoElement) {
        console.error('No se encontraron elementos necesarios para el código de barras');
        return;
    }
    
    // Si no hay código válido, ocultar el contenedor y terminar
    if (!codigo || codigo.trim() === '') {
        container.style.display = 'none';
        return;
    }
    
    try {
        // Limpiar el canvas para evitar superposiciones
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Reiniciar dimensiones
        canvas.width = 0;
        canvas.height = 0;
        
        // Mostrar el contenedor
        container.style.display = 'block';
        
        // Detectar el formato apropiado
        const formato = detectarFormatoCodigo(codigo);
        
        // Generar el código de barras
        JsBarcode("#codigoBarras", codigo, {
            format: formato,
            width: formato === "CODE128" ? 1.5 : 2,
            height: 60,
            displayValue: true,
            fontSize: 12,
            textMargin: 5,
            background: "#ffffff",
            lineColor: "#000000"
        });
        
        // Mostrar el código como texto también
        textoElement.textContent = 'Código: ' + codigo;
        
    } catch (error) {
        console.error('Error al generar código de barras:', error, 'para código:', codigo);
        // En caso de error, mostrar solo el texto
        textoElement.textContent = 'Código: ' + codigo;
        
        // Intentar con un formato más permisivo en caso de error
        try {
            JsBarcode("#codigoBarras", codigo, {
                format: "CODE128",
                width: 1.5,
                height: 60,
                displayValue: true,
                fontSize: 12,
                textMargin: 5,
                background: "#ffffff",
                lineColor: "#000000"
            });
        } catch (secondError) {
            console.error('Error en segundo intento con CODE128:', secondError);
            // Si sigue fallando, simplemente ocultar el canvas
            canvas.style.display = 'none';
        }
    }
}

// Función para detectar el formato adecuado para el código
function detectarFormatoCodigo(codigo) {
    if (!codigo || typeof codigo !== 'string') {
        return "CODE128"; // Valor por defecto
    }
    
    const codigoLimpio = codigo.trim();
    
    // Verificar diferentes formatos comunes
    if (/^\d{13}$/.test(codigoLimpio)) {
        return "EAN13";
    } else if (/^\d{12}$/.test(codigoLimpio)) {
        return "UPC";
    } else if (/^\d{8}$/.test(codigoLimpio)) {
        return "EAN8";
    } else if (/^\d{5}$/.test(codigoLimpio)) {
        return "EAN5";
    } else if (/^\d{2}$/.test(codigoLimpio)) {
        return "EAN2";
    } else {
        return "CODE128"; // Más flexible para cualquier combinación alfanumérica
    }
}

// Agregar este event listener para asegurar que el código de barras se genere cuando se muestra el modal
$(document).ready(function() {
  $('#detalleProductoModal').on('shown.bs.modal', function () {
    // Si existe un rowSelected y tiene código de barras
    if (rowSelected && rowSelected.codigo_barras && rowSelected.codigo_barras.trim() !== '') {
      // Retrasar ligeramente la generación para asegurar que el DOM está listo
      setTimeout(() => {
        mostrarCodigoBarrasDetalle(rowSelected.codigo_barras);
      }, 100);
    }
  });
  
  // Limpiar el canvas cuando se cierra el modal para evitar problemas
  $('#detalleProductoModal').on('hidden.bs.modal', function () {
    const canvas = document.getElementById('codigoBarras');
    if (canvas) {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<!-- Manejo del modal desde los detalles (Inactivo) -->
<!--
  <script>
    // Puedes poner esto en el archivo JS que controla el modal de detalles
    $('#btnEditarArticulo').on('click', function() {
        var rowSelected = window.articuloActual; // Ya está garantizado que existe
        $('#detalleProductoModal').modal('hide');

        // Abre el modal de edición y llena el formulario
        $("#editarArticuloModal").modal('show');
        $('#editandoArticulo').text(` ${rowSelected.CLAVE_ART}`);

        $('#editarArticuloForm #no_art').val(rowSelected.NO_ART);
        $('#editarArticuloForm #clave_art').val(rowSelected.CLAVE_ART);
        $('#editarArticuloForm #nombre_comercial').val(rowSelected.NOMBRE_COMERCIAL);

        if(rowSelected.ESTATUS == 1){
            $('#editarArticuloForm #estatus').prop("checked", true);
        } else {
            $('#editarArticuloForm #estatus').prop("checked", false);
        }
        $('#editarArticuloForm #red_frio').val(rowSelected.RED_FRIO);
        $('#editarArticuloForm #unidad_venta').val(rowSelected.UNIDAD_VENTA);
        $('#editarArticuloForm #unidad_minima').val(rowSelected.UNIDAD_MINIMA);
        $('#editarArticuloForm #contenido').val(rowSelected.CONTENIDO);
        $('#editarArticuloForm #tipo_articulo').val(rowSelected.TIPO_ARTICULO_ID);
        $('#editarArticuloForm #maneja_caducidad').val(rowSelected.MANEJA_CADUCIDAD);

        $('#editarArticuloForm #fecha_caducidad').val(rowSelected.FECHA_CADUCIDAD);

        // Mostrar/ocultar campo de fecha de caducidad según maneja_caducidad
        if (rowSelected.MANEJA_CADUCIDAD == 1) {
            $('#editarArticuloForm #fecha_caducidad').closest('.mb-3').show();
        } else {
            $('#editarArticuloForm #fecha_caducidad').closest('.mb-3').hide();
            $('#editarArticuloForm #fecha_caducidad').val('');
        }
        $('#editarArticuloForm #maneja_caducidad').off('change').on('change', function() {
            if ($(this).val() == "1") {
                $('#editarArticuloForm #fecha_caducidad').closest('.mb-3').show();
            } else {
                $('#editarArticuloForm #fecha_caducidad').closest('.mb-3').hide();
                $('#editarArticuloForm #fecha_caducidad').val('');
            }
        });

        $('#editarArticuloForm #fecha_ultima_entrada').val(
            rowSelected.FECHA_ULTIMA_ENTRADA ? rowSelected.FECHA_ULTIMA_ENTRADA.split(' ')[0] : ''
        );

        //$("#editarArticuloForm #area_id").val(rowSelected.AREA_ID);
        $("#editarArticuloForm #costo_mas_alto").val(rowSelected.COSTO_MAS_ALTO);
        $("#editarArticuloForm #rendimiento_estimado").val(rowSelected.RENDIMIENTO_ESTIMADO);
    });

    // Ejemplo: al hacer doble click en una fila de la tabla
    $('#tableCatArticulos').on('dblclick', 'tr', function() {
        var data = tableCatArticulos.row(this).data();
        if (data) {
            window.articuloActual = data; // Guarda el artículo seleccionado
            // Aquí puedes llenar los campos del modal de detalles con data...
            $('#detalleProductoModal').modal('show');
        }
    });
  </script>
-->
