<!-- CSS para tags de proveedores -->
<link href="../../../css/proveedores-tags.css" rel="stylesheet">

<div
  class="modal fade"
  id="editarArticuloModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-focus="false"
  data-bs-keyboard="false"
  role="dialog"
  aria-labelledby="modalTitleId"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleArticuloEditar">
          Editar <strong>Art√≠culo</strong>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body container-fluid">
        <div class="container-fluid">
          <div class="row">
            <form id="editarArticuloForm" name="editarArticuloForm">
              <div class="col-12">
                <div class="text-start">
                  <div class="shadow-sm rounded p-3 card-body">
                    <h5 class="text-dark">Edita los siguientes datos</h5>

                    <!-- Secci√≥n 1: Informaci√≥n General -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Informaci√≥n General</h6>
                        <div class="row">
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="clave_art" class="form-label"
                                >C√≥digo</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="clave_art"
                                name="clave_art"
                                required
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Ingrese el c√≥digo √∫nico del art√≠culo.</small
                              >
                            </div>
                            <div class="mb-3">
                              <label for="nombre_comercial" class="form-label"
                                >Nombre Comercial</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="nombre_comercial"
                                name="nombre_comercial"
                                required
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Ingrese el nombre comercial del
                                art√≠culo.</small
                              >
                            </div>
                            <div class="mb-3">
                              <label for="id_marcas" class="form-label"
                                >Marca</label
                              >
                              <div class="input-group">
                                <select
                                  class="form-select input-form"
                                  id="id_marcas"
                                  name="id_marcas"
                                  required
                                >
                                  <option value="">Seleccione una marca</option>
                                </select>
                                <button
                                  style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                  class="btn btn-outline-primary" type="button"
                                  id="btnCatalogoMarcas" title="Gestionar Marcas">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione la marca del art√≠culo.</small
                              >
                            </div>
                            <div class="mb-3">
                              <label for="id_sustancia" class="form-label">Sustancia
                                Activa</label>
                              <div class="input-group">
                                <select class="form-select input-form" id="id_sustancia"
                                  name="id_sustancia">
                                  <option value="">Seleccione una sustancia activa
                                  </option>
                                </select>
                                <button
                                  style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                  class="btn btn-outline-primary" type="button"
                                  id="btnCatalogoSustancias"
                                  title="Gestionar Sustancias Activas">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>
                              <small class="form-text text-muted">Para medicamentos:
                                seleccione la sustancia activa. Para gen√©ricos, agregue
                                solo el gramaje en "Nombre Comercial" (ej: 500mg). Para
                                patentes, use el nombre comercial completo.</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Secci√≥n 2: Configuraci√≥n del Art√≠culo -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Configuraci√≥n del Art√≠culo</h6>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="estatus" class="form-label"
                                >Estatus</label
                              >
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  name="estatus"
                                  id="estatus"
                                />
                              </div>
                              <small class="form-text text-muted"
                                >Indica si el art√≠culo est√° activo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="red_frio" class="form-label"
                                >Red Fr√≠o</label
                              >
                              <select
                                class="form-select input-form"
                                id="red_frio"
                                name="red_frio"
                              >
                                <option value="1">S√≠</option>
                                <option value="0">No</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el art√≠culo requiere red
                                fr√≠o.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="tipo_articulo" class="form-label"
                                >Tipo Descripci√≥n</label
                              >
                              <div class="input-group">
                                <select
                                  class="form-select tipo_articulo input-form"
                                  id="tipo_articulo"
                                  name="tipo_articulo"
                                  required
                                >
                                  <option value="">Seleccione un tipo</option>
                                  <option value="1">Reactivo</option>
                                  <option value="2">Insumo</option>
                                  <option value="3">Medicamento</option>
                                  <option value="60">Otros</option>
                                </select>
                                <button
                                  style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                  class="btn btn-outline-primary" type="button"
                                  id="btnCatalogoTipos"
                                  title="Gestionar Tipos de Art√≠culos">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione el tipo de descripci√≥n del
                                art√≠culo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="area_id" class="form-label"
                                >√Årea</label
                              >
                              <select
                                class="form-select input-form"
                                id="area_id"
                                name="area_id"
                                required
                              >
                                <option value="">Seleccione un √°rea</option>
                                <option value="1">Checkup</option>
                                <option value="2">Laboratorio cl√≠nico</option>
                                <option value="3">
                                  Laboratorio biomolecular
                                </option>
                                <option value="4">Administraci√≥n</option>
                                <option value="5">Recepci√≥n</option>
                                <option value="6">Toma de muestras</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione a qu√© √°rea pertenece el
                                art√≠culo.</small
                              >
                            </div>
                          </div>
                          <!-- Nota: Los campos de fecha de caducidad, n√∫mero de lote y fecha de lote 
                               ahora se manejan en el modal de entrada para mejor control de inventario -->
                        </div>
                      </div>
                    </div>

                    <!-- Secci√≥n 3: Detalles del Art√≠culo -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Detalles del Art√≠culo</h6>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="unidad_venta" class="form-label"
                                >Unidad de Venta</label
                              >
                              <div class="input-group">
                                <select
                                  class="form-select input-form"
                                  id="unidad_venta"
                                  name="unidad_venta"
                                  required
                                >
                                  <option value="">Seleccione una unidad</option>
                                  <option value="Por pieza (unidad)">Por pieza
                                    (unidad)</option>
                                  <option value="Por caja">Por caja</option>
                                  <option value="Por bl√≠ster (tira)">Por bl√≠ster
                                    (tira)</option>
                                  <option value="Por frasco / botella">Por frasco /
                                    botella</option>
                                  <option value="Por ampolla o vial">Por ampolla o
                                    vial</option>
                                  <option value="Por gramo / mililitro">Por gramo /
                                    mililitro</option>
                                  <option value="Por kit o presentaci√≥n combinada">Por
                                    kit o presentaci√≥n combinada</option>
                                </select>
                                <button
                                  style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                  class="btn btn-outline-primary" type="button"
                                  id="btnCatalogoUnidades"
                                  title="Gestionar Unidades de Venta">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione la unidad de venta del
                                art√≠culo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="unidad_minima" class="form-label"
                                >Stock M√≠nimo</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="unidad_minima"
                                name="unidad_minima"
                              />
                              <div class="invalid-feedback">
                                Este campo es opcional.
                              </div>
                              <small class="form-text text-muted"
                                >Cantidad m√≠nima que debe mantenerse en
                                inventario antes de reabastecer.</small
                              >
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="contenido" class="form-label"
                                >Especificaciones del Producto</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="contenido"
                                name="contenido"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Detalles espec√≠ficos del contenido (ej: "100ml
                                por frasco", "50 tiras por caja", etc.).</small
                              >
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="id_proveedores"
                                class="form-label">Proveedores</label>

                              <!-- √Årea de Tags de Proveedores Seleccionados -->
                              <div id="proveedoresSelectedContainer" class="mb-2"
                                style="min-height: 40px; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 8px; background-color: #f8f9fa;">
                                <div id="proveedoresTagsArea"
                                  class="d-flex flex-wrap gap-2">
                                  <small class="text-muted align-self-center"
                                    id="proveedoresPlaceholder">
                                    No hay proveedores seleccionados. Seleccione uno
                                    o m√°s proveedores del men√∫ desplegable.
                                  </small>
                                </div>
                              </div>

                              <div class="input-group">
                                <select class="form-select input-form"
                                  id="id_proveedores" name="id_proveedores">
                                  <option value="">Seleccione un proveedor</option>
                                </select>
                                <button
                                  style="height: 38px; padding-top: 0; padding-bottom: 0;"
                                  class="btn btn-outline-primary" type="button"
                                  id="btnNuevoProveedor"
                                  title="Gestionar Proveedores">
                                  <i class="bi bi-plus"></i>
                                </button>
                              </div>

                              <!-- Campo hidden para enviar JSON de proveedores -->
                              <input type="hidden" id="proveedores_json"
                                name="proveedores_json" value="">

                              <small class="form-text text-muted">Seleccione uno o m√°s
                                proveedores. El primer proveedor ser√° considerado como
                                principal.</small>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="maneja_rendimiento" class="form-label"
                                >Maneja Rendimiento</label
                              >
                              <select
                                class="form-select input-form"
                                id="maneja_rendimiento"
                                name="maneja_rendimiento"
                              >
                                <option value="1">No</option>
                                <option value="0">S√≠</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el art√≠culo maneja
                                rendimiento.</small
                              >
                            </div>
                          </div>

                          <div class="col-6">
                            <div class="mb-3">
                              <label for="maneja_inserto" class="form-label"
                                >Maneja Inserto y Protocolo</label
                              >
                              <select
                                class="form-select input-form"
                                id="maneja_inserto"
                                name="maneja_inserto"
                              >
                                <option value="1">No</option>
                                <option value="0">S√≠</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el art√≠culo maneja inserto y
                                protocolo.</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-12"
                            id="rendimientoEstimadoDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label
                                for="rendimiento_estimado"
                                class="form-label"
                                >Rendimiento Estimado (pruebas)</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="rendimiento_estimado"
                                name="rendimiento_estimado"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Pruebas efectivas seg√∫n proveedor</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-12"
                            id="rendimientoPacienteDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label
                                for="rendimiento_paciente"
                                class="form-label"
                                >Rendimiento Paciente (pruebas)</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="rendimiento_paciente"
                                name="rendimiento_paciente"
                              />
                              <small class="form-text text-muted"
                                >Pruebas efectivas reales</small
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Secci√≥n 4: Documentos -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Documentos</h6>
                        <div class="row">
                          <div
                            class="col-12"
                            id="insertoDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label for="inserto" class="form-label"
                                >Inserto</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="inserto"
                                name="inserto"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte el inserto del art√≠culo.</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-12"
                            id="protocoloDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label for="procedimiento" class="form-label"
                                >Procedimiento Prueba</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="procedimiento"
                                name="procedimiento"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte el procedimiento de prueba del
                                art√≠culo.</small
                              >
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="img_producto" class="form-label"
                                >Imagen</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="img_producto"
                                name="img_producto[]"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte la imagen del art√≠culo.</small
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Secci√≥n 5: Vista Previa del Inserto -->
                    <div class="card mb-4" id="vistaPreviaInsertoCard" style="display: none;">
                      <div class="card-body">
                        <h6 class="card-title">Vista Previa del Inserto</h6>
                        <div class="row">
                          <!-- Botones de control -->
                          <div class="col-6">
                            <div class="mb-3">
                              <div class="d-flex gap-3 mt-2 flex-wrap">
                                <button
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                  type="button" id="verPreviaInserto" style="width:97px;"
                                  disabled>
                                  <i class="bi bi-eye fs-5"></i>
                                  <span class="mt-1">Ver Previa</span>
                                </button>
                                <button
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                  type="button" id="descargarInserto" style="width:97px;">
                                  <i class="bi bi-download fs-5"></i>
                                  <span class="mt-1">Descargar</span>
                                </button>
                                <button
                                  class="btn btn-outline-success btn-sm d-flex flex-column align-items-center d-none"
                                  type="button" id="abrirNuevaVentana" style="width:97px;">
                                  <i class="bi bi-box-arrow-up-right fs-5"></i>
                                  <span class="mt-1">Vista completa</span>
                                </button>
                              </div>
                              <small class="form-text text-muted">Previsualice el PDF antes de
                                guardar el art√≠culo. <br>Nota: complete c√≥digo y nombre
                                comercial para visualizar.</small>
                            </div>
                          </div>
                          <!-- Vista previa del PDF -->
                          <div class="col-6">
                            <div class="h-100 d-flex flex-column">
                              <div id="pdfPreviewContainer"
                                class="border p-3 rounded flex-grow-1 d-flex align-items-center justify-content-center flex-column"
                                style="min-height: 200px;">
                                <small class="text-muted text-center">La vista previa del PDF
                                  aparecer√° aqu√≠</small>
                                <!-- Este iframe contendr√° el PDF -->
                                <iframe id="pdfPreviewFrame"
                                  style="width: 100%; height: 100%; display: none;"
                                  frameborder="0">
                                </iframe>
                                <!-- Informaci√≥n del archivo -->
                                <div id="pdfInfoDisplay" class="fw-bold text-center mt-2"
                                  style="font-size: 0.9rem;"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Secci√≥n 6: C√≥digo de Barras -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">C√≥digo de Barras</h6>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="codigo_barras" class="form-label"
                                >C√≥digo de Barras</label
                              >
                              <div class="input-group">
                                <input
                                  type="text"
                                  class="form-control input-form"
                                  id="codigo_barras"
                                  name="codigo_barras"
                                  placeholder="Ingrese el c√≥digo de barras manualmente"
                                  style="height: 38px"
                                />
                                <button
                                  class="btn btn-outline-secondary d-flex align-items-center"
                                  type="button"
                                  id="limpiarCodigoBarras"
                                  title="Limpiar c√≥digo"
                                  style="
                                    height: 38px;
                                    padding-top: 0;
                                    padding-bottom: 0;
                                  "
                                >
                                  <i class="bi bi-x-lg"></i>
                                </button>
                              </div>
                              <small class="form-text text-muted">Ingrese el c√≥digo de barras del
                                art√≠culo.</small>
                            </div>
                          </div>
                          <div class="col-6 d-flex justify-content-center align-items-center">
                            <div class="mb-3 text-center w-100">
                              <button
                                class="btn btn-outline-secondary btn-lg d-flex flex-column align-items-center justify-content-center mx-auto"
                                type="button" id="leerCodigoBarras"
                                style="width: 106px; height: 77px;">
                                <i class="bi bi-upc-scan fs-2"></i>
                                <span>Escanear</span>
                              </button>
                              <small class="form-text text-muted d-block mt-2">Puede escanear el
                                c√≥digo de barras.</small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left-short"></i> Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-confirmar"
          form="editarArticuloForm"
        >
          <i class="bi bi-pencil-square"></i> Editar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Validaci√≥n en Tiempo Real
  $('#editarArticuloForm input').on('input', function () {
    if ($(this).val() === '') {
      $(this).addClass('');
    } else {
      $(this).removeClass('is-invalid');
    }
  });

  // Actualizaci√≥n del Progreso
  $('#editarArticuloForm input, #editarArticuloForm select').on('input change', function () {
    let completedSections = 0;
    if ($('#clave_art').val() !== '' && $('#nombre_comercial').val() !== '') {
      completedSections++;
    }
    if ($('#estatus').is(':checked') || $('#red_frio').val() !== '') {
      completedSections++;
    }
    if ($('#inserto').val() !== '' || $('#procedimiento').val() !== '' || $('#img_producto').val() !== '') {
      completedSections++;
    }
  });

  // Funci√≥n para validar c√≥digo de barras
  function validarCodigoBarras(codigo) {
    if (!codigo || codigo.length < 8) {
      return { valido: false, mensaje: 'C√≥digo muy corto' };
    }

    // Validar EAN-13 (13 d√≠gitos)
    if (codigo.length === 13 && /^\d+$/.test(codigo)) {
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 1 : 3);
      }
      let checksum = (10 - (sum % 10)) % 10;
      if (checksum === parseInt(codigo.charAt(12))) {
        return { valido: true, tipo: 'EAN-13' };
      }
    }

    // Validar EAN-8 (8 d√≠gitos)
    if (codigo.length === 8 && /^\d+$/.test(codigo)) {
      let sum = 0;
      for (let i = 0; i < 7; i++) {
        sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 3 : 1);
      }
      let checksum = (10 - (sum % 10)) % 10;
      if (checksum === parseInt(codigo.charAt(7))) {
        return { valido: true, tipo: 'EAN-8' };
      }
    }

    // Validar UPC-A (12 d√≠gitos)
    if (codigo.length === 12 && /^\d+$/.test(codigo)) {
      let sum = 0;
      for (let i = 0; i < 11; i++) {
        sum += parseInt(codigo.charAt(i)) * (i % 2 === 0 ? 3 : 1);
      }
      let checksum = (10 - (sum % 10)) % 10;
      if (checksum === parseInt(codigo.charAt(11))) {
        return { valido: true, tipo: 'UPC-A' };
      }
    }

    return { valido: false, mensaje: 'Formato de c√≥digo de barras no v√°lido' };
  }

  // Funci√≥n para mostrar error en c√≥digo de barras
  function mostrarErrorCodigoBarras(mensaje) {
    $('#codigo_barras').addClass('is-invalid');
    // Remover feedback anterior
    $('#codigo_barras').siblings('.formato-feedback').remove();
    // Agregar nuevo feedback
    $('<div class="formato-feedback text-danger small mt-1"></div>')
      .text(mensaje)
      .insertAfter('#codigo_barras');
  }

  // Funci√≥n para limpiar errores del c√≥digo de barras
  function limpiarErrorCodigoBarras() {
    $('#codigo_barras').removeClass('is-invalid');
    $('#codigo_barras').siblings('.formato-feedback').remove();
  }

  // Funci√≥n para limpiar el c√≥digo de barras
  function limpiarCodigoBarras() {
    $('#editarArticuloForm #codigo_barras').val('');
    limpiarErrorCodigoBarras();
    $('#editarArticuloForm #codigo_barras').siblings('.formato-feedback').remove();
  }

  // Event listener para limpiar c√≥digo de barras
  $(document).on('click', '#limpiarCodigoBarras', function (e) {
    e.preventDefault();
    limpiarCodigoBarras();
  });

  // Event listener para validar al perder el foco
  $('#editarArticuloForm #codigo_barras').on('blur', function () {
    const codigo = $(this).val().trim();

    if (codigo !== '') {
      const validacion = validarCodigoBarras(codigo);

      if (!validacion.valido) {
        mostrarErrorCodigoBarras('Debe completar un c√≥digo de barras v√°lido.');
      } else {
        limpiarErrorCodigoBarras();
        // Mostrar tipo de c√≥digo v√°lido
        $('<div class="formato-feedback text-success small mt-1"></div>')
          .text(`‚úì C√≥digo ${validacion.tipo} v√°lido`)
          .insertAfter('#codigo_barras');
      }
    } else {
      limpiarErrorCodigoBarras();
    }
  });

  // Event listener para validar mientras escribe
  $('#editarArticuloForm #codigo_barras').on('input', function () {
    const codigo = $(this).val().trim();

    if (codigo === '') {
      limpiarErrorCodigoBarras();
      return;
    }

    // Validaci√≥n en tiempo real
    const validacion = validarCodigoBarras(codigo);

    if (validacion.valido) {
      limpiarErrorCodigoBarras();
      $(this).removeClass('is-invalid').addClass('is-valid');
    } else if (codigo.length >= 8) {
      // Solo mostrar error si ya tiene suficientes caracteres
      $(this).removeClass('is-valid').addClass('is-invalid');
    } else {
      // Limpiar estados mientras escribe
      $(this).removeClass('is-valid is-invalid');
      limpiarErrorCodigoBarras();
    }
  });

  // Mostrar u ocultar los campos de rendimiento seg√∫n el valor seleccionado
  $('#maneja_rendimiento').on('change', function () {
    if ($(this).val() == '0') {
      $('#rendimientoEstimadoDiv').show();
      $('#rendimientoPacienteDiv').show();
      $("#rendimiento_estimado").attr("required", true);
      $("#rendimiento_paciente").attr("required", true);
    } else {
      $('#rendimientoEstimadoDiv').hide();
      $('#rendimientoPacienteDiv').hide();
      $("#rendimiento_estimado").val("");
      $("#rendimiento_paciente").val("");
      $("#rendimiento_estimado").removeAttr("required");
      $("#rendimiento_paciente").removeAttr("required");
      $("#rendimiento_estimado").removeClass("is-invalid");
      $("#rendimiento_paciente").removeClass("is-invalid");
    }
  });

  // Mostrar u ocultar los campos de inserto y procedimiento prueba seg√∫n el valor seleccionado
  $('#maneja_inserto').on('change', function () {
    if ($(this).val() == '0') {
      $("#insertoDiv").show();
      $("#protocoloDiv").show();
      $('#vistaPreviaInsertoCard').show();
    } else {
      $('#insertoDiv').hide();
      $('#protocoloDiv').hide();
      $("#insertoDiv").hide();
      $("#protocoloDiv").hide();
      $("#inserto").val("");
      $("#vistaPreviaInsertoCard").hide();
    }
  });

  // Ejecutar al cargar para el valor inicial
  $(document).ready(function () {
    $('#maneja_rendimiento').trigger('change');
    $('#maneja_inserto').trigger('change');
  });

  // NUEVO C√ìDIGO PARA VISTA PREVIA DEL PDF
  // Variables para vista previa del PDF
  let archivoPDFInserto = null;
  let urlPDFInserto = null;

  // Event listener para el campo de inserto - Vista previa
  $('#inserto').on('change', function (e) {
    const archivo = e.target.files[0];

    // Limpiar URL anterior si existe
    if (urlPDFInserto) {
      URL.revokeObjectURL(urlPDFInserto);
      urlPDFInserto = null;
    }

    // Limpiar vista previa
    limpiarVistaPrevia();

    if (archivo) {
      // Validar que sea un PDF
      if (archivo.type !== 'application/pdf') {
        alertToast("Solo se permiten archivos PDF", "error", 3000);
        $(this).val('');
        archivoPDFInserto = null;
        urlPDFInserto = null;
        deshabilitarBotonesPrevia();
        return;
      }

      // Validar tama√±o del archivo (m√°ximo 50MB)
      const maxSize = 50 * 1024 * 1024; // 50MB en bytes
      if (archivo.size > maxSize) {
        alertToast("El archivo PDF es demasiado grande (m√°ximo 50MB)", "error", 3000);
        $(this).val('');
        archivoPDFInserto = null;
        urlPDFInserto = null;
        deshabilitarBotonesPrevia();
        return;
      }

      // Almacenar archivo y crear URL temporal
      archivoPDFInserto = archivo;
      urlPDFInserto = URL.createObjectURL(archivo);

      // Verificar campos requeridos para habilitar vista previa
      verificarCamposParaPrevia();

      alertToast(`PDF cargado: ${archivo.name} (${(archivo.size / 1024 / 1024).toFixed(2)}MB)`, "success", 3000);
    } else {
      // Si no hay archivo, deshabilitar botones
      archivoPDFInserto = null;
      urlPDFInserto = null;
      deshabilitarBotonesPrevia();
    }
  });

  // Funci√≥n: Verificar campos requeridos para habilitar vista previa
  function verificarCamposParaPrevia() {
    const clave = $('#clave_art').val();
    const nombre_comercial = $('#nombre_comercial').val();

    if (archivoPDFInserto && clave && nombre_comercial) {
      habilitarBotonesPrevia();
    } else {
      deshabilitarBotonesPrevia();
    }
  }

  // Funci√≥n: Habilitar botones de vista previa
  function habilitarBotonesPrevia() {
    $('#verPreviaInserto')
      .prop('disabled', false)
      .removeClass('btn-outline-secondary')
      .addClass('btn-outline-primary');
  }

  // Funci√≥n: Deshabilitar botones de vista previa
  function deshabilitarBotonesPrevia() {
    $('#verPreviaInserto')
      .prop('disabled', true)
      .removeClass('btn-outline-primary')
      .addClass('btn-outline-secondary');

    $('#descargarInserto').addClass('d-none');
    $('#abrirNuevaVentana').addClass('d-none');
  }

  // Funci√≥n: Limpiar vista previa
  function limpiarVistaPrevia() {
    $('#pdfPreviewFrame').hide();
    $('#pdfInfoDisplay').empty();
    $('#pdfPreviewContainer small').show();
    $('#descargarInserto').addClass('d-none');
    $('#abrirNuevaVentana').addClass('d-none');
  }

  // Event: Verificar campos al cambiar clave o nombre
  $('#clave_art, #nombre_comercial').on('input', function () {
    verificarCamposParaPrevia();
  });

  // Event: Bot√≥n para ver vista previa del PDF
  $('#verPreviaInserto').click(function () {
    if (!archivoPDFInserto) {
      alertToast("Primero debe cargar un archivo PDF", "warning", 3000);
      return;
    }

    const clave = $('#clave_art').val();
    const nombre_comercial = $('#nombre_comercial').val();

    if (!clave || !nombre_comercial) {
      alertToast("La clave y nombre del art√≠culo son requeridos", "warning", 3000);
      return;
    }

    try {
      // Mostrar el PDF en el iframe
      const iframe = document.getElementById('pdfPreviewFrame');
      iframe.src = urlPDFInserto;

      // Mostrar el iframe y ocultar placeholder
      $('#pdfPreviewFrame').show();
      $('#pdfPreviewContainer small').hide();

      // Mostrar informaci√≥n del archivo
      $('#pdfInfoDisplay').html(`
        <strong>${clave}</strong><br>
        ${nombre_comercial}<br>
        <small class="text-danger">üìÑ ${archivoPDFInserto.name}</small><br>
        <small class="text-success">${(archivoPDFInserto.size / 1024 / 1024).toFixed(2)} MB</small>
      `);

      // Mostrar botones adicionales
      $('#descargarInserto').removeClass('d-none');
      $('#abrirNuevaVentana').removeClass('d-none');

      alertToast("Vista previa del PDF cargada", "success", 2000);

    } catch (error) {
      console.error('Error al mostrar vista previa:', error);
      alertToast("Error al mostrar la vista previa del PDF", "error", 3000);
    }
  });

  // Event: Bot√≥n para descargar el PDF
  $('#descargarInserto').click(function () {
    if (!urlPDFInserto || !archivoPDFInserto) {
      alertToast("No hay archivo PDF para descargar", "warning", 3000);
      return;
    }

    try {
      const clave = $('#clave_art').val();
      const link = document.createElement('a');
      link.href = urlPDFInserto;
      link.download = `Inserto_${clave}_${archivoPDFInserto.name}`;
      link.click();

      alertToast("Descarga del PDF iniciada", "success", 2000);
    } catch (error) {
      console.error('Error al descargar:', error);
      alertToast("Error al descargar el PDF", "error", 3000);
    }
  });

  // Event: Bot√≥n para abrir en nueva ventana
  $('#abrirNuevaVentana').click(function () {
    if (!urlPDFInserto) {
      alertToast("No hay archivo PDF para abrir", "warning", 3000);
      return;
    }

    try {
      const clave = $('#clave_art').val();
      const nombre_comercial = $('#nombre_comercial').val();

      // Abrir en nueva ventana con t√≠tulo personalizado
      const nuevaVentana = window.open(urlPDFInserto, '_blank',
        'width=800,height=600,scrollbars=yes,resizable=yes');

      if (nuevaVentana) {
        // Intentar cambiar el t√≠tulo de la ventana (limitado por seguridad del navegador)
        setTimeout(() => {
          try {
            nuevaVentana.document.title = `Inserto - ${clave} - ${nombre_comercial}`;
          } catch (e) {
            // Ignorar error de seguridad
          }
        }, 1000);

        alertToast("PDF abierto en nueva ventana", "success", 2000);
      } else {
        alertToast("No se pudo abrir la nueva ventana. Verifique que no est√© bloqueada por el navegador.", "warning", 4000);
      }
    } catch (error) {
      console.error('Error al abrir nueva ventana:', error);
      alertToast("Error al abrir el PDF en nueva ventana", "error", 3000);
    }
  });

  // AGREGAR: Variable para controlar si se debe reabrir el modal de art√≠culo
  let debeReabrirModalArticulo = false;

  // FUNCI√ìN para el bot√≥n de cat√°logo de marcas
  $("#btnCatalogoMarcas").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    debeReabrirModalArticulo = true;
    $("#editarArticuloModal").modal("hide");

    setTimeout(function () {
      $("#registrarCatalogoModal").modal("show");
      setTimeout(function () {
        $("#marcas-tab").tab("show");
        setTimeout(function () {
          $("#registrarMarcaModal").modal("show");
        }, 400);
      }, 300);
    }, 200);
  });

  // FUNCI√ìN para el bot√≥n de cat√°logo de sustancias
  $("#btnCatalogoSustancias").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    debeReabrirModalArticulo = true;
    $("#editarArticuloModal").modal("hide");

    setTimeout(function () {
      $("#registrarCatalogoModal").modal("show");
      setTimeout(function () {
        $("#sustancias-tab").tab("show");
        setTimeout(function () {
          $("#registrarSustanciaModal").modal("show");
        }, 400);
      }, 300);
    }, 200);
  });

  // FUNCI√ìN para el bot√≥n de cat√°logo de tipos
  $("#btnCatalogoTipos").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    debeReabrirModalArticulo = true;
    $("#editarArticuloModal").modal("hide");

    setTimeout(function () {
      $("#registrarCatalogoModal").modal("show");
      setTimeout(function () {
        $("#tipos-tab").tab("show");
        setTimeout(function () {
          $("#registrarTipoModal").modal("show");
        }, 400);
      }, 300);
    }, 200);
  });

  // FUNCI√ìN para el bot√≥n de cat√°logo de unidades
  $("#btnCatalogoUnidades").click(function (e) {
    e.preventDefault();
    e.stopPropagation();

    debeReabrirModalArticulo = true;
    $("#editarArticuloModal").modal("hide");

    setTimeout(function () {
      $("#registrarCatalogoModal").modal("show");
      setTimeout(function () {
        $("#unidades-tab").tab("show");
        setTimeout(function () {
          $("#registrarUnidadModal").modal("show");
        }, 400);
      }, 300);
    }, 200);
  });

  // FUNCI√ìN para el bot√≥n de nuevo proveedor
  $("#btnNuevoProveedor").click(function (e) {
    e.preventDefault();
    e.stopPropagation();
    debeReabrirModalArticulo = true;

    $("#editarArticuloModal").modal("hide");
    setTimeout(function () {
      $("#registrarCatalogoModal").modal("show");
      setTimeout(function () {
        $("#proveedores-tab").tab("show");
        setTimeout(function () {
          $("#registrarProveedorModal").modal("show");
        }, 400);
      }, 300);
    }, 200);
  });

  // Event listener para cuando se cierra el modal de cat√°logo
  $("#registrarCatalogoModal").on("hidden.bs.modal", function () {
    if (debeReabrirModalArticulo) {
      setTimeout(function () {
        $("#editarArticuloModal").modal("show");
        setTimeout(function () {
          cargarMarcas();
          cargarSustancias();
          cargarTipos();
          cargarUnidades();
          cargarProveedoresArticulo();
        }, 300);
      }, 200);
      debeReabrirModalArticulo = false;
    }
  });

  // Resetear bandera si el usuario cancela manualmente
  $("#editarArticuloModal .btn-cancelar, #editarArticuloModal .btn-close").click(function () {
    debeReabrirModalArticulo = false;
  });

  // FUNCI√ìN PARA CARGAR PROVEEDORES
  function cargarProveedoresArticulo() {
    console.log("Cargando proveedores para el modal de editar...");
    
    $.ajax({
      url: "../../../api/inventarios_api.php",
      type: "POST",
      dataType: "json",
      data: { api: 16 },
      success: function (response) {
        console.log("Respuesta API 16 proveedores:", response);
        
        if (response.response?.code == 1) {
          let selectElement = $("#id_proveedores");
          let valorActual = selectElement.val();

          selectElement.empty().append(`<option value="">Seleccione un proveedor</option>`);

          if (response.response.data && response.response.data.length > 0) {
            response.response.data.forEach(item => {
              console.log("Proveedor item:", item);
              // Usar los nombres de campo correctos del API
              let id = item.id_proveedores || item.ID_PROVEEDORES;
              let nombre = item.nombre || item.NOMBRE;
              
              if (id && nombre) {
                selectElement.append(`<option value="${id}">${nombre}</option>`);
              }
            });

            if (valorActual) selectElement.val(valorActual);
            
            // Actualizar opciones disponibles
            actualizarOpcionesProveedores();
            
            console.log("Proveedores cargados exitosamente:", response.response.data.length, "elementos");
          } else {
            console.warn("No se encontraron proveedores en la respuesta");
          }
        } else {
          console.error("Error al cargar proveedores:", response);
          alertToast("Error al cargar proveedores", "error", 3000);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error AJAX al cargar proveedores:", error);
        console.error("Response text:", xhr.responseText);
        alertToast("Error de conexi√≥n al cargar proveedores", "error", 3000);
      }
    });
  }

  // FUNCI√ìN PARA CARGAR MARCAS
  function cargarMarcas() {
    console.log("Cargando marcas para el modal de editar...");
    
    $.ajax({
      url: "../../../api/inventarios_api.php",
      type: "POST",
      dataType: "json",
      data: { api: 9 }, // API para marcas
      success: function (response) {
        console.log("Respuesta API 9 marcas:", response);
        
        if (response.response?.code == 1) {
          let selectElement = $("#id_marcas");
          let valorActual = selectElement.val();

          selectElement.empty().append(`<option value="">Seleccione una marca</option>`);

          if (response.response.data && response.response.data.length > 0) {
            response.response.data.forEach(item => {
              console.log("Marca item:", item);
              // Usar los nombres de campo correctos del API
              let id = item.id_marcas || item.ID_MARCAS;
              let nombre = item.descripcion || item.DESCRIPCION || item.nombre || item.NOMBRE;
              
              if (id && nombre) {
                selectElement.append(`<option value="${id}">${nombre}</option>`);
              }
            });

            if (valorActual) selectElement.val(valorActual);
            
            console.log("Marcas cargadas exitosamente:", response.response.data.length, "elementos");
          } else {
            console.warn("No se encontraron marcas en la respuesta");
          }
        } else {
          console.error("Error al cargar marcas:", response);
          alertToast("Error al cargar marcas", "error", 3000);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error AJAX al cargar marcas:", error);
        console.error("Response text:", xhr.responseText);
        alertToast("Error de conexi√≥n al cargar marcas", "error", 3000);
      }
    });
  }

  // FUNCI√ìN PARA CARGAR SUSTANCIAS
  function cargarSustancias() {
    console.log("Cargando sustancias para el modal de editar...");
    
    $.ajax({
      url: "../../../api/inventarios_api.php",
      type: "POST",
      dataType: "json",
      data: { api: 37 }, // API para sustancias activas
      success: function (response) {
        console.log("Respuesta API 37 sustancias:", response);
        
        if (response.response?.code == 1) {
          let selectElement = $("#id_sustancia");
          let valorActual = selectElement.val();

          selectElement.empty().append(`<option value="">Seleccione una sustancia activa</option>`);

          if (response.response.data && response.response.data.length > 0) {
            response.response.data.forEach(item => {
              console.log("Sustancia item:", item);
              // Usar los nombres de campo correctos del API
              let id = item.ID_SUSTANCIA || item.id_sustancia;
              let nombre = item.NOMBRE || item.nombre;
              
              if (id && nombre) {
                selectElement.append(`<option value="${id}">${nombre}</option>`);
              }
            });

            if (valorActual) selectElement.val(valorActual);
            
            console.log("Sustancias cargadas exitosamente:", response.response.data.length, "elementos");
          } else {
            console.warn("No se encontraron sustancias en la respuesta");
          }
        } else {
          console.error("Error al cargar sustancias:", response);
          alertToast("Error al cargar sustancias", "error", 3000);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error AJAX al cargar sustancias:", error);
        console.error("Response text:", xhr.responseText);
        alertToast("Error de conexi√≥n al cargar sustancias", "error", 3000);
      }
    });
  }

  // FUNCI√ìN PARA CARGAR TIPOS
  function cargarTipos() {
    // Los tipos est√°n hardcodeados en el HTML, no necesita carga din√°mica
  }

  // FUNCI√ìN PARA CARGAR UNIDADES
  function cargarUnidades() {
    // Las unidades est√°n hardcodeadas en el HTML, no necesita carga din√°mica
  }

  // FUNCI√ìN GEN√âRICA PARA CARGAR CAT√ÅLOGOS
  function cargarCatalogoEnModal(selectorSelect, opciones) {
    $.ajax({
      url: "../../../api/inventarios_api.php",
      type: "POST",
      dataType: "json",
      data: { api: opciones.api },
      success: function (response) {
        if (response.response?.code == 1) {
          let selectElement = $(selectorSelect);
          let valorActual = selectElement.val();

          selectElement.empty().append(`<option value="">${opciones.placeholder}</option>`);

          response.response.data.forEach(item => {
            selectElement.append(`<option value="${item[opciones.campoId]}">${item[opciones.campoTexto]}</option>`);
          });

          if (valorActual) selectElement.val(valorActual);

          // Si es el select de proveedores, actualizar opciones disponibles
          if (selectorSelect === "#id_proveedores") {
            actualizarOpcionesProveedores();
          }
        } else {
          console.error(`Error al cargar ${opciones.placeholder}:`, response);
          alertToast(`Error al cargar ${opciones.placeholder}`, "error", 3000);
        }
      },
      error: function (xhr, status, error) {
        console.error("Error AJAX:", error);
        alertToast(`Error de conexi√≥n al cargar ${opciones.placeholder}`, "error", 3000);
      }
    });
  }

  // ===== SISTEMA DE TAGS PARA M√öLTIPLES PROVEEDORES =====

  // Array para almacenar proveedores seleccionados
  let proveedoresSeleccionados = [];

  // Funci√≥n para agregar proveedor como tag
  function agregarProveedorTag(id, nombre) {
    // Verificar si ya est√° seleccionado
    if (proveedoresSeleccionados.find(p => p.id === id)) {
      alertToast("Este proveedor ya est√° seleccionado", "warning", 2000);
      return;
    }

    // Agregar a la lista
    const esPrimero = proveedoresSeleccionados.length === 0;
    proveedoresSeleccionados.push({
      id: id,
      nombre: nombre,
      principal: esPrimero
    });

    // Actualizar UI
    actualizarTagsProveedores();
    actualizarOpcionesProveedores();
    actualizarJSONProveedores();

    // Limpiar select
    $("#id_proveedores").val("");

    alertToast(`Proveedor "${nombre}" agregado${esPrimero ? ' como principal' : ''}`, "success", 2000);
  }

  // Funci√≥n para quitar proveedor tag
  function quitarProveedorTag(id) {
    const index = proveedoresSeleccionados.findIndex(p => p.id === id);
    if (index === -1) return;

    const proveedor = proveedoresSeleccionados[index];
    const eraPrincipal = proveedor.principal;

    // Quitar de la lista
    proveedoresSeleccionados.splice(index, 1);

    // Si era principal y hay m√°s proveedores, hacer principal al primero
    if (eraPrincipal && proveedoresSeleccionados.length > 0) {
      proveedoresSeleccionados[0].principal = true;
    }

    // Actualizar UI
    actualizarTagsProveedores();
    actualizarOpcionesProveedores();
    actualizarJSONProveedores();

    alertToast(`Proveedor "${proveedor.nombre}" eliminado`, "info", 2000);
  }

  // Funci√≥n para hacer proveedor principal
  function hacerProveedorPrincipal(id) {
    // Quitar principal de todos
    proveedoresSeleccionados.forEach(p => p.principal = false);

    // Hacer principal al seleccionado
    const proveedor = proveedoresSeleccionados.find(p => p.id === id);
    if (proveedor) {
      proveedor.principal = true;

      // Mover al principio del array
      const index = proveedoresSeleccionados.indexOf(proveedor);
      proveedoresSeleccionados.splice(index, 1);
      proveedoresSeleccionados.unshift(proveedor);

      // Actualizar UI
      actualizarTagsProveedores();
      actualizarJSONProveedores();

      alertToast(`"${proveedor.nombre}" es ahora el proveedor principal`, "success", 2000);
    }
  }

  // Funci√≥n para actualizar la vista de tags
  function actualizarTagsProveedores() {
    const container = $("#proveedoresTagsArea");
    const placeholder = $("#proveedoresPlaceholder");

    if (proveedoresSeleccionados.length === 0) {
      placeholder.show();
      container.empty().append(placeholder);
      return;
    }

    placeholder.hide();
    container.empty();

    proveedoresSeleccionados.forEach(proveedor => {
      const isPrincipal = proveedor.principal;
      const tagClass = isPrincipal ? 'proveedor-tag principal' : 'proveedor-tag';
      const iconClass = isPrincipal ? 'bi-star-fill' : 'bi-star';
      const titleText = isPrincipal ? 'Proveedor principal - Click para cambiar' : 'Click para hacer principal';

      const tag = $(`
        <div class="${tagClass}">
          <i class="${iconClass}" title="${titleText}"></i>
          <span class="proveedor-nombre">${proveedor.nombre}</span>
          <button type="button" class="btn-close-tag" 
                  onclick="quitarProveedorTag('${proveedor.id}')" 
                  title="Eliminar proveedor">
            <i class="bi bi-x"></i>
          </button>
        </div>
      `);

      // Click en el icono de estrella para hacer principal
      tag.find('.bi-star, .bi-star-fill').click(function (e) {
        e.preventDefault();
        e.stopPropagation();
        if (!isPrincipal) {
          hacerProveedorPrincipal(proveedor.id);
        }
      });

      container.append(tag);
    });
  }

  // Funci√≥n para actualizar opciones disponibles en el select
  function actualizarOpcionesProveedores() {
    const select = $("#id_proveedores");
    const options = select.find('option');

    options.each(function () {
      const optionValue = $(this).val();
      const isSelected = proveedoresSeleccionados.find(p => p.id === optionValue);

      if (optionValue && isSelected) {
        $(this).hide();
      } else {
        $(this).show();
      }
    });
  }

  // Funci√≥n para actualizar el JSON hidden
  function actualizarJSONProveedores() {
    const json = JSON.stringify(proveedoresSeleccionados.map(p => ({
      id: p.id,
      principal: p.principal ? "1" : "0"
    })));

    $("#proveedores_json").val(json);
  }

  // Event listener para selecci√≥n de proveedor
  $("#id_proveedores").on("change", function () {
    const selectedId = $(this).val();
    const selectedName = $(this).find("option:selected").text();

    if (selectedId && selectedName !== "Seleccione un proveedor") {
      agregarProveedorTag(selectedId, selectedName);
    }
  });

  // Funci√≥n para limpiar proveedores
  function limpiarProveedores() {
    proveedoresSeleccionados = [];
    actualizarTagsProveedores();
    actualizarOpcionesProveedores();
    actualizarJSONProveedores();
  }

  // Funci√≥n para cargar proveedores existentes de un art√≠culo (para edici√≥n)
  function cargarProveedoresExistentes(idArticulo) {
    if (!idArticulo) {
      limpiarProveedores();
      return;
    }

    // Usar los datos de rowSelected.PROVEEDORES en lugar de hacer otra llamada AJAX
    if (window.rowSelected && window.rowSelected.PROVEEDORES) {
      console.log("Cargando proveedores desde rowSelected:", window.rowSelected.PROVEEDORES);
      
      // Limpiar proveedores actuales
      limpiarProveedores();

      // Los proveedores vienen separados por "|" en el string
      const proveedoresString = window.rowSelected.PROVEEDORES;
      
      if (proveedoresString && proveedoresString !== "Sin proveedor" && proveedoresString.trim() !== "") {
        const proveedoresArray = proveedoresString.split("|").filter(p => p.trim() !== "");
        
        proveedoresArray.forEach((nombreProveedor, index) => {
          // Buscar el ID del proveedor en el select
          const proveedorOption = $("#id_proveedores option").filter(function() {
            return $(this).text().trim() === nombreProveedor.trim();
          });
          
          if (proveedorOption.length > 0) {
            const proveedorId = proveedorOption.val();
            const esPrincipal = index === 0; // El primer proveedor es principal
            
            proveedoresSeleccionados.push({
              id: proveedorId,
              nombre: nombreProveedor.trim(),
              principal: esPrincipal
            });
          } else {
            console.warn(`No se encontr√≥ ID para el proveedor: ${nombreProveedor}`);
          }
        });

        // Asegurar que hay al menos un proveedor principal
        if (proveedoresSeleccionados.length > 0) {
          const hasPrincipal = proveedoresSeleccionados.some(p => p.principal);
          if (!hasPrincipal) {
            proveedoresSeleccionados[0].principal = true;
          }
        }

        // Actualizar UI
        actualizarTagsProveedores();
        actualizarOpcionesProveedores();
        actualizarJSONProveedores();
        
        console.log("Proveedores cargados:", proveedoresSeleccionados);
      } else {
        console.log("No hay proveedores para este art√≠culo");
        limpiarProveedores();
      }
    } else {
      // Fallback: usar API si no hay datos en rowSelected
      console.log("Intentando cargar proveedores usando API 42...");
      
      $.ajax({
        url: "../../../api/inventarios_api.php",
        type: "POST",
        dataType: "json",
        data: {
          api: 42,
          id_articulo: idArticulo
        },
        success: function (response) {
          if (response.response?.code == 1 && response.response.data) {
            // Limpiar proveedores actuales
            limpiarProveedores();

            // Cargar proveedores existentes
            response.response.data.forEach(proveedor => {
              const esPrincipal = proveedor.principal === "1" || proveedor.principal === 1;

              proveedoresSeleccionados.push({
                id: proveedor.id.toString(),
                nombre: proveedor.nombre,
                principal: esPrincipal
              });
            });

            // Asegurar que hay al menos un proveedor principal
            if (proveedoresSeleccionados.length > 0) {
              const hasPrincipal = proveedoresSeleccionados.some(p => p.principal);
              if (!hasPrincipal) {
                proveedoresSeleccionados[0].principal = true;
              }
            }

            // Actualizar UI
            actualizarTagsProveedores();
            actualizarOpcionesProveedores();
            actualizarJSONProveedores();
          } else {
            limpiarProveedores();
          }
        },
        error: function (xhr, status, error) {
          console.error("Error al cargar proveedores del art√≠culo:", error);
          alertToast("Error al cargar proveedores del art√≠culo", "error", 3000);
          limpiarProveedores();
        }
      });
    }
  }

  // Funci√≥n para configurar modal en modo edici√≥n
  function configurarModalEdicion(idArticulo) {
    if (idArticulo) {
      // Cargar proveedores despu√©s de un peque√±o delay para asegurar que el select est√° poblado
      setTimeout(() => {
        cargarProveedoresExistentes(idArticulo);
      }, 100);
    } else {
      limpiarProveedores();
    }
  }

  // Modificar: Limpiar todo al cerrar modal
  $('#editarArticuloModal').on('hidden.bs.modal', function () {
    // Limpiar vista previa
    limpiarVistaPrevia();

    // Limpiar variables de PDF y liberar memoria
    if (urlPDFInserto) {
      URL.revokeObjectURL(urlPDFInserto);
    }
    archivoPDFInserto = null;
    urlPDFInserto = null;

    // Deshabilitar botones
    deshabilitarBotonesPrevia();

    // Limpiar validaciones de c√≥digo de barras
    limpiarErrorCodigoBarras();

    // Limpiar proveedores
    limpiarProveedores();
  });

  // Inicializar: Cargar cat√°logos al cargar el documento
  $(document).ready(function () {
    cargarMarcas();
    cargarSustancias();
    cargarProveedoresArticulo();
    deshabilitarBotonesPrevia();
  });

  // Exposer funciones globalmente para que otros scripts las puedan usar
  window.configurarModalEdicion = configurarModalEdicion;
  window.limpiarProveedores = limpiarProveedores;
  window.cargarProveedoresExistentes = cargarProveedoresExistentes;
</script>

<!-- Asegurar que las librer√≠as est√©n incluidas -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
