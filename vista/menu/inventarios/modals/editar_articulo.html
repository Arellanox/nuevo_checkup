<div
  class="modal fade"
  id="editarArticuloModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-focus="false"
  data-bs-keyboard="false"
  role="dialog"
  aria-labelledby="modalTitleId"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleArticuloEditar">
          Editar <strong>Artículo</strong>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body container-fluid">
        <div class="container-fluid">
          <div class="row">
            <form id="editarArticuloForm" name="editarArticuloForm">
              <div class="col-12">
                <div class="text-start">
                  <div class="shadow-sm rounded p-3 card-body">
                    <h5 class="text-dark">Edita los siguientes datos</h5>

                    <!-- Sección 1: Información General -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Información General</h6>
                        <div class="row">
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="clave_art" class="form-label"
                                >Código</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="clave_art"
                                name="clave_art"
                                required
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Ingrese el código único del artículo.</small
                              >
                            </div>
                            <div class="mb-3">
                              <label for="nombre_comercial" class="form-label"
                                >Nombre Comercial</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="nombre_comercial"
                                name="nombre_comercial"
                                required
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Ingrese el nombre comercial del
                                artículo.</small
                              >
                            </div>
                            <div class="mb-3">
                              <label for="id_marcas" class="form-label"
                                >Marca</label
                              >
                              <select
                                class="form-select input-form"
                                id="id_marcas"
                                name="id_marcas"
                                required
                              >
                                <option value="">Seleccione una marca</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione la marca del artículo.</small
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Sección 2: Configuración del Artículo -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Configuración del Artículo</h6>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="estatus" class="form-label"
                                >Estatus</label
                              >
                              <div class="form-check form-switch">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  name="estatus"
                                  id="estatus"
                                />
                              </div>
                              <small class="form-text text-muted"
                                >Indica si el artículo está activo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="red_frio" class="form-label"
                                >Red Frío</label
                              >
                              <select
                                class="form-select input-form"
                                id="red_frio"
                                name="red_frio"
                              >
                                <option value="1">Sí</option>
                                <option value="0">No</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el artículo requiere red
                                frío.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="tipo_articulo" class="form-label"
                                >Tipo Descripción</label
                              >
                              <select
                                class="form-select tipo_articulo input-form"
                                id="tipo_articulo"
                                name="tipo_articulo"
                                required
                              >
                                <option value="">Seleccione un tipo</option>
                                <option value="1">Reactivo</option>
                                <option value="2">Insumo</option>
                                <option value="3">Medicamento</option>
                                <option value="4">Otro</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione el tipo de descripción del
                                artículo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="area_id" class="form-label"
                                >Área</label
                              >
                              <select
                                class="form-select input-form"
                                id="area_id"
                                name="area_id"
                                required
                              >
                                <option value="">Seleccione un área</option>
                                <option value="1">Checkup</option>
                                <option value="2">Laboratorio clínico</option>
                                <option value="3">
                                  Laboratorio biomolecular
                                </option>
                                <option value="4">Administración</option>
                                <option value="5">Recepción</option>
                                <option value="6">Toma de muestras</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione a qué área pertenece el
                                artículo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="maneja_caducidad" class="form-label"
                                >Maneja Caducidad</label
                              >
                              <select
                                class="form-select input-form"
                                id="maneja_caducidad"
                                name="maneja_caducidad"
                              >
                                <option value="1">Sí</option>
                                <option value="0">No</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el artículo maneja
                                caducidad.</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-6"
                            id="fechaCaducidadDiva"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label for="fecha_caducidad" class="form-label"
                                >Fecha de Caducidad</label
                              >
                              <input
                                type="date"
                                class="form-control input-form"
                                id="fecha_caducidad"
                                name="fecha_caducidad"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Ingrese la fecha de caducidad del
                                artículo.</small
                              >
                            </div>
                          </div>
                          <!-- Campos que aparecen en lotes -->
                          <div id="lotesFields">
                            <div class="row">
                              <div class="col-md-12">
                                <div class="mb-3">
                                  <label for="numero_lote" class="form-label"
                                    >Número de Lote</label
                                  >
                                  <input
                                    type="text"
                                    class="form-control input-form"
                                    id="numero_lote"
                                    name="numero_lote"
                                  />
                                  <small class="form-text text-muted"
                                    >Ingrese el número de lote del
                                    producto.</small
                                  >
                                </div>
                              </div>
                              <!-- <div class="col-md-6">
                                    <div class="mb-3">
                                    <label for="fecha_lote" class="form-label">Fecha de Lote</label>
                                    <input type="date" class="form-control input-form" id="fecha_lote" name="fecha_lote">
                                    <small class="form-text text-muted">Ingrese la fecha de fabricación del lote.</small>
                                    </div>
                                </div> -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Sección 3: Detalles del Artículo -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Detalles del Artículo</h6>
                        <div class="row">
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="unidad_venta" class="form-label"
                                >Unidad de Venta</label
                              >
                              <select
                                class="form-select input-form"
                                id="unidad_venta"
                                name="unidad_venta"
                                required
                              >
                                <option value="">Seleccione una unidad</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione la unidad de venta del
                                artículo.</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="unidad_minima" class="form-label"
                                >Stock Mínimo (Opcional)</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="unidad_minima"
                                name="unidad_minima"
                              />
                              <div class="invalid-feedback">
                                Este campo es opcional.
                              </div>
                              <small class="form-text text-muted"
                                >Cantidad mínima que debe mantenerse en
                                inventario antes de reabastecer.</small
                              >
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="contenido" class="form-label"
                                >Especificaciones del Producto</label
                              >
                              <input
                                type="text"
                                class="form-control input-form"
                                id="contenido"
                                name="contenido"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Detalles específicos del contenido (ej: "100ml
                                por frasco", "50 tiras por caja", etc.).</small
                              >
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="maneja_rendimiento" class="form-label"
                                >Maneja Rendimiento</label
                              >
                              <select
                                class="form-select input-form"
                                id="maneja_rendimiento"
                                name="maneja_rendimiento"
                              >
                                <option value="1">No</option>
                                <option value="0">Sí</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el artículo maneja
                                rendimiento.</small
                              >
                            </div>
                          </div>

                          <div class="col-6">
                            <div class="mb-3">
                              <label for="maneja_inserto" class="form-label"
                                >Maneja Inserto y Protocolo</label
                              >
                              <select
                                class="form-select input-form"
                                id="maneja_inserto"
                                name="maneja_inserto"
                              >
                                <option value="1">No</option>
                                <option value="0">Sí</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione si el artículo maneja inserto y
                                protocolo.</small
                              >
                            </div>
                          </div>
                          <!-- Proveedor y rendimiento
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="id_proveedores" class="form-label"
                                >Proveedor</label
                              >
                              <select
                                class="form-select input-form"
                                id="id_proveedores"
                                name="id_proveedores"
                                required
                              >
                                <option value="">Seleccione un área</option>
                                <option value="1">Farmacias Guadalajara</option>
                                <option value="2">Farmacias Similares</option>
                              </select>
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Seleccione que proveedor surte el
                                artículo.</small
                              >
                            </div>
                          </div>-->
                          <div
                            class="col-12"
                            id="rendimientoEstimadoDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label
                                for="rendimiento_estimado"
                                class="form-label"
                                >Rendimiento Estimado (pruebas)</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="rendimiento_estimado"
                                name="rendimiento_estimado"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Pruebas efectivas según proveedor</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-12"
                            id="rendimientoPacienteDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label
                                for="rendimiento_paciente"
                                class="form-label"
                                >Rendimiento Paciente (pruebas)</label
                              >
                              <input
                                type="number"
                                class="form-control input-form"
                                id="rendimiento_paciente"
                                name="rendimiento_paciente"
                              />
                              <small class="form-text text-muted"
                                >Pruebas efectivas reales</small
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Sección 4: Documentos -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Documentos</h6>
                        <div class="row">
                          <div
                            class="col-12"
                            id="insertoDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label for="inserto" class="form-label"
                                >Inserto</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="inserto"
                                name="inserto[]"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte el inserto del artículo.</small
                              >
                            </div>
                          </div>
                          <div
                            class="col-12"
                            id="protocoloDiv"
                            style="display: none"
                          >
                            <div class="mb-3">
                              <label for="procedimiento" class="form-label"
                                >Procedimiento Prueba</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="procedimiento"
                                name="procedimiento[]"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte el procedimiento de prueba del
                                artículo.</small
                              >
                            </div>
                          </div>
                          <div class="col-12">
                            <div class="mb-3">
                              <label for="img_producto" class="form-label"
                                >Imagen</label
                              >
                              <input
                                type="file"
                                class="form-control input-form"
                                id="img_producto"
                                name="img_producto[]"
                              />
                              <div class="invalid-feedback">
                                Este campo es obligatorio.
                              </div>
                              <small class="form-text text-muted"
                                >Adjunte la imagen del artículo.</small
                              >
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Sección 5: Códigos de Identificación -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Identificación del Producto</h6>
                        <div class="row">
                          <!-- Código de barras -->
                          <div class="col-6">
                            <div class="mb-3">
                              <label for="codigo_barras" class="form-label"
                                >Código de Barras</label
                              >
                              <div class="input-group">
                                <input
                                  type="text"
                                  class="form-control input-form"
                                  id="codigo_barras"
                                  name="codigo_barras"
                                  placeholder="Ingrese el código de barras manualmente"
                                  style="height: 38px"
                                />
                                <button
                                  class="btn btn-outline-secondary d-flex align-items-center"
                                  type="button"
                                  id="limpiarCodigoBarra"
                                  title="Limpiar código"
                                  style="
                                    height: 38px;
                                    padding-top: 0;
                                    padding-bottom: 0;
                                  "
                                >
                                  <i class="bi bi-x-lg"></i>
                                </button>
                              </div>
                              <!-- El div para mensajes de error se agregará dinámicamente -->

                              <div class="d-flex gap-3 mt-2 flex-wrap">
                                <!-- <button class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center" type="button" id="generarCodigoBarras" style="width: 97px;">
                                <i class="bi bi-upc-scan fs-5"></i>
                                <span class="mt-1">Mostrar</span>
                              </button> -->
                                <button
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                  type="button"
                                  id="leerCodigoBarras"
                                  style="width: 97px"
                                >
                                  <i class="bi bi-upc-scan fs-5"></i>
                                  <span class="mt-1">Escanear</span>
                                </button>
                                <button
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center"
                                  type="button"
                                  id="generarQr"
                                  style="width: 97px"
                                >
                                  <i class="bi bi-qr-code fs-5"></i>
                                  <span class="mt-1">Generar QR</span>
                                </button>
                              </div>
                              <div class="d-flex gap-3 mt-2 flex-wrap">
                                <button
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                  type="button"
                                  id="descargarQRIMG"
                                  style="width: 97px"
                                >
                                  <i class="bi bi-filetype-png fs-5"></i>
                                  <span class="mt-1">Descargar Imagen</span>
                                </button>
                                <button
                                  id="descargarQRpdf"
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                  type="button"
                                  style="width: 97px"
                                >
                                  <i class="bi bi-filetype-pdf fs-5"></i>
                                  <span class="mt-1">Descargar PDF</span>
                                </button>
                                <button
                                  id="imprimirQRpdf"
                                  class="btn btn-outline-secondary btn-sm d-flex flex-column align-items-center d-none"
                                  type="button"
                                  style="width: 97px"
                                >
                                  <i class="bi bi-file-earmark-pdf fs-5"></i>
                                  <span class="mt-1">Imprimir PDF</span>
                                </button>
                              </div>

                              <!-- AGREGAR ESTE CONTENEDOR PARA EL CÓDIGO DE BARRAS VISUAL
                            <div id="codigoBarrasContainer" class="mt-3" style="display: none;">
                              <div class="border p-3 rounded text-center bg-light">
                                <h6>Código de Barras:</h6>
                                <canvas id="codigoBarras" class="mb-2"></canvas>
                                <div id="codigoBarrasTexto" class="fw-bold"></div>
                              </div>
                            </div>
                            
                            <small class="form-text text-muted">
                              Formatos soportados: EAN13 (13 dígitos), EAN8 (8 dígitos), UPC (12 dígitos), CODE128, CODE39
                            </small> -->
                            </div>
                          </div>
                          <!-- Visualización del QR -->
                          <div class="col-6">
                            <div class="h-100 d-flex flex-column">
                              <div
                                id="qrCodePreview"
                                class="border p-3 rounded flex-grow-1 d-flex align-items-center justify-content-center flex-column"
                                style="min-height: 150px"
                              >
                                <small class="text-muted text-center"
                                  >El código QR aparecerá aquí</small
                                >
                                <!-- Este div contendrá el QR -->
                                <div id="qrCodeContainers" class="mb-2"></div>
                                <!-- Este div mostrará la clave y nombre -->
                                <div
                                  id="qrClaveDisplays"
                                  class="fw-bold text-center"
                                  style="font-size: 1.1rem"
                                ></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">
          <i class="bi bi-arrow-left-short"></i> Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-confirmar"
          form="editarArticuloForm"
        >
          <i class="bi bi-pencil-square"></i> Editar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  // Función para generar y mostrar el código de barras visual
  function mostrarCodigoBarras(codigo) {
    if (!codigo || codigo.trim() === "") {
      document.getElementById("codigoBarrasContainer").style.display = "none";
      return;
    }

    try {
      document.getElementById("codigoBarrasContainer").style.display = "block";

      JsBarcode("#codigoBarras", codigo, {
        format: "CODE128",
        width: 2,
        height: 60,
        displayValue: true,
        fontSize: 12,
        textMargin: 5,
        background: "#ffffff",
        lineColor: "#000000",
      });

      document.getElementById("codigoBarrasTexto").textContent = codigo;
    } catch (error) {
      console.error("Error al generar código de barras:", error);
      document.getElementById("codigoBarrasTexto").textContent =
        "Código: " + codigo;
    }
  }

  function detectarFormatoCodigo(codigo) {
    if (/^\d{13}$/.test(codigo)) {
      return "EAN13";
    } else if (/^\d{12}$/.test(codigo)) {
      return "UPC";
    } else if (/^\d{8}$/.test(codigo)) {
      return "EAN8";
    } else {
      return "CODE128";
    }
  }

  // Función para validar código de barras
  function validarCodigoBarras(codigo) {
    // Remover espacios en blanco
    codigo = codigo.replace(/\s/g, "");

    // Validaciones para diferentes formatos con límites exactos
    const validaciones = {
      EAN13: {
        regex: /^\d{13}$/,
        maxLength: 13,
        minLength: 13,
        caracteresPermitidos: /^[0-9]*$/,
        nombre: "EAN13",
      },
      EAN8: {
        regex: /^\d{8}$/,
        maxLength: 8,
        minLength: 8,
        caracteresPermitidos: /^[0-9]*$/,
        nombre: "EAN8",
      },
      UPC: {
        regex: /^\d{12}$/,
        maxLength: 12,
        minLength: 12,
        caracteresPermitidos: /^[0-9]*$/,
        nombre: "UPC",
      },
      CODE128: {
        regex: /^[0-9A-Za-z\-\.\ \_\$\/\+\%]{1,48}$/,
        maxLength: 48,
        minLength: 1,
        caracteresPermitidos: /^[0-9A-Za-z\-\.\ \_\$\/\+\%]*$/,
        nombre: "CODE128",
      },
      CODE39: {
        regex: /^[0-9A-Z\-\.\ \$\/\+\%]{1,32}$/,
        maxLength: 32,
        minLength: 1,
        caracteresPermitidos: /^[0-9A-Z\-\.\ \$\/\+\%]*$/,
        nombre: "CODE39",
      },
    };

    // Verificar longitud exacta para formatos numéricos
    if (codigo.length === 13 && validaciones.EAN13.regex.test(codigo)) {
      return { valido: true, formato: "EAN13", codigo: codigo };
    } else if (codigo.length === 8 && validaciones.EAN8.regex.test(codigo)) {
      return { valido: true, formato: "EAN8", codigo: codigo };
    } else if (codigo.length === 12 && validaciones.UPC.regex.test(codigo)) {
      return { valido: true, formato: "UPC", codigo: codigo };
    } else if (
      validaciones.CODE128.caracteresPermitidos.test(codigo) &&
      codigo.length >= validaciones.CODE128.minLength &&
      codigo.length <= validaciones.CODE128.maxLength
    ) {
      return { valido: true, formato: "CODE128", codigo: codigo };
    } else if (
      validaciones.CODE39.caracteresPermitidos.test(codigo) &&
      codigo.length >= validaciones.CODE39.minLength &&
      codigo.length <= validaciones.CODE39.maxLength
    ) {
      return { valido: true, formato: "CODE39", codigo: codigo };
    } else {
      return { valido: false, formato: null, codigo: codigo };
    }
  }

  // Función para detectar el formato probable basado en la longitud actual
  function detectarFormatoProbable(codigo) {
    codigo = codigo.replace(/\s/g, "");

    if (/^\d+$/.test(codigo)) {
      if (codigo.length <= 8) return "EAN8";
      if (codigo.length <= 12) return "UPC";
      if (codigo.length <= 13) return "EAN13";
    }

    if (/^[0-9A-Za-z\-\.\ \_\$\/\+\%]*$/.test(codigo)) {
      if (codigo.length <= 32) return "CODE39";
      if (codigo.length <= 48) return "CODE128";
    }

    return "CODE128"; // Por defecto
  }

  // Función para obtener el límite máximo según el formato detectado
  function obtenerLimiteCaracteres(codigo) {
    const formato = detectarFormatoProbable(codigo);

    const limites = {
      EAN8: 8,
      UPC: 12,
      EAN13: 13,
      CODE39: 32,
      CODE128: 48,
    };

    return limites[formato] || 48;
  }

  // Event listener para validar y limitar caracteres en tiempo real
  $("#editarArticuloForm #codigo_barras").on("input", function (e) {
    let codigo = $(this).val();
    const cursorPos = this.selectionStart;

    // Obtener el límite según el formato detectado
    const limite = obtenerLimiteCaracteres(codigo);

    // Limitar longitud
    if (codigo.length > limite) {
      codigo = codigo.substring(0, limite);
      $(this).val(codigo);
      // Restaurar posición del cursor
      this.setSelectionRange(
        Math.min(cursorPos, limite),
        Math.min(cursorPos, limite)
      );
    }

    // Si está vacío, limpiar errores y NO mostrar código de barras
    if (codigo.trim() === "") {
      limpiarErrorCodigoBarras();
      return;
    }

    // Detectar formato probable para dar feedback
    const formatoProbable = detectarFormatoProbable(codigo);
    const limiteActual = obtenerLimiteCaracteres(codigo);

    // Validar caracteres permitidos según el formato probable
    let caracteresValidos = true;
    if (
      formatoProbable === "EAN8" ||
      formatoProbable === "UPC" ||
      formatoProbable === "EAN13"
    ) {
      caracteresValidos = /^[0-9]*$/.test(codigo);
    } else if (formatoProbable === "CODE39") {
      caracteresValidos = /^[0-9A-Z\-\.\ \$\/\+\%]*$/.test(codigo);
    } else if (formatoProbable === "CODE128") {
      caracteresValidos = /^[0-9A-Za-z\-\.\ \_\$\/\+\%]*$/.test(codigo);
    }

    if (!caracteresValidos) {
      mostrarErrorCodigoBarras(
        `Caracteres no permitidos para formato ${formatoProbable}`
      );
      return;
    }

    // Validar el código completo
    const validacion = validarCodigoBarras(codigo);

    if (validacion.valido) {
      limpiarErrorCodigoBarras();
      // Mostrar mensaje de formato detectado
      mostrarMensajeFormato(validacion.formato, "success");
    } else {
      // Mostrar progreso para formatos numéricos
      if (
        formatoProbable === "EAN8" ||
        formatoProbable === "UPC" ||
        formatoProbable === "EAN13"
      ) {
        mostrarMensajeFormato(
          `${formatoProbable}: ${codigo.length}/${limiteActual} dígitos`,
          "info"
        );
      } else {
        mostrarMensajeFormato(
          `${formatoProbable}: ${codigo.length}/${limiteActual} caracteres`,
          "info"
        );
      }
      limpiarErrorCodigoBarras();
    }
  });

  // // Función para mostrar mensajes de formato
  // function mostrarMensajeFormato(mensaje, tipo) {
  //     const input = $('#editarArticuloForm #codigo_barras');
  //     let feedbackDiv = input.siblings('.formato-feedback');

  //     if (feedbackDiv.length === 0) {
  //         input.after(`<div class="formato-feedback small mt-1"></div>`);
  //         feedbackDiv = input.siblings('.formato-feedback');
  //     }

  //     feedbackDiv.removeClass('text-success text-info text-warning')
  //               .addClass(`text-${tipo === 'success' ? 'success' : tipo === 'info' ? 'info' : 'warning'}`)
  //               .text(mensaje);
  // }

  // Función para limpiar errores del input
  function limpiarErrorCodigoBarras() {
    const input = $("#editarArticuloForm #codigo_barras");
    input.removeClass("is-invalid");
    input.siblings(".invalid-feedback").remove();
  }

  // // Event listener modificado para el botón "Mostrar Código de Barras"
  // $(document).on('click', '#generarCodigoBarras', function(e) {
  //     e.preventDefault();
  //     console.log('Botón mostrar código de barras clickeado');

  //     const codigo = $('#editarArticuloForm #codigo_barras').val().trim();

  //     if (codigo === '') {
  //         if (typeof alertToast === 'function') {
  //             alertToast("Primero ingrese un código de barras", "warning", 3000);
  //         } else {
  //             alert("Primero ingrese un código de barras");
  //         }
  //         $('#editarArticuloForm #codigo_barras').focus();
  //         return;
  //     }

  //     // Validar el código antes de generar la imagen
  //     const validacion = validarCodigoBarras(codigo);

  //     if (!validacion.valido) {
  //         mostrarErrorCodigoBarras('El código ingresado no tiene un formato válido o está incompleto.');
  //         $('#editarArticuloForm #codigo_barras').focus();
  //         return;
  //     }

  //     // Si es válido, mostrar la imagen del código de barras
  //     mostrarCodigoBarrasInteligente(validacion.codigo);

  //     if (typeof alertToast === 'function') {
  //         alertToast(`Código de barras mostrado en formato ${validacion.formato}`, "success", 3000);
  //     }
  // });

  // Función mejorada para mostrar código de barras SOLO cuando se presiona el botón
  function mostrarCodigoBarrasInteligente(codigo) {
    if (!codigo || codigo.trim() === "") {
      document.getElementById("codigoBarrasContainer").style.display = "none";
      return;
    }

    // Validar antes de mostrar
    const validacion = validarCodigoBarras(codigo);
    if (!validacion.valido) {
      console.error("Código de barras inválido:", codigo);
      return;
    }

    try {
      // MOSTRAR el contenedor
      document.getElementById("codigoBarrasContainer").style.display = "block";

      // Limpiar canvas anterior
      const canvas = document.getElementById("codigoBarras");
      if (canvas) {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      JsBarcode("#codigoBarras", validacion.codigo, {
        format: validacion.formato,
        width: validacion.formato === "CODE128" ? 1.5 : 2,
        height: 60,
        displayValue: true,
        fontSize: 12,
        textMargin: 5,
        background: "#ffffff",
        lineColor: "#000000",
      });

      document.getElementById(
        "codigoBarrasTexto"
      ).textContent = `${validacion.codigo} (${validacion.formato})`;
    } catch (error) {
      console.error("Error al generar código de barras:", error);
      document.getElementById("codigoBarrasTexto").textContent =
        "Error al generar código: " + validacion.codigo;

      if (typeof alertToast === "function") {
        alertToast(
          "Error al generar la imagen del código de barras",
          "error",
          3000
        );
      }
    }
  }

  // Función para limpiar el código de barras
  function limpiarCodigoBarra() {
    $("#editarArticuloForm #codigo_barras").val("");
    limpiarErrorCodigoBarras();
    $("#editarArticuloForm #codigo_barras")
      .siblings(".formato-feedback")
      .remove();
    $("#codigoBarrasContainer").hide(); // Ocultar el canvas
  }

  // Event listener para limpiar código de barras
  $(document).on("click", "#limpiarCodigoBarra", function (e) {
    e.preventDefault();
    limpiarCodigoBarra();
  });

  // Event listener para validar al perder el foco
  $("#editarArticuloForm #codigo_barras").on("blur", function () {
    const codigo = $(this).val().trim();

    if (codigo !== "") {
      const validacion = validarCodigoBarras(codigo);

      if (!validacion.valido) {
        mostrarErrorCodigoBarras("Debe completar un código de barras válido.");
      }
    }
  });

  // Mostrar u ocultar la fecha de caducidad según el valor seleccionado
  $("#maneja_caducidad").on("change", function () {
    if ($(this).val() == "1") {
      $("#fechaCaducidadDiva").show();
    } else {
      $("#fechaCaducidadDiva").hide();
      $("#fecha_caducidad").val("");
    }
  });

  // Mostrar u ocultar los campos de rendimiento según el valor seleccionado
  $("#maneja_rendimiento").on("change", function () {
    if ($(this).val() == "0") {
      $("#rendimientoEstimadoDiv").show();
      $("#rendimientoPacienteDiv").show();
      $("#rendimiento_estimado").attr("required", true);
      $("#rendimiento_paciente").attr("required", true);
    } else {
      $("#rendimientoEstimadoDiv").hide();
      $("#rendimientoPacienteDiv").hide();
      $("#rendimiento_estimado").val("");
      $("#rendimiento_paciente").val("");
      $("#rendimiento_estimado").removeAttr("required");
      $("#rendimiento_paciente").removeAttr("required");
      $("#rendimiento_estimado").removeClass("is-invalid");
      $("#rendimiento_paciente").removeClass("is-invalid");
    }
  });

  // Mostrar u ocultar los campos de inserto y procedimiento prueba según el valor seleccionado
  $("#maneja_inserto").on("change", function () {
    if ($(this).val() == "0") {
      $("#insertoDiv").show();
      $("#protocoloDiv").show();
    } else {
      $("#insertoDiv").hide();
      $("#protocoloDiv").hide();
      $("#insertoDiv").hide();
      $("#protocoloDiv").hide();
      $("#inserto").val("");
    }
  });
  // Ejecutar al cargar para el valor inicial
  $(document).ready(function () {
    $("#maneja_caducidad").trigger("change");
    $("#maneja_rendimiento").trigger("change");
    $("#maneja_inserto").trigger("change");
  });

  // Event listeners para los botones - usando delegación de eventos
  $(document).on("click", "#generarCodigoBarras", function (e) {
    e.preventDefault();
    console.log("Botón generar código de barras clickeado");

    // ESPECIFICAR EL FORMULARIO
    $("#editarArticuloForm #codigo_barras").val(fullCode);

    // Mostrar el código de barras visual
    mostrarCodigoBarrasInteligente(fullCode);
  });

  // Event listener para generar QR - VERSIÓN CORREGIDA CON MEJOR DEBUG
  $(document).on("click", "#generarQr", function (e) {
    e.preventDefault();
    console.log("Botón generar QR clickeado");

    // Obtener la clave del artículo
    const clave = $("#editarArticuloForm #clave_art").val();
    console.log("Clave obtenida:", clave);
    if (!clave) {
      if (typeof alertToast === "function") {
        alertToast("La clave del artículo es requerida", "warning", 3000);
      } else {
        alert("La clave del artículo es requerida");
      }
      return;
    }

    // Obtener el nombre comercial del artículo
    const nombre_comercial = $("#editarArticuloForm #nombre_comercial").val();
    console.log("Nombre comercial obtenido:", nombre_comercial);
    if (!nombre_comercial) {
      if (typeof alertToast === "function") {
        alertToast("El nombre del artículo es requerido", "warning", 3000);
      } else {
        alert("El nombre del artículo es requerido");
      }
      return;
    }

    const codigo_barras = $("#editarArticuloForm #codigo_barras").val();
    if (!codigo_barras) {
      if (typeof alertToast === "function") {
        alertToast(
          "Primero genere o ingrese un código de barras",
          "warning",
          3000
        );
      } else {
        alert("Primero genere o ingrese un código de barras");
      }
      return;
    }

    // Generar código QR con los datos del artículo - FILTRAR VALORES NULL
    const qrCampos = {
      clave: clave,
      nombre_comercial: nombre_comercial,
      codigo_barras: codigo_barras,
      id_marcas: $("#editarArticuloForm #id_marcas").val(),
      red_frio: $("#editarArticuloForm #red_frio").val(),
      tipo_articulo: $("#editarArticuloForm #tipo_articulo").val(),
      area_id: $("#editarArticuloForm #area_id").val(),
      maneja_caducidad: $("#editarArticuloForm #maneja_caducidad").val(),
      fecha_caducidad: $("#editarArticuloForm #fecha_caducidad").val(),
      unidad_venta: $("#editarArticuloForm #unidad_venta").val(),
      unidad_minima: $("#editarArticuloForm #unidad_minima").val(),
      contenido: $("#editarArticuloForm #contenido").val(),
      numero_lote: $("#editarArticuloForm #numero_lote").val(),
      fecha_lote: $("#editarArticuloForm #fecha_lote").val(),
      fecha_qr: new Date().toISOString().split("T")[0],
    };

    console.log("Datos del QR antes de filtrar:", qrCampos);

    // Filtrar valores null, undefined y vacíos más estrictamente
    const qrDataObj = {};
    for (const key in qrCampos) {
      const value = qrCampos[key];
      if (
        value !== null &&
        value !== undefined &&
        value !== "" &&
        value !== "null" &&
        value !== "undefined"
      ) {
        qrDataObj[key] = value;
      }
    }

    console.log("Datos del QR después de filtrar:", qrDataObj);

    const qrData = JSON.stringify(qrDataObj);
    console.log("JSON del QR:", qrData);
    console.log("Longitud del JSON:", qrData.length);

    // Verificar que el contenedor existe
    const qrContainer = document.getElementById("qrCodeContainers");
    console.log("Contenedor QR encontrado:", qrContainer);

    if (!qrContainer) {
      console.error("No se encontró el contenedor qrCodeContainers");
      alert("Error: No se encontró el contenedor del QR");
      return;
    }

    // Limpiar los contenedores
    $("#editarArticuloForm #qrCodeContainers").empty();
    $("#editarArticuloForm #qrClaveDisplays").empty();

    // Verificar que la librería QRCode esté disponible
    console.log("QRCode disponible:", typeof QRCode);

    if (typeof QRCode !== "undefined") {
      try {
        console.log("Generando QR...");

        // Crear el QR con manejo de errores
        const qr = new QRCode(qrContainer, {
          text: qrData,
          width: 150,
          height: 150,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        console.log("QR generado exitosamente");

        // Verificar que se generó el canvas/img
        setTimeout(function () {
          const qrContent = $("#qrCodeContainers").html();
          console.log(
            "Contenido del contenedor QR después de generar:",
            qrContent
          );

          if (qrContent.trim() !== "") {
            // Mostrar la clave debajo del QR
            $("#qrClaveDisplays").html(
              `Clave: ${clave}<br>Nombre Comercial: ${nombre_comercial}`
            );

            // Ocultar el placeholder
            $("#qrCodePreview small").hide();

            // Mostrar los botones de descargar
            $("#descargarQRIMG").removeClass("d-none").addClass("d-flex");
            $("#descargarQRpdf").removeClass("d-none").addClass("d-flex");
            $("#imprimirQRpdf").removeClass("d-none").addClass("d-flex");

            console.log("QR mostrado correctamente");
          } else {
            console.error(
              "El QR no se generó correctamente - contenedor vacío"
            );
            alert("Error: El QR no se generó correctamente");
          }
        }, 100);
      } catch (error) {
        console.error("Error al crear el QR:", error);
        alert("Error al crear el QR: " + error.message);
      }
    } else {
      console.error("Librería QRCode no cargada");
      if (typeof alertToast === "function") {
        alertToast("Error: Librería QRCode no cargada", "error", 3000);
      } else {
        alert("Error: Librería QRCode no cargada");
      }
    }
  });

  // Event listeners para los botones de descarga e impresión - CORREGIDOS
  $(document).on("click", "#editarArticuloForm #descargarQRIMG", function (e) {
    e.preventDefault();
    if (!$("#qrCodeContainers").html()) {
      if (typeof alertToast === "function") {
        alertToast("Primero genere un código QR", "warning", 3000);
      } else {
        alert("Primero genere un código QR");
      }
      return;
    }

    // Obtener datos - ESPECIFICAR EL FORMULARIO
    const qrCanvas = $("#qrCodeContainers canvas")[0];
    const clave = $("#editarArticuloForm #clave_art").val();
    const nombre_comercial = $("#editarArticuloForm #nombre_comercial").val();

    // Crear canvas combinado
    const combinedCanvas = document.createElement("canvas");
    const ctx = combinedCanvas.getContext("2d");

    // Definir altura extra para 2 líneas de texto
    const extraHeight = 50;
    combinedCanvas.width = qrCanvas.width;
    combinedCanvas.height = qrCanvas.height + extraHeight;

    // Dibujar el QR
    ctx.drawImage(qrCanvas, 0, 0);

    // Estilo del texto
    ctx.font = "16px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = "black";

    // Dibujar cada línea de texto debajo del QR
    const centerX = qrCanvas.width / 2;
    const startY = qrCanvas.height + 20;

    ctx.fillText(`Clave: ${clave}`, centerX, startY);
    ctx.fillText(`Nombre: ${nombre_comercial}`, centerX, startY + 20);

    // Descargar imagen
    const imgData = combinedCanvas.toDataURL("image/png");
    const link = document.createElement("a");
    link.download = `QR_${clave}.png`;
    link.href = imgData;
    link.click();
  });

  $(document).on("click", "#editarArticuloForm #descargarQRpdf", function (e) {
    e.preventDefault();
    if (!$("#qrCodeContainers").html()) {
      if (typeof alertToast === "function") {
        alertToast("Primero genere un código QR", "warning", 3000);
      } else {
        alert("Primero genere un código QR");
      }
      return;
    }

    const qrImage = $("#qrCodeContainers canvas")[0].toDataURL("image/png");
    // ESPECIFICAR EL FORMULARIO
    const clave = $("#editarArticuloForm #clave_art").val();
    const nombre_comercial = $("#editarArticuloForm #nombre_comercial").val();
    const fecha = new Date().toLocaleDateString();

    // Verificar que jsPDF esté disponible
    if (typeof window.jspdf === "undefined") {
      console.error("jsPDF no está cargado");
      if (typeof alertToast === "function") {
        alertToast("Error: jsPDF no está cargado", "error", 3000);
      } else {
        alert("Error: jsPDF no está cargado");
      }
      return;
    }

    // Crear PDF
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: "portrait",
      unit: "mm",
    });

    // Configuración de márgenes y tamaños
    const pageWidth = pdf.internal.pageSize.getWidth();
    const margin = 15;
    const qrWidth = 50;
    const qrX = (pageWidth - qrWidth) / 2;

    // Agregar título
    pdf.setFontSize(16);
    pdf.setTextColor(40);
    pdf.text(`Reporte QR - ${nombre_comercial}`, 105, 20, { align: "center" });

    // Agregar imagen del QR
    pdf.addImage(qrImage, "PNG", qrX, margin + 10, qrWidth, qrWidth);

    // Agregar información del artículo
    pdf.setFontSize(12);
    pdf.text(`Clave: ${clave}`, margin, margin + qrWidth + 25);
    pdf.text(`Nombre: ${nombre_comercial}`, margin, margin + qrWidth + 30);
    pdf.text(`Fecha: ${fecha}`, margin, margin + qrWidth + 35);

    // Línea decorativa
    pdf.setDrawColor(200);
    pdf.line(
      margin,
      margin + qrWidth + 40,
      pageWidth - margin,
      margin + qrWidth + 40
    );

    // Descargar PDF
    pdf.save(`QR_${clave}.pdf`);
  });

  $(document).on("click", "#imprimirQRpdf", function (e) {
    e.preventDefault();
    if (!$("#qrCodeContainers").html()) {
      if (typeof alertToast === "function") {
        alertToast("Primero genere un código QR", "warning", 3000);
      } else {
        alert("Primero genere un código QR");
      }
      return;
    }

    const qrImage = $("#qrCodeContainers canvas")[0].toDataURL("image/png");
    // ESPECIFICAR EL FORMULARIO
    const clave = $("#editarArticuloForm #clave_art").val();
    const nombre_comercial = $("#editarArticuloForm #nombre_comercial").val();
    const fecha = new Date().toLocaleDateString();

    const ventanaImpresion = window.open("", "_blank", "width=400,height=600");

    const htmlContent = `
        <html>
            <head>
                <title>LABORATORIO BIOMOLECULAR S.A DE C.V</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 20px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .qr-container {
                        margin: 20px 0;
                        text-align: center;
                    }
                    .qr-container img {
                        width: 150px;
                        height: 150px;
                    }
                    .info {
                        margin-top: 20px;
                        text-align: left;
                        width: 100%;
                        max-width: 300px;
                        border-top: 1px solid #eee;
                        padding-top: 10px;
                    }
                    .info p {
                        margin: 5px 0;
                    }
                    @media print {
                        body { margin: 0; padding: 10px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h3>Reporte QR - ${nombre_comercial}</h3>
                </div>
                
                <div class="qr-container">
                    <img src="${qrImage}" alt="Código QR">
                </div>
                
                <div class="info">
                    <p><strong>Clave:</strong> ${clave}</p>
                    <p><strong>Nombre:</strong> ${nombre_comercial}</p>
                    <p><strong>Fecha:</strong> ${fecha}</p>
                </div>
                
                <button class="no-print" onclick="window.print()" style="margin-top: 20px; padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Imprimir
                </button>
            </body>
        </html>
    `;

    ventanaImpresion.document.open();
    ventanaImpresion.document.write(htmlContent);
    ventanaImpresion.document.close();
  });

  // Agregar evento para mostrar código de barras cuando se escriba manualmente
  $("#codigo_barras").on("input blur", function () {
    const codigo = $(this).val();
    mostrarCodigoBarrasInteligente(codigo);
  });

  // Al resetear el formulario
  $("#editarArticuloModal").on("hidden.bs.modal", function () {
    $("#qrClaveDisplays").empty();
    $("#qrCodeContainers").empty();
    $("#qrCodePreview small").show();
    $("#descargarQRIMG").addClass("d-none").removeClass("d-flex");
    $("#descargarQRpdf").addClass("d-none").removeClass("d-flex");
    $("#imprimirQRpdf").addClass("d-none").removeClass("d-flex");
  });
</script>

<!-- Asegurar que las librerías estén incluidas -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
