<div class="modal fade modal-xl" id="registrarEntradaOrdenEstableModal" tabindex="-1" data-bs-backdrop="static"
    data-bs-focus="false" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleEntradaOrdenEstable"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header text-white" style="background-color: #004e59;">
                <div class="d-flex align-items-center">
                    <i class="bi bi-box-arrow-in-down me-2 fs-4"></i>
                    <h5 class="modal-title mb-0" id="modalTitleEntradaOrdenEstable">
                        Registrar Entrada por Orden de Compra
                    </h5>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body container-fluid">
                <form id="registrarEntradaOrdenEstableForm" name="registrarEntradaOrdenEstableForm">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="ordenCompraSelect" class="form-label fw-bold">
                                Seleccionar Orden de Compra <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <select class="form-select" id="ordenCompraSelect" name="id_orden_compra" required>
                                    <option value="" disabled selected>Seleccione una orden de compra...</option>
                                </select>
                                <button type="button" class="btn btn-outline-info" id="btnVerOrdenCompra"
                                    title="Ver detalles de la orden">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="cardArtOrdenCompra" class="row d-none">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-list-ul me-2"
                                            style="color: #004e59;"></i>Artículos de la Orden</h6>
                                </div>
                                <div class="card-body p-0 mt-2">
                                    <div class="table-responsive">
                                        <table class="table table-bordered align-middle mb-0"
                                            id="tableCatOrdenesCompraArticulos">
                                        </table>
                                    </div>
                                    <div class="alert alert-info mt-2 d-none" id="alertaSurtidoOrden">
                                        <i class="bi bi-info-circle me-2"></i>Puede surtir parcial o totalmente los
                                        artículos de la orden <span id="nombreOrdenCompra"></span>.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="infoOrdenCompra" class="row d-none">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0"><i class="bi bi-list-ul me-2"
                                            style="color: #004e59;"></i>Detalles de la Orden</h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="border rounded-3 p-3 bg-light">
                                        <div class="row g-3 align-items-center">
                                            <div class="col-md-6">
                                                <span class="fw-bold"><i class="bi bi-person me-1"
                                                        style="color:#004e59"></i>Creada por:</span>
                                                <span id="creadaPorOrdenCompra" class="ms-1"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <span class="fw-bold"><i class="bi bi-person-check me-1"
                                                        style="color:#004e59"></i>Aprobada/Rechazada por:</span>
                                                <span id="aprobadaRechazadaPorOrdenCompra" class="ms-1"></span>
                                            <!-- </div>
                                            <div class="col-md-6">
                                                <span class="fw-bold"><i class="bi bi-shop me-1"
                                                        style="color:#004e59"></i>Almacén Destino:</span>
                                                <span id="almacenOrdenCompra" class="ms-1"></span>
                                            </div> -->
                                            <div class="col-md-6">
                                                <span class="fw-bold"><i class="bi bi-calendar-event me-1"
                                                        style="color:#004e59"></i>Fecha de Orden:</span>
                                                <span id="fechaOrdenCompra" class="ms-1"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <span class="fw-bold"><i class="bi bi-flag me-1"
                                                        style="color:#004e59"></i>Estado:</span>
                                                <span id="estadoOrdenCompra" class="ms-1"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="fecha_entrada_orden" name="fecha_entrada">
                </form>
            </div>

            <div class="modal-footer border-0"
                style="background-color: #f8f9fa; border-top: 3px solid #004e59 !important;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancelar
                </button>
                <button id="registrarEntradaOrdenEstableButton" type="submit" class="btn d-none"
                    style="background-color: #004e59; color: white; border-color: #004e59;"
                    form="registrarEntradaOrdenEstableForm">
                    <i class="bi bi-pencil-square"></i> Registrar entrada
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('#ordenCompraSelect').on('change', function () {
            const idOrden = $(this).val();
            if (idOrden) {
                $.ajax({
                    url: "../../../api/inventarios_api.php",
                    type: "POST",
                    dataType: "json",
                    data: { api: 43, id_orden_compra: idOrden },
                    success: function (response) {
                        if (response.response && response.response.code == 1 && response.response.data) {
                            const orden = response.response.data[0];
                            console.log(orden);

                            $('#infoOrdenCompra').removeClass('d-none');
                            $('#cardArtOrdenCompra').removeClass('d-none');
                            $("#registrarEntradaOrdenEstableButton").removeClass('d-none');

                            $('#creadaPorOrdenCompra').text(orden.USUARIO_CREACION);
                            $('#aprobadaRechazadaPorOrdenCompra').text(orden.APROBADO_RECHAZADO_POR);
                            $('#almacenOrdenCompra').text(orden.ALMACEN);
                            $('#fechaOrdenCompra').text(orden.FECHA_ORDEN);
                            $('#estadoOrdenCompra').text(orden.ESTADO.charAt(0).toUpperCase() + orden.ESTADO.slice(1));
                            $("#nombreOrdenCompra").text(orden.NUMERO_ORDEN);
                        } else {
                            $('#infoOrdenCompra').addClass('d-none');
                            $('#cardArtOrdenCompra').addClass('d-none');
                            $("#registrarEntradaOrdenEstableButton").addClass('d-none');
                            $('#tableCatOrdenesCompraArticulos tbody').empty();
                            $('#alertaSurtidoOrden').addClass('d-none');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error al cargar detalles de la orden:", error);
                    }
                });

                dataTableCatOrdenesCompraArticulos.id_orden_compra = idOrden;
                $('#surtirOrdenCompraModal').val(idOrden);

                if (typeof tableCatOrdenesCompraArticulos !== "undefined") {
                    tableCatOrdenesCompraArticulos.ajax.reload();
                }

                $('#alertaSurtidoOrden').removeClass('d-none');
            } else {
                $('#infoOrdenCompra').addClass('d-none');
                $('#cardArtOrdenCompra').addClass('d-none');
                $("#registrarEntradaOrdenEstableButton").addClass('d-none');

                $('#tableCatOrdenesCompraArticulos tbody').empty();
                $('#alertaSurtidoOrden').addClass('d-none');

                dataTableCatOrdenesCompraArticulos.id_orden_compra = null;
                if (typeof tableCatOrdenesCompraArticulos !== "undefined") {
                    tableCatOrdenesCompraArticulos.ajax.reload();
                }
            }
        });

        // Al cerrar el modal, limpiar el formulario
        $('#registrarEntradaOrdenEstableModal').on('hidden.bs.modal', function () {
            $('#registrarEntradaOrdenEstableForm')[0].reset();
            $('#infoOrdenCompra').addClass('d-none');
            $('#cardArtOrdenCompra').addClass('d-none');
            $("#registrarEntradaOrdenEstableButton").addClass('d-none');
            $('#tableCatOrdenesCompraArticulos tbody').empty();
            $('#alertaSurtidoOrden').addClass('d-none');
        });

        // Al enviar el formulario, poner la fecha de entrada
        $('#registrarEntradaOrdenEstableForm').submit(function (event) {
            const now = new Date();
            $('#fecha_entrada_orden').val(
                now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, '0') + "-" +
                String(now.getDate()).padStart(2, '0') + " " +
                String(now.getHours()).padStart(2, '0') + ":" +
                String(now.getMinutes()).padStart(2, '0') + ":" +
                String(now.getSeconds()).padStart(2, '0')
            );
        });
    });
</script>