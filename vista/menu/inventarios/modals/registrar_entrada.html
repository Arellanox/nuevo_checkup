<div class="modal fade modal-lg" id="registrarEntradaModal" tabindex="-1" data-bs-backdrop="static" data-bs-focus="false" data-bs-keyboard="false" role="dialog" aria-labelledby="modalTitleId" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitleRegistrarEntrada">Registrando movimiento de <strong><span id="registrandoEntrada"></span></strong> con una cantidad en almacén de: <strong><span id="registrandoCantidad"></span></strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body container-fluid">
                <form id="registrarEntradaForm" name="registrarEntradaForm">
                    <!-- Card 1: Información Básica del Movimiento -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="card-title">Información del Movimiento</h6>
                            <div class="row">
                                <!-- Tipo de Movimiento -->
                                <div class="col-md-6 mb-3">
                                    <label for="id_movimiento" class="form-label">Tipo de movimiento</label>
                                    <select class="form-select" id="id_movimiento" name="id_movimiento" required>
                                        <option value="" disabled selected>Seleccione...</option>
                                        <option value="1">Entrada</option>
                                        <option value="2">Salida</option>
                                    </select>
                                </div>
                                
                                <!-- Cantidad -->
                                <div class="col-md-6 mb-3" id="cantidad-container" style="display:none;">
                                    <label for="cantidad" class="form-label" id="label-cantidad">Cantidad</label>
                                    <input type="number" class="form-control" id="cantidad" name="cantidad" required>
                                </div>
                            </div>
                            
                            <!-- Precio de Compra (solo visible para entradas) -->
                            <div class="row" id="precio-compra-container" style="display:none;">
                                <div class="col-md-12 mb-3">
                                    <label for="costo_ultima_entrada" class="form-label">Precio de compra</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" step="0.01" class="form-control" id="costo_ultima_entrada" name="costo_ultima_entrada">
                                    </div>
                                    <small id="costoTotal" class="form-text text-secondary fw-bold mt-2" style="display:none;">
                                        <i class="bi bi-calculator"></i> Costo total: $<span id="costoTotalValor">0.00</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: Detalles de Entrada (solo visible para entradas) -->
                    <div class="card mb-4" id="entrada-details-card" style="display:none;">
                        <div class="card-body">
                            <h6 class="card-title">Detalles de Entrada</h6>
                            <div class="row">
                                <!-- Proveedor -->
                                <div class="col-md-8 mb-3">
                                    <label for="id_proveedores" class="form-label">Proveedor</label>
                                    <select class="form-select" id="id_proveedores" name="id_proveedores">
                                        <option value="" disabled selected>Seleccione...</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-success w-100" id="btnNuevoProveedor" data-bs-toggle="modal" data-bs-target="#registrarCatalogoModal">
                                        <i class="bi bi-plus-lg"></i> Nuevo
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Factura -->
                            <div class="mb-3">
                                <label for="img_factura" class="form-label">Documento de compra</label>
                                <input type="file" class="form-control" id="img_factura" name="img_factura[]">
                                <small class="text-muted">Factura, remisión o comprobante</small>
                            </div>
                            
                            <!-- Lote y Caducidad -->
                            <div class="row" id="lotesCaducidadDiv">
                                <div class="col-md-6 mb-3">
                                    <label for="numero_lote" class="form-label">Número de Lote</label>
                                    <input type="text" class="form-control" id="numero_lote" name="numero_lote">
                                </div>
                                <div class="col-md-6 mb-3" id="fechaCaducidadDiv">
                                    <label for="fecha_caducidad" class="form-label">Fecha de Caducidad</label>
                                    <input type="date" class="form-control" id="fecha_caducidad" name="fecha_caducidad">
                                </div>
                                <input type="hidden" id="fecha_lote" name="fecha_lote" value="">
                            </div>
                        </div>
                    </div>

                    <!-- Card 3: Motivo del Movimiento -->
                    <div class="card mb-4" id="motivo-card">
                        <div class="card-body">
                            <h6 class="card-title">Motivo</h6>
                            <div class="row">
                                <div class="col-md-10 mb-3">
                                    <label for="motivo_salida" class="form-label" id="label-motivo">Motivo</label>
                                    <select class="form-select" id="motivo_salida" name="motivo_salida" required>
                                        <option value="" disabled selected>Seleccione...</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-success w-100" id="btnNuevoMotivo" data-bs-toggle="modal" data-bs-target="#registrarCatalogoModal">
                                        <i class="bi bi-plus-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 4: Documentación Adicional (Opcional) -->
                    <div class="card mb-4" id="doc-extra-card" style="display:none;">
                        <div class="card-body">
                            <h6 class="card-title">Documentación Adicional</h6>
                            <div class="mb-3">
                                <label for="orden_compra" class="form-label">Número de orden de compra</label>
                                <input type="text" class="form-control" id="orden_compra" name="orden_compra">
                            </div>
                            <div class="mb-3">
                                <label for="img_orden_compra" class="form-label">Documento de orden</label>
                                <input type="file" class="form-control" id="img_orden_compra" name="img_orden_compra[]">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campo oculto para la fecha y hora del movimiento -->
                    <input type="hidden" id="fecha_ultima_entrada" name="fecha_ultima_entrada">
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-cancelar" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left-short"></i> Cancelar
                </button>
                <button id="registrarMovimientoButton" type="submit" class="btn btn-confirmar" form="registrarEntradaForm" style="display:none;">
                    <i class="bi bi-pencil-square"></i> Registrar movimiento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Inicialización de elementos ocultos
        $("#precio-compra-container").hide();
        $("#cantidad-container").hide();
        $("#entrada-details-card").hide();
        $("#motivo-card").hide();
        $("#doc-extra-card").hide();
        $("#lotesCaducidadDiv").hide();
        $("#registrarMovimientoButton").hide();

        // Variable para controlar si se debe reabrir el modal de entrada
        let debeReabrirModalEntrada = false;

        // Función para calcular y mostrar el costo total
        function calcularCostoTotal() {
            const cantidad = parseFloat($("#cantidad").val()) || 0;
            const costoUnitario = parseFloat($("#costo_ultima_entrada").val()) || 0;

            if (cantidad > 0 && costoUnitario > 0) {
                const costoTotal = cantidad * costoUnitario;
                $("#costoTotalValor").text(costoTotal.toLocaleString('es-MX', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));
                $("#costoTotal").show();
            } else {
                $("#costoTotal").hide();
            }
        }

        // Control de visibilidad basado en tipo de movimiento
        $('#id_movimiento').change(function() {
            const isEntrada = $(this).val() === '1';
            const isSalida = $(this).val() === '2';
            
            // Mostrar elementos comunes
            $("#motivo-card").show();
            $("#registrarMovimientoButton").show();
            
            if (isEntrada) {
                // Configuración para ENTRADAS
                $("#label-cantidad").text('Cantidad a ingresar');
                $("#label-motivo").text('Motivo de entrada');
                $("#precio-compra-container").show();
                $("#cantidad-container").show();
                $("#entrada-details-card").show();
                $("#doc-extra-card").show();
                $("#lotesCaducidadDiv").show();
                
                // Configurar campos requeridos
                $("#costo_ultima_entrada").prop('required', true);
                $("#id_proveedores").prop('required', true);
                $("#img_factura").prop('required', true);
                
                // Configurar botón y título
                $("#registrarMovimientoButton").html('<i class="bi bi-pencil-square"></i> Registrar entrada');
                $("#modalTitleRegistrarEntrada").html(
                    "Registrando entrada de <strong><span id='registrandoEntrada'>" +
                    ($("#registrandoEntrada").text() || "") +
                    "</span></strong> con una cantidad en almacén de: <strong><span id='registrandoCantidad'>" +
                    ($("#registrandoCantidad").text() || "") +
                    "</span></strong>"
                );
                
                // Habilitar cálculo de costo
                $("#cantidad, #costo_ultima_entrada").on("input keyup change", calcularCostoTotal);
                calcularCostoTotal();
                
                // Cargar datos específicos
                cargarProveedoresEntrada();
                cargarMotivosPorTipo("entrada");
                consultarManejaCaducidadRegistrar(/* ID del artículo debería ir aquí */);
                
            } else if (isSalida) {
                // Configuración para SALIDAS
                $("#label-cantidad").text('Cantidad a retirar');
                $("#label-motivo").text('Motivo de salida');
                $("#precio-compra-container").hide();
                $("#cantidad-container").show();
                $("#entrada-details-card").hide();
                $("#doc-extra-card").hide();
                $("#lotesCaducidadDiv").hide();
                
                // Quitar requeridos
                $("#costo_ultima_entrada").prop('required', false);
                $("#id_proveedores").prop('required', false);
                $("#img_factura").prop('required', false);
                
                // Configurar botón y título
                $("#registrarMovimientoButton").html('<i class="bi bi-pencil-square"></i> Registrar salida');
                $("#modalTitleRegistrarEntrada").html(
                    "Registrando salida de <strong><span id='registrandoEntrada'>" +
                    ($("#registrandoEntrada").text() || "") +
                    "</span></strong> con una cantidad en almacén de: <strong><span id='registrandoCantidad'>" +
                    ($("#registrandoCantidad").text() || "") +
                    "</span></strong>"
                );
                
                // Deshabilitar cálculo de costo
                $("#cantidad, #costo_ultima_entrada").off("input keyup change", calcularCostoTotal);
                $("#costoTotal").hide();
                
                // Cargar datos específicos
                cargarMotivosPorTipo("salida");
            } else {
                // Ninguna opción seleccionada
                $("#precio-compra-container").hide();
                $("#cantidad-container").hide();
                $("#entrada-details-card").hide();
                $("#motivo-card").hide();
                $("#doc-extra-card").hide();
                $("#lotesCaducidadDiv").hide();
                $("#registrarMovimientoButton").hide();
                $("#costoTotal").hide();
            }
        });

        // FUNCIÓN para el botón de nuevo proveedor
        $("#btnNuevoProveedor").click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            debeReabrirModalEntrada = true;
            
            $("#registrarEntradaModal").modal("hide");
            setTimeout(function () {
                $("#registrarCatalogoModal").modal("show");
                setTimeout(function () {
                    $("#proveedores-tab").tab("show");
                    setTimeout(function () {
                        $("#registrarProveedorModal").modal("show");
                    }, 400);
                }, 300);
            }, 200);
        });

        // FUNCIÓN para el botón de nuevo motivo
        $("#btnNuevoMotivo").click(function (e) {
            e.preventDefault();
            e.stopPropagation();
            debeReabrirModalEntrada = true;
            
            $("#registrarEntradaModal").modal("hide");
            setTimeout(function () {
                $("#registrarCatalogoModal").modal("show");
                setTimeout(function () {
                    $("#motivos-tab").tab("show");
                    setTimeout(function () {
                        $("#registrarMotivoModal").modal("show");
                    }, 400);
                }, 300);
            }, 200);
        });

        // Evento cuando se cierra el modal de catálogo
        $("#registrarCatalogoModal").on("hidden.bs.modal", function () {
            if (debeReabrirModalEntrada) {
                setTimeout(function () {
                    $("#registrarEntradaModal").modal("show");
                    setTimeout(function () {
                        // Recargar datos si es necesario
                        if ($("#id_movimiento").val() == "1") {
                            cargarProveedoresEntrada();
                            cargarMotivosPorTipo("entrada");
                        } else if ($("#id_movimiento").val() == "2") {
                            cargarMotivosPorTipo("salida");
                        }
                    }, 300);
                }, 200);
                debeReabrirModalEntrada = false;
            }
        });

        // Resetear bandera si el usuario cancela manualmente
        $(".btn-cancelar, .btn-close").click(function () {
            debeReabrirModalEntrada = false;
        });

        // FUNCIÓN PARA CARGAR PROVEEDORES
        function cargarProveedoresEntrada() {
            cargarCatalogoEnModal("#id_proveedores", {
                api: 16,
                campoId: "id_proveedores",
                campoTexto: "nombre",
                placeholder: "Seleccione un proveedor"
            });
        }

        // FUNCIÓN PARA CARGAR MOTIVOS FILTRADOS POR TIPO
        function cargarMotivosPorTipo(tipoMovimiento) {
            $.ajax({
                url: "../../../api/inventarios_api.php",
                type: "POST",
                dataType: "json",
                data: {
                    api: 15,
                    tipo_movimiento: tipoMovimiento
                },
                success: function (response) {
                    if (response.response?.code == 1) {
                        let selectElement = $("#motivo_salida");
                        selectElement.empty().append(`<option value="">Seleccione un motivo de ${tipoMovimiento}</option>`);
                        
                        response.response.data.filter(item => 
                            item.tipo_movimiento === tipoMovimiento || item.tipo_movimiento === 'ambos'
                        ).forEach(item => {
                            selectElement.append(`<option value="${item.id_motivos}">${item.descripcion}</option>`);
                        });
                    } else {
                        console.error("Error al cargar motivos:", response);
                        alertToast("Error al cargar motivos", "error", 3000);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error AJAX:", error);
                    alertToast("Error de conexión al cargar motivos", "error", 3000);
                }
            });
        }

        // FUNCIÓN GENÉRICA PARA CARGAR CATÁLOGOS
        function cargarCatalogoEnModal(selectorSelect, opciones) {
            $.ajax({
                url: "../../../api/inventarios_api.php",
                type: "POST",
                dataType: "json",
                data: { api: opciones.api },
                success: function (response) {
                    if (response.response?.code == 1) {
                        let selectElement = $(selectorSelect);
                        let valorActual = selectElement.val();
                        
                        selectElement.empty().append(`<option value="">${opciones.placeholder}</option>`);
                        
                        response.response.data.forEach(item => {
                            selectElement.append(`<option value="${item[opciones.campoId]}">${item[opciones.campoTexto]}</option>`);
                        });
                        
                        if (valorActual) selectElement.val(valorActual);
                    } else {
                        console.error(`Error al cargar ${opciones.placeholder}:`, response);
                        alertToast(`Error al cargar ${opciones.placeholder}`, "error", 3000);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error AJAX:", error);
                    alertToast(`Error de conexión al cargar ${opciones.placeholder}`, "error", 3000);
                }
            });
        }

        // FUNCIÓN PARA CONSULTAR SI EL ARTÍCULO MANEJA CADUCIDAD
        function consultarManejaCaducidadRegistrar(idArticulo) {
            if (!idArticulo) return;
            
            $.ajax({
                url: "../../../api/inventarios_api.php",
                type: "POST",
                dataType: "json",
                data: {
                    api: 7,
                    id_articulo: idArticulo,
                    id_movimiento: 1
                },
                success: function (response) {
                    if (response.response?.code == 1 && response.response.data.length > 0) {
                        const manejaCaducidad = response.response.data[0].MANEJA_CADUCIDAD == 1;
                        $("#fechaCaducidadDiv").toggle(manejaCaducidad);
                        if (!manejaCaducidad) $("#fecha_caducidad").val('');
                    } else {
                        console.error("Error al obtener información del artículo:", response);
                        $("#fechaCaducidadDiv").show();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error AJAX al consultar artículo:", error);
                    $("#fechaCaducidadDiv").show();
                }
            });
        }

        // Evento submit del formulario
        $("#registrarEntradaForm").submit(function (event) {
            const now = new Date();
            $("#fecha_ultima_entrada").val(
                now.getFullYear() + "-" +
                String(now.getMonth() + 1).padStart(2, '0') + "-" +
                String(now.getDate()).padStart(2, '0') + " " +
                String(now.getHours()).padStart(2, '0') + ":" +
                String(now.getMinutes()).padStart(2, '0') + ":" +
                String(now.getSeconds()).padStart(2, '0')
            );
        });
    });
</script>