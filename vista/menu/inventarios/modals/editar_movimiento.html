<!-- Modal Editar Movimiento -->
<div
  class="modal fade"
  id="editarMovimientoModal"
  tabindex="-1"
  data-bs-backdrop="static"
  data-bs-focus="false"
  data-bs-keyboard="false"
  role="dialog"
  aria-labelledby="modalTitleId"
  aria-hidden="true"
>
  <div
    class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
    role="document"
  >
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editarMovimientoModal">
          Editando entrada con fecha:
          <span id="mostrandoDetallesEntrada"></span>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body container-fluid">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="text-start">
                <div class="shadow-sm rounded p-3 card-body">
                  <h5 class="text-dark">Edita los siguientes datos</h5>
                  <form id="editarMovimientoForm" name="editarMovimientoForm">
                    <!-- Campo oculto para la fecha y hora actual -->
                    <input
                      type="hidden"
                      id="fecha_ultima_entrada"
                      name="fecha_ultima_entrada"
                    />
                    <!-- Sección 1: Informacion general -->
                    <div class="card mb-4">
                      <div class="card-body">
                        <h6 class="card-title">Información general</h6>
                        <div class="row">
                          <!-- Cantidad -->
                          <div class="mb-3">
                            <label
                              id="cantidadEditarMovLabel"
                              for="cantidad"
                              class="form-label"
                              >Cantidad a ingresar</label
                            >
                            <input
                              type="number"
                              class="form-control input-form"
                              id="cantidad"
                              name="cantidad"
                              required
                              placeholder="Ej. 10"
                            />
                          </div>
                          <!-- Costo Última Entrada -->
                          <div class="mb-3" id="costoUltimaEntradaDiv">
                            <label for="costo_ultima_entrada" class="form-label"
                              >Costo actual</label
                            >
                            <input
                              type="number"
                              step="any"
                              class="form-control input-form"
                              id="costo_ultima_entrada"
                              name="costo_ultima_entrada"
                              required
                              placeholder="Ej. 10.50"
                            />
                          </div>
                          <!-- Proveedor -->
                          <div class="mb-3" id="proveedorDiv">
                            <label for="id_proveedores" class="form-label"
                              >Proveedor</label
                            >
                            <select
                              class="form-select input-form"
                              id="id_proveedores"
                              name="id_proveedores"
                              required
                            >
                              <option value="" disabled selected>
                                Seleccione...
                              </option>
                              <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                          </div>

                          <!-- Orden de compra -->
                          <div class="mb-3" id="ordenCompraDiva">
                            <div class="mb-3">
                                <label for="orden_compra" class="form-label">Orden de compra (opcional)</label>
                                <input type="text" class="form-control input-form" id="orden_compra"
                                    name="orden_compra" placeholder="Ej. 10">
                            </div>
                            <div class="mb-3">
                                <label for="orden_compra" class="form-label">Documento de orden de compra (opcional)</label>
                                <input type="file" class="form-control input-form" id="img_orden_compra"
                                name="img_orden_compra[]">
                                <div class="invalid-feedback">Este campo es opcional.</div>
                                <small class="form-text text-muted">Adjunte el documento de orden de compra.</small>
                            </div>
                        </div>

                          <!-- Motivo de salida -->
                          <div class="mb-3" id="motivoSalidaDiva">
                            <label id="motivo_salida_label" for="motivo_salida" class="form-label"
                              >Motivo de entrada</label
                            >
                            <select
                              class="form-select input-form"
                              id="motivo_salida"
                              name="motivo_salida"
                              required
                            >
                              <option value="">
                                Seleccione un motivo de entrada
                              </option>
                              <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                            <div class="invalid-feedback">
                              Este campo es obligatorio.
                            </div>
                            <small class="form-text text-muted"
                              >Seleccione el motivo de entrada del
                              artículo.</small
                            >
                          </div>

                          <!-- Factura o número de documento -->
                          <div class="col-12" id="facturaEditDiv">
                            <div class="mb-3">
                              <label for="img_factura" class="form-label">Cambiar factura o documento (opcional)</label>
                              <input type="file" class="form-control input-form" id="img_factura" name="img_factura[]">
                              <div class="invalid-feedback">Este campo es obligatorio.</div>
                              <small class="form-text text-muted">Adjunte una nueva imagen/PDF de la factura si desea cambiarla. Deje vacío para mantener el actual.</small>
                            </div>
                          </div>

                          <!-- Campos de lote y caducidad (solo para entradas) -->
                          <div id="lotesCaducidadEditDiv">
                            <div class="row">
                              <div class="col-6">
                                <div class="mb-3">
                                  <label for="numero_lote" class="form-label">Número de Lote</label>
                                  <input type="text" class="form-control input-form" id="numero_lote" name="numero_lote" placeholder="Ej. LOT123456">
                                  <small class="form-text text-muted">Ingrese el número de lote del producto.</small>
                                </div>
                              </div>
                              <!-- COMENTADO: Fecha de lote ya no es requerida
                              <div class="col-6">
                                <div class="mb-3">
                                  <label for="fecha_lote" class="form-label">Fecha de Lote</label>
                                  <input type="date" class="form-control input-form" id="fecha_lote" name="fecha_lote">
                                  <small class="form-text text-muted">Fecha de fabricación del lote.</small>
                                </div>
                              </div>
                              -->
                              <div class="col-6" id="fechaCaducidadEditDiv">
                                <div class="mb-3">
                                  <label for="fecha_caducidad" class="form-label">Fecha de Caducidad</label>
                                  <input type="date" class="form-control input-form" id="fecha_caducidad" name="fecha_caducidad">
                                  <small class="form-text text-muted">Fecha de vencimiento del producto.</small>
                                </div>
                              </div>
                              <!-- Campo oculto para fecha_lote - envía null -->
                              <input type="hidden" id="fecha_lote" name="fecha_lote" value="">
                            </div>
                          </div>
                          
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          id="cancelarButtonEditarMovimientos"
          type="button"
          class="btn btn-cancelar"
          data-bs-dismiss="modal"
        >
          <i class="bi bi-arrow-left-short"></i> Cancelar
        </button>
        <button
          type="submit"
          class="btn btn-confirmar"
          form="editarMovimientoForm"
        >
          <i class="bi bi-pencil-square"></i> Editar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  // Variables globales para almacenar los valores actuales
  var proveedorActual = null;
  var motivoActual = null;
  var cantidadActual = null;
  var costoActual = null;

  $(document).ready(function () {
    $("#cancelarButtonEditarMovimientos").on("click", function () {
      setTimeout(function () {
        $("#detalleEntradaModal").modal("show");
      }, 100);
    });

    // Cargar proveedores y motivos cuando se abre el modal
    $('#editarMovimientoModal').on('shown.bs.modal', function () {
      cargarProveedoresEditar();
      cargarMotivosEditar();
      consultarManejaCaducidadYCargarDatos();

      // Establecer valores en los campos de input después de un pequeño delay
      setTimeout(function() {
        if (cantidadActual) {
          $("#cantidad").val(cantidadActual);
        }
        if (costoActual) {
          $("#costo_ultima_entrada").val(costoActual);
        }
        // Los valores de lote y caducidad se cargan ahora via AJAX en consultarDatosMovimientoCompletos()
      }, 100);
    });

    // FUNCIÓN PARA CARGAR PROVEEDORES
    function cargarProveedoresEditar() {
      cargarCatalogoEnModalEditar("#editarMovimientoModal #id_proveedores", {
        api: 16,
        campoId: "id_proveedores",
        campoTexto: "nombre",
        placeholder: "Seleccione un proveedor",
        valorASeleccionar: proveedorActual
      });
    }

    // FUNCIÓN PARA CARGAR MOTIVOS
    function cargarMotivosEditar() {
      // Determinar el tipo de movimiento basado en dataTableCatEntradas.id_movimiento
      var tipoMovimiento = "entrada"; // Por defecto
      var textoPlaceholder = "Seleccione un motivo de entrada";
      var filtroTipo = "entrada";
      
      // Si existe la variable global y es tipo salida (2 o 5)
      if (window.dataTableCatEntradas && window.dataTableCatEntradas.id_movimiento) {
        var idMovimiento = window.dataTableCatEntradas.id_movimiento;
        if (idMovimiento == "2" || idMovimiento == "5") {
          tipoMovimiento = "salida";
          textoPlaceholder = "Seleccione un motivo de salida";
          filtroTipo = "salida";
        }
      }

      $.ajax({
        url: "../../../api/inventarios_api.php",
        type: "POST",
        dataType: "json",
        data: {
          api: 15,
          tipo_movimiento: tipoMovimiento // Ahora es dinámico
        },
        success: function (response) {
          if (response.response && response.response.code == 1) {
            let selectElement = $("#editarMovimientoModal #motivo_salida");
            
            selectElement.empty();
            selectElement.append(`<option value="">${textoPlaceholder}</option>`); // Dinámico

            let datosFiltrados = response.response.data.filter(function(item) {
              return item.tipo_movimiento === filtroTipo || item.tipo_movimiento === 'ambos'; // Dinámico
            });

            datosFiltrados.forEach(function (item) {
              // LÓGICA PARA SELECCIONAR AUTOMÁTICAMENTE
              const selected = motivoActual && item.descripcion === motivoActual ? 'selected' : '';
              
              selectElement.append(
                `<option value="${item.id_motivos}" ${selected}>${item.descripcion}</option>`
              );
            });

            console.log(`Motivos de ${tipoMovimiento} cargados en modal editar`);
            if (motivoActual) {
              console.log(`Motivo seleccionado automáticamente: ${motivoActual}`);
            }
          } else {
            console.log("Error al cargar motivos:", response);
            alertToast("Error al cargar motivos", "error", 3000);
          }
        },
        error: function (xhr, status, error) {
          console.log("Error AJAX:", error);
          alertToast("Error de conexión al cargar motivos", "error", 3000);
        }
      });
    }

    // FUNCIÓN GENÉRICA PARA CARGAR CATÁLOGOS
    function cargarCatalogoEnModalEditar(selectorSelect, opciones) {
      $.ajax({
        url: "../../../api/inventarios_api.php",
        type: "POST",
        dataType: "json",
        data: {
          api: opciones.api
        },
        success: function (response) {
          if (response.response && response.response.code == 1) {
            let selectElement = $(selectorSelect);

            selectElement.empty();
            selectElement.append(`<option value="">${opciones.placeholder}</option>`);

            response.response.data.forEach(function (item) {
              // LÓGICA PARA SELECCIONAR AUTOMÁTICAMENTE
              const selected = opciones.valorASeleccionar && 
                             item[opciones.campoTexto] === opciones.valorASeleccionar ? 'selected' : '';
              
              selectElement.append(
                `<option value="${item[opciones.campoId]}" ${selected}>${item[opciones.campoTexto]}</option>`
              );
            });

            console.log(`${opciones.placeholder} cargados en modal editar`);
            if (opciones.valorASeleccionar) {
              console.log(`Seleccionado automáticamente: ${opciones.valorASeleccionar}`);
            }
          } else {
            console.log(`Error al cargar ${opciones.placeholder}:`, response);
            alertToast(`Error al cargar ${opciones.placeholder}`, "error", 3000);
          }
        },
        error: function (xhr, status, error) {
          console.log("Error AJAX:", error);
          alertToast(`Error de conexión al cargar ${opciones.placeholder}`, "error", 3000);
        }
      });
    }

    $("#editarMovimientoForm").submit(function (event) {
      var now = new Date();
      var fechaHora =
        now.getFullYear() +
        "-" +
        String(now.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(now.getDate()).padStart(2, "0") +
        " " +
        String(now.getHours()).padStart(2, "0") +
        ":" +
        String(now.getMinutes()).padStart(2, "0") +
        ":" +
        String(now.getSeconds()).padStart(2, "0");
      $("#fecha_ultima_entrada").val(fechaHora);
    });
  });

  // FUNCIÓN PARA CONSULTAR SI EL ARTÍCULO MANEJA CADUCIDAD
  function consultarManejaCaducidadYCargarDatos() {
    if (window.dataTableCatEntradas && window.dataTableCatEntradas.id_articulo) {
      $.ajax({
        url: "../../../api/inventarios_api.php",
        type: "POST",
        dataType: "json",
        data: {
          api: 7, // API para obtener detalles del artículo
          id_articulo: window.dataTableCatEntradas.id_articulo,
          id_movimiento: 1 // Para obtener detalles de entrada
        },
        success: function (response) {
          if (response.response && response.response.code == 1 && response.response.data.length > 0) {
            var articulo = response.response.data[0];
            var manejaCaducidad = articulo.MANEJA_CADUCIDAD == 1 || articulo.MANEJA_CADUCIDAD == '1';
            
            // Mostrar campos de lote y caducidad para entradas
            $("#lotesCaducidadEditDiv").show();
            
            // Mostrar u ocultar fecha de caducidad según configuración
            if (manejaCaducidad) {
              $("#fechaCaducidadEditDiv").show();
            } else {
              $("#fechaCaducidadEditDiv").hide();
              $("#fecha_caducidad").val(''); // Limpiar valor
            }
            
            console.log("Artículo maneja caducidad:", manejaCaducidad);
          } else {
            console.log("Error al obtener información del artículo:", response);
            // En caso de error, mostrar todos los campos por defecto
            $("#lotesCaducidadEditDiv").show();
            $("#fechaCaducidadEditDiv").show();
          }
        },
        error: function (xhr, status, error) {
          console.log("Error AJAX al consultar artículo:", error);
          // En caso de error, mostrar todos los campos por defecto
          $("#lotesCaducidadEditDiv").show();
          $("#fechaCaducidadEditDiv").show();
        }
      });
    }
  }

  // FUNCIÓN PARA ESTABLECER LOS VALORES ACTUALES (llamar desde donde abres el modal)
  function establecerValoresActuales(datos) {
    proveedorActual = datos.proveedor || datos.PROVEEDOR || datos.nombre_proveedor;
    motivoActual = datos.motivo || datos.MOTIVO_SALIDA || datos.descripcion_motivo;
    cantidadActual = datos.cantidad || datos.CANTIDAD;
    costoActual = datos.costo_ultima_entrada || datos.COSTO_ULTIMA_ENTRADA || datos.costo;
    // Los datos de lote y caducidad se obtienen ahora via AJAX
  }
</script>
